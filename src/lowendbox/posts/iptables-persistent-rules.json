{"id": "4192", "post": "<div class=\"post-4192 post type-post status-publish format-standard hentry category-tutorials tag-iptables tag-tutorials-2\" id=\"post-4192\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/iptables-persistent-rules/\" rel=\"bookmark\">IPtables Persistent Rules</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/iptables/\" rel=\"tag\">iptables</a>, <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> August 13, 2013 @ 9:06 am, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center;\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" loading=\"lazy\" class=\"alignnone size-full wp-image-3957 litespeed-loaded\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" alt=\"lowendtutorial\" width=\"271\" height=\"70\" data-was-processed=\"true\"></p><p>Last week I\u2019ve shown you how to get started with <a href=\"https://lowendbox.com/blog/iptables-tutorial-delete-insert-rules/\">IPtables and create and delete rules</a>. This week I\u2019m going to show you how to save the rules you write. This will ensure the rules you apply are re-applied once you reboot or restart IPtables.</p><p><span id=\"more-4192\"></span></p><p>There are some rules which you may not want to persist. For example: if you temporarily block an IP address for guessing passwords, it\u2019s not necessary to keep the block forever. The IP address will probably be used by somebody else later and the attack will stop shortly after you block the IP address anyway.</p><p>There are multiple ways to save IPtables rules, I\u2019m going to show the most straight-forward ones for CentOS and Ubuntu.</p><h2>CentOS: Persistent IPtable Rules</h2><p>CentOS can automatically load the IPtables configuration from a config file in /etc. This file may or may not exist, depending on how you installed CentOS or which template you have used. Therefore I\u2019m going to assume an <em>empty</em> file.</p><p>Open up /etc/sysconfig/iptables, make sure it is empty and add the following lines to it:</p><blockquote><p>*filter<br>\n:INPUT ACCEPT [0:0]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [0:0]<br>\nCOMMIT</p></blockquote><p>I\u2019ll explain what these lines mean first, then we\u2019ll move on to adding a persistent rule.</p><blockquote><p>*filter</p></blockquote><p>This means we\u2019re talking about the filter table and not any of the other ones.</p><blockquote><p>:INPUT ACCEPT [0:0]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [0:0]</p></blockquote><p>Here we set the default policy for every chain. As you can see, it\u2019s ACCEPT. You can also change this to DROP, but I only advise you to do that after adding enough ACCEPT rules so your server remains available.</p><blockquote><p>[0:0]</p></blockquote><p>The two zeroes for each rule above are the packet and byte counts for the policy for that chain. Once your chain accepts a packet, it increases that number with 1 for the packet and the number of bytes of the packet. When you reboot or restart IPtables, these are now reset to 0. If you want to save the packet and byte counts, well, read on. I\u2019ll get to that later.</p><blockquote><p>COMMIT</p></blockquote><p>This is the last line in the file and always should be. This commits the configuration above and \u201cactives\u201d it.</p><p>Any rules you may want to add, should be added between the following lines:</p><blockquote><p>:OUTPUT ACCEPT [0:0]<br>\n-&gt; ADD YOUR RULES HERE<br>\nCOMMIT</p></blockquote><p>So, for example, if we wanted to drop all TCP traffic to port 8080, this is what the file would look like:</p><blockquote><p>*filter<br>\n:INPUT ACCEPT [0:0]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [0:0]<br>\n-A INPUT -p tcp \u2013destination-port 8080 -j DROP<br>\nCOMMIT</p></blockquote><p>As you can see, I added the following rule <em>without</em> prefixing it with the \u2018sudo iptables\u2019 commands like you do on the command line.</p><blockquote><p>sudo iptables -A INPUT -p tcp \u2013destination-port 8080 -j DROP</p></blockquote><p>If you now save the file and restart IPtables, the rule should still be there. So, try it out (unless you have something important on port 8080) and run \u2018iptables -L\u2019. You should see something like this:</p><blockquote><p>Chain INPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination<br>\nDROP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; \u2014&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:webcache</p><p>Chain FORWARD (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p><p>Chain OUTPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p></blockquote><p>As you can see, all TCP traffic going to port 8080 is dropped. IPtables translates known ports to their purpose and uses that as a label, which in this case is \u2018webcache\u2019:</p><blockquote><p>tcp dpt:webcache</p></blockquote><p>So, that\u2019s it! You can now persist IPtables rules!</p><h2>Ubuntu: Persistent IPtable Rules</h2><p>On Ubuntu, a package is required which will ensure similar behavior as on CentOS. Install the package \u2018iptables-persistent\u2019. Answer both questions with \u2018Yes\u2019 and don\u2019t be put off by the error message at the end.</p><blockquote><p>sudo apt-get install iptables-persistent</p></blockquote><p>The package skips an error-check which makes the installer return an error. The package is still installed, though. To fix the error and complete the installation without any errors, run the following commands:</p><blockquote><p>sudo sed \\<br>\n-i \u2018s/\\(modprobe -q ip6\\?table_filter\\)/\\1 || true/g\u2019 \\<br>\n/var/lib/dpkg/info/iptables-persistent.postinst; \\<br>\nsudo apt-get install iptables-persistent</p></blockquote><p>This will add the error check and install iptables-persistent again. You\u2019re now good to go.</p><p>With this package installed, IPtables rules are automatically loaded upon boot.</p><p>Open up /etc/iptables/rules.v4, make sure it is empty and add the following lines to it:</p><blockquote><p>*filter<br>\n:INPUT ACCEPT [0:0]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [0:0]<br>\nCOMMIT</p></blockquote><p>I\u2019ll explain what these lines mean first, then we\u2019ll move on to adding a persistent rule.</p><blockquote><p>*filter</p></blockquote><p>This means we\u2019re talking about the filter table and not any of the other ones.</p><blockquote><p>:INPUT ACCEPT [0:0]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [0:0]</p></blockquote><p>Here we set the default policy for every chain. As you can see, it\u2019s ACCEPT. You can also change this to DROP, but I only advise you to do that after adding enough ACCEPT rules so your server remains available.</p><blockquote><p>[0:0]</p></blockquote><p>The two zeroes for each rule above are the packet and byte counts for the policy for that chain. Once your chain accepts a packet, it increases that number with 1 for the packet and the number of bytes of the packet. When you reboot or restart IPtables, these are now reset to 0. If you want to save the packet and byte counts, well, read on. I\u2019ll get to that later.</p><blockquote><p>COMMIT</p></blockquote><p>This is the last line in the file and always should be. This commits the configuration above and \u201cactives\u201d it.</p><p>Any rules you may want to add, should be added between the following lines:</p><blockquote><p>:OUTPUT ACCEPT [0:0]<br>\n-&gt; ADD YOUR RULES HERE<br>\nCOMMIT</p></blockquote><p>So, for example, if we wanted to drop all TCP traffic to port 8080, this is what the file would look like:</p><blockquote><p>*filter<br>\n:INPUT ACCEPT [0:0]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [0:0]<br>\n-A INPUT -p tcp \u2013destination-port 8080 -j DROP<br>\nCOMMIT</p></blockquote><p>As you can see, I added the following rule <em>without</em> prefixing it with the \u2018sudo iptables\u2019 commands like you do on the command line.</p><blockquote><p>sudo iptables -A INPUT -p tcp \u2013destination-port 8080 -j DROP</p></blockquote><p>If you now save the file and restart IPtables, the rule should still be there. So, try it out (unless you have something important on port 8080) and run \u2018iptables -L\u2019. You should see something like this:</p><blockquote><p>Chain INPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination<br>\nDROP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; \u2014&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:http-alt</p><p>Chain FORWARD (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p><p>Chain OUTPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p></blockquote><p>As you can see, all TCP traffic going to port 8080 is dropped. IPtables translates known ports to their purpose and uses that as a label, which in this case is \u2018http-alt\u2019 (Ubuntu and CentOS differ on this):</p><blockquote><p>tcp dpt:http-alt</p></blockquote><p>So, that\u2019s it! You can now persist IPtables rules!</p><h2>How to saving existing IPtables rules</h2><p>What if you\u2019ve set up your IPtables on the CLI or maybe added some ad-hoc rules you\u2019d like to persist? Well, there\u2019s an option to save that with a single command. This command also saves the packet and byte count and may include the chains of other tables, but it could potentially save you time.</p><p>Let\u2019s give this a try and add the following rule:</p><blockquote><p>sudo iptables -A INPUT -p tcp \u2013destination-port 9090 -j DROP</p></blockquote><p>Now, let\u2019s persist this rule.</p><h3>CentOS</h3><p>On CentOS, run:</p><blockquote><p>sudo /etc/init.d/iptables save</p></blockquote><p>This should output something like this:</p><blockquote><p>[mpkossen@host ~]$ sudo /etc/init.d/iptables save<br>\niptables: Saving firewall rules to /etc/sysconfig/iptables:[&nbsp; OK&nbsp; ]<br>\n[mpkossen@host ~]$</p></blockquote><p>That\u2019s it! IPtables saved! Including the rule we\u2019ve just added. Check it out in /etc/sysconfig/iptables.</p><h3>Ubuntu</h3><p>On Ubuntu, the persistent-iptables package takes care of saving.</p><p>Run:</p><blockquote><p>sudo /etc/init.d/iptables-persistent save</p></blockquote><p>Which should output the following:</p><blockquote><p>mpkossen@host:~$ sudo /etc/init.d/iptables-persistent save<br>\n* Saving rules\u2026<br>\n*&nbsp; IPv4\u2026<br>\n*&nbsp; IPv6\u2026 [OK]<br>\nmpkossen@host:~$</p></blockquote><p>If you now open up /etc/iptables/rules.v4, you should see the following content:</p><blockquote><p># Generated by iptables-save v1.4.12 on Tue Aug 13 00:23:49 2013<br>\n*nat<br>\n:PREROUTING ACCEPT [5509:341010]<br>\n:POSTROUTING ACCEPT [3807:261429]<br>\n:OUTPUT ACCEPT [3807:261429]<br>\nCOMMIT<br>\n# Completed on Tue Aug 13 00:23:49 2013<br>\n# Generated by iptables-save v1.4.12 on Tue Aug 13 00:23:49 2013<br>\n*mangle<br>\n:PREROUTING ACCEPT [147327:16511117]<br>\n:INPUT ACCEPT [147327:16511117]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [151091:20832369]<br>\n:POSTROUTING ACCEPT [151091:20832369]<br>\nCOMMIT<br>\n# Completed on Tue Aug 13 00:23:49 2013<br>\n# Generated by iptables-save v1.4.12 on Tue Aug 13 00:23:49 2013<br>\n*filter<br>\n:INPUT ACCEPT [1:44]<br>\n:FORWARD ACCEPT [0:0]<br>\n:OUTPUT ACCEPT [1:40]<br>\n-A INPUT -p tcp -m tcp \u2013dport 8080 -j DROP<br>\n-A INPUT -p tcp -m tcp \u2013dport 9090 -j DROP<br>\nCOMMIT<br>\n# Completed on Tue Aug 13 00:23:49 2013</p></blockquote><p>It isn\u2019t more complicated than that!</p><h2>Final notes on persistent rules for IPtables</h2><p>As a final note, I would like to explain the rule(s) we\u2019ve added:</p><blockquote><p>sudo iptables -A INPUT -p tcp -m tcp \u2013dport 9090 -j DROP</p></blockquote><p>We\u2019re blocking a specific port for a specific protocol here. The protocol (-p) flag is required in order to block a port, in this case we\u2019ve chosen \u2018tcp\u2019, but \u2018udp\u2019 or \u2018all\u2019 are examples of other options. With -m (match extensions) the extension is loaded that enables port blocking. In this case, it\u2019s the TCP extension. There\u2019s a lot of others as well. We\u2019ve blocked traffic to a _destination_ port (\u2013dport), which is the port where the traffic is headed. We can also block traffic originating from certain source ports (\u2013sport).</p><p>That\u2019s it for this week! Enjoy IPtables!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fiptables-persistent-rules%2F&amp;t=IPtables%20Persistent%20Rules\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=IPtables%20Persistent%20Rules&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fiptables-persistent-rules%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fiptables-persistent-rules%2F&amp;title=IPtables%20Persistent%20Rules&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/centos-6-end-of-life-is-coming-upgrade-to-a-new-centos-7-vps-now/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/centos-6-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/best-web-hosting-control-panels-after-the-cpanel-price-hike/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Best Web Hosting Control Panels after the cPanel Price Hike\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Best Web Hosting Control Panels after the cPanel Price Hike</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-plex-media-server-on-your-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Set Up Plex Media Server on Your Cheap VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/how-to-set-up-plex-media-server-on-vps-2-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Set Up Plex Media Server on Your Cheap VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-create-a-dns-server-on-debian-stretch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Create a DNS Server On Debian Stretch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Create a DNS Server On Debian Stretch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}