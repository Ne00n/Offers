{"id": "28421", "post": "<div class=\"post-28421 post type-post status-publish format-standard hentry category-tutorials tag-audit tag-linux tag-q tag-security tag-tutorial\" id=\"post-28421\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/how-to-audit-every-command-run-on-your-linux-system/\" rel=\"bookmark\">How to Audit Every Command Run on Your Linux System</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" width=\"16\" height=\"16\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/audit/\" rel=\"tag\">audit</a>, <a href=\"https://lowendbox.com/tag/linux/\" rel=\"tag\">linux</a>, <a href=\"https://lowendbox.com/tag/q/\" rel=\"tag\">q</a>, <a href=\"https://lowendbox.com/tag/security/\" rel=\"tag\">Security</a>, <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" width=\"16\" height=\"16\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> October 7, 2021 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2021/10/auditctl-300x300.png\" loading=\"lazy\" class=\"alignright size-medium wp-image-28422 litespeed-loaded\" data-src=\"https://lowendbox.com/wp-content/uploads/2021/10/auditctl-300x300.png\" alt=\"audit\" width=\"300\" height=\"300\" align=\"right\" hspace=\"20\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2021/10/auditctl.png 300w, https://lowendbox.com/wp-content/uploads/2021/10/auditctl-150x150.png 150w\" data-sizes=\"(max-width: 300px) 100vw, 300px\" sizes=\"(max-width: 300px) 100vw, 300px\" srcset=\"https://lowendbox.com/wp-content/uploads/2021/10/auditctl.png 300w, https://lowendbox.com/wp-content/uploads/2021/10/auditctl-150x150.png 150w\" data-was-processed=\"true\">Periodically I\u2019ve had auditors come to me and say \u201ccan you tell me what this user on this system did between such-and-such dates/times\u201d and my answer is usually no. By default, Linux systems don\u2019t log this info. But they can.</p><p>In this tutorial, I\u2019ll show you how to use auditd, which is a daemon you can enable to capture every command entered.</p><p>There is one big disclaimer: a user with root can always hide his tracks. There are a couple techniques you can use to minimize this, such as using chattr (or *BSD\u2019s securelevel) to set logs to append-only and echoing your logs to a different server. But in general, root access allows a cunning attacker to hide his tracks.</p><p>To setup auditing, you\u2019ll need the auditd package. On Debian, to install this package, type</p><pre>apt-get install auditd</pre><p>Next, turn on auditing. There are many ways to filter what you want to audit but we\u2019ll keep it simple here and audit all commands:</p><pre># auditctl -a exit,always -F arch=b32 -S execve -k allcmds\n# auditctl -a exit,always -F arch=b64 -S execve -k allcmds</pre><p>These commands only differ in the arch= specification \u2013 one for 32-bit syscalls and one for 64-bit.</p><p><span id=\"more-28421\"></span>Now you can use ausearch (audit search) to see what commands have been issued.</p><pre>ausearch -k allcmds</pre><p>For example, immediately after the two auditctl commands, I did a \u201cps -ef\u201d. Here is what the audit record looks like:</p><pre>time-&gt;Tue Oct 5 15:33:34 2021\ntype=PROCTITLE msg=audit(1633473214.211:33): proctitle=7073002D6566\ntype=PATH msg=audit(1633473214.211:33): item=1 name=\"/lib64/ld-linux-x86-64.so.2\" inode=1441854 dev=09:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 nametype=NORMAL\ntype=PATH msg=audit(1633473214.211:33): item=0 name=\"/bin/ps\" inode=11010174 dev=09:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 nametype=NORMAL\ntype=CWD msg=audit(1633473214.211:33): cwd=\"/root\"\ntype=EXECVE msg=audit(1633473214.211:33): argc=2 a0=\"ps\" a1=\"-ef\"\ntype=SYSCALL msg=audit(1633473214.211:33): arch=c000003e syscall=59 success=yes exit=0 a0=edf6e8 a1=eca708 a2=fb7008 a3=59a items=2 ppid=17403 pid=18676 auid=1015 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts0 ses=2532 comm=\"ps\" exe=\"/bin/ps\" key=\"allcmds\"\n----</pre><p>You can see that the command entered was /bin/ps with the argument -ef. Interestingly, when I typed that ausearch command, the next command in the audit dump was a record for the ausearch command itself. An audit record was created before the ausearch command itself was run.</p><p>If you want to audit only a specific user, there are two approaches. You could audit all users and then search for only that user, like this:</p><pre>ausearch -ue &lt;user's uid&gt;</pre><p>Or you could setup an auditctl entry for just that user:</p><pre>auditctl -a exit,always -F arch=b64 -F euid=X -S execve -k root-cmds\nauditctl -a exit,always -F arch=b32 -F euid=X -S execve -k root-cmds</pre><p>(where X is the uid)</p><p>To setup auditing permanently, edit /etc/audit/rules.d/audit.rules and add your rules in the same format as auditctl.</p><pre>-a exit,always -F arch=b32 -S execve -k allcmds\n-a exit,always -F arch=b64 -S execve -k allcmds</pre><p>If you want to list active rules, use auditctl -l:</p><pre># auditctl -l\n-a always,exit -F arch=b32 -S execve -F key=allcmds\n-a always,exit -F arch=b64 -S execve -F key=allcmds</pre><p>Restarting auditd will erase any rules that are active, though the /etc/audit/rules will be processed on startup. If you wanted to delete all rules immediately, you could type</p><pre>auditctl -D</pre><p>There are a ton of filtering options, both for what to capture and what to search for. Consult the auditctl(8) and ausearch(8) man pages.</p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/the-syniverse-hack-why-using-sms-for-2fa-is-a-bad-idea/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Syniverse\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/10/syniverse-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">The Syniverse Hack: Why Using SMS for 2FA is a Bad Idea</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/cloudlinux-announces-support-for-centos-8-through-2025/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/12/centos-logo-300-150x150.png.webp) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CloudLinux Announces Support for CentOS 8 Through 2025</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/udemy-has-free-courses-on-python-linux-sql-machine-learning-and-more/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Udemy\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/09/udemy-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Udemy Has Free Courses on Python, Linux, SQL, Machine Learning, and More!</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/painless-mariadb-replication-with-galera-clusters/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Galera\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/09/galera_logo-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Painless MariaDB Replication with Galera Clusters</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}