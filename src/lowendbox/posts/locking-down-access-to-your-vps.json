{"id": "23983", "post": "<div class=\"post-23983 post type-post status-publish format-standard hentry category-tutorials tag-firewall tag-linux tag-security tag-ssh\" id=\"post-23983\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/locking-down-access-to-your-vps/\" rel=\"bookmark\">Locking Down Access to Your VPS</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" width=\"16\" height=\"16\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/firewall/\" rel=\"tag\">Firewall</a>, <a href=\"https://lowendbox.com/tag/linux/\" rel=\"tag\">linux</a>, <a href=\"https://lowendbox.com/tag/security/\" rel=\"tag\">Security</a>, <a href=\"https://lowendbox.com/tag/ssh/\" rel=\"tag\">ssh</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" width=\"16\" height=\"16\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> October 12, 2021 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2020/06/locked_down_door.png\" loading=\"lazy\" class=\"alignright size-full wp-image-28448 litespeed-loaded\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/06/locked_down_door.png\" alt=\"Locked Door\" width=\"300\" height=\"300\" align=\"right\" hspace=\"20\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/06/locked_down_door.png 300w, https://lowendbox.com/wp-content/uploads/2020/06/locked_down_door-150x150.png 150w\" data-sizes=\"(max-width: 300px) 100vw, 300px\" sizes=\"(max-width: 300px) 100vw, 300px\" srcset=\"https://lowendbox.com/wp-content/uploads/2020/06/locked_down_door.png 300w, https://lowendbox.com/wp-content/uploads/2020/06/locked_down_door-150x150.png 150w\" data-was-processed=\"true\">There are a number of ways you can restrict access to your VPS. Passwords (specifically, good passwords) is the most basic method. Restricting access to ssh keys only is better. You can use Google Authenticator to require a short-lived number as a second factor of authentication. You could also setup a VPN so that only connections from that network are allowed.</p><p>One alternative method I\u2019ve sometimes used is to allow connections only from a specific IP or set of IPs. There are a couple different ways to achieve this.</p><h1>Restricting in sshd_config</h1><p>In the sshd_config file, you can add rules to match users and match addresses. Consider the following directives</p><pre>PermitRootLogin no\nPermitEmptyPasswords no\nPasswordAuthentication no\nPubkeyAuthentication no\nMatch Address 1.2.3.4/32\nPermitRootLogin prohibit-password\nPubkeyAuthentication yes</pre><p>The first four lines turn off all forms of authentication and restrict root logins. Then from the IP address 1.2.3.4, we permit root login (by SSH key only) and allow sshd key authentication for other users. This combination of \u201cdefault deny, then permit from a specific IP\u201d effectively limits connections from one IP.</p><p>sshd_config supports a number of \u201cMatch\u201d rules, including \u201cMatch User\u201d and \u201cMatch Host\u201d. Most of the major configuration options can be overridden using Match directives. Consult the sshd_config man page for full details.</p><h1>Restricting via Firewall</h1><p>If you are connecting to things besides ssh, you can restrict the entire box\u2019s access to an IP via a firewall. One wrinkle is if you want to limit access to your home IP, but you have a DHCP\u2019d IP from your ISP.</p><p>One way around this is to sign up with a Dynamic DNS provider. For example, you can sign up with afraid.org and they will grant you (for free) a DNS name in one of their domains you pick. So if you pick example.com (not a real afraid.org domain, just an example), you then choose what subdomain you have. In this tutorial, we\u2019ll assume I\u2019ve chosen lowend.example.com.</p><p>If your router (Netgear, etc.) has a Dynamic DNS client for afraid.org, just configure it in the router\u2019s panel and you\u2019re done. If not, you can use this little script to update afraid.org:</p><pre>#!/bin/bash \n#FreeDNS updater script\n\nUPDATEURL=\"http://freedns.afraid.org/dynamic/update.php?YOUR-AFRAID-ORG-KEY-HERE\"\nDOMAIN=\"lowend.example.com\"\n\nregistered=$(nslookup $DOMAIN|tail -n2|grep A|sed s/[^0-9.]//g)\ncurrent=$(wget -q -O - http://checkip.dyndns.org|sed s/[^0-9.]//g)\nif [ \"$current\" != \"$registered\" ] ; then\n  wget -q -O /dev/null $UPDATEURL \n  MSG=\"FYI, DNS updated for ${DOMAIN}, now $current\"\n  echo \"${MSG}\" | mailx -s \"${MSG}\" someone@example.com\nfi</pre><p>Put that in any user\u2019s crontab on a home Linux box to run (perhaps every 12 hours, or more frequently if you need constant access). Every time it runs, it checks what the IP address is at afraid.org, then checks what the Internet IP is for your home. If they\u2019re different, it updates afraid.org.</p><p>Now, on the server you want to lock down, all you need is a script to query afraid.org and update your iptables rules. Here is an example:</p><pre>#!/bin/bash\n\n# fix the PATH since we run from cron\nPATH=/usr/bin:/sbin:/bin:usr/sbin:/usr/local/bin\nexport PATH\n\n# CONFIG\n\nssh_port=5555\ndns=\"lowend.example.com\"\nLOG=\"/root/iptables_update.log\"\n\n# MAIN\n\nnslookup $dns &gt; /tmp/nslookup.out 2&gt;&amp;1\nhome_ip=$(grep Address: /tmp/nslookup.out | tail -1 | awk -F: '{ print $2 }' | sed 's/ //')\n\necho \"----------------------------------------------------------\" &gt; ${LOG}\necho \"`date` updating iptables using home IP ${home_ip}\" &gt;&gt; ${LOG}\n\n# make sure we can stay connected\niptables -P INPUT ACCEPT &gt;&gt; $LOG 2&gt;&amp;1\n\n# flush existing rules\niptables -F &gt;&gt; $LOG 2&gt;&amp;1\n\n# anything on loopback is OK\niptables -A INPUT -i lo -j ACCEPT &gt;&gt; $LOG 2&gt;&amp;1\n\n# anything for established/related connections is OK\niptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT &gt;&gt; $LOG 2&gt;&amp;1\n\n# open SSH\niptables -A INPUT -s ${home_ip} -p tcp --dport ${ssh_port} -j ACCEPT &gt;&gt; $LOG 2&gt;&amp;1\n\n# open web\niptables -A INPUT -s ${home_ip} -p tcp --dport 80 -j ACCEPT &gt;&gt; $LOG 2&gt;&amp;1\niptables -A INPUT -s ${home_ip} -p tcp --dport 443 -j ACCEPT &gt;&gt; $LOG 2&gt;&amp;1\n\n# otherwise drop\niptables -P INPUT DROP &gt;&gt; $LOG 2&gt;&amp;1\n\n# drop all forwards - we're not a router\niptables -P FORWARD DROP &gt;&gt; $LOG 2&gt;&amp;1\n\n# anything outgoing is OK\niptables -P OUTPUT ACCEPT &gt;&gt; $LOG 2&gt;&amp;1\n\n# list at end\niptables -L -v &gt;&gt; $LOG 2&gt;&amp;1</pre><p>What this script does is:</p><p><span id=\"more-23983\"></span></p><ul><li>looks the current address of your afraid.org dynamic DNS</li><li>flushes all iptables rules</li><li>allows everything on loopback, and anything established</li><li>opens ssh, and web (ports 80 and 443) to the dynamic DNS IP only</li><li>drops everything else and disable routing</li><li>logs all actions to /root/iptables_update.log.</li></ul><p>If you put this in cron to run at the same time as your dynamic dns updater script (perhaps offset by a couple minutes), your server will always have your home IP address in its iptables rules.</p><p>Of course, if you don\u2019t use dynamic DNS, you can just hardwire an IP for the home_ip variable.</p><p>As a bit of bonus advice, whenever I\u2019m developing an iptables ruleset, I usually create a script like this called \u201cflush_iptables.sh\u201d and have it called out of cron every couple minutes.</p><pre>#!/bin/bash\n\nPATH=/usr/bin:/sbin:/bin:usr/sbin:/usr/local/bin\nexport PATH\n\niptables -P INPUT ACCEPT \niptables -F \necho \"warning! firewall disabled on $(hostname)\" |mailx -s \"firewall disabled on $(hostname)!\" someone@example.com</pre><p>Update your email address, and make sure you have mailx installed (it\u2019s in the mailutils package on Debian).</p><p>This way, if I screw something and am locked out, the lockout will reverse itself after a couple minutes and I don\u2019t have to go through the hassle of finding the provider\u2019s console. It also emails me (every couple minutes) to warn me that it\u2019s in place so I don\u2019t forget to disable it once my rules are set.</p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-audit-every-command-run-on-your-linux-system/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"audit\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/10/auditctl-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Audit Every Command Run on Your Linux System</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/the-syniverse-hack-why-using-sms-for-2fa-is-a-bad-idea/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Syniverse\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/10/syniverse-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">The Syniverse Hack: Why Using SMS for 2FA is a Bad Idea</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/cloudlinux-announces-support-for-centos-8-through-2025/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/12/centos-logo-300-150x150.png.webp) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CloudLinux Announces Support for CentOS 8 Through 2025</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/udemy-has-free-courses-on-python-linux-sql-machine-learning-and-more/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Udemy\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/09/udemy-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Udemy Has Free Courses on Python, Linux, SQL, Machine Learning, and More!</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}