{"id": "23006", "post": "<div class=\"post-23006 post type-post status-publish format-standard hentry category-tutorials tag-high-availability tag-highly-available tag-setup-wordpress tag-tutorial tag-wordpress tag-wordpress-setup\" id=\"post-23006\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-5/\" rel=\"bookmark\">How to Setup a Highly Available WordPress Site From Scratch, Part 5</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/high-availability/\" rel=\"tag\">high availability</a>, <a href=\"https://lowendbox.com/tag/highly-available/\" rel=\"tag\">highly available</a>, <a href=\"https://lowendbox.com/tag/setup-wordpress/\" rel=\"tag\">setup wordpress</a>, <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a>, <a href=\"https://lowendbox.com/tag/wordpress/\" rel=\"tag\">wordpress</a>, <a href=\"https://lowendbox.com/tag/wordpress-setup/\" rel=\"tag\">wordpress setup</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> January 6, 2021 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p><a target=\"_blank\" rel=\"noopener noreferrer\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2020/05/highly-available-wordpress-part5.jpg.webp\" loading=\"lazy\" class=\"screenshot litespeed-loaded\" title=\"How to Setup a Highly Available WordPress Site From Scratch, Part 5\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/05/highly-available-wordpress-part5.jpg.webp\" alt=\"How to Setup a Highly Available WordPress Site From Scratch, Part 5\" width=\"410\" height=\"239\" data-was-processed=\"true\"></a>In this tutorial series, we are setting up a highly available WordPress web site from scratch.</p><p><a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-1/\">Part 1 \u2013 Introduction, Considerations, and Architecture</a><br>\n<a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-2/\">Part 2 \u2013 Setting Up the VPSes</a><br>\n<a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-from-scratch-part-3/\">Part 3 \u2013 Setting Up MariaDB Multi-Master Replication</a><br>\n<a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-from-scratch-part-4/\">Part 4 \u2013 File Replication and Setting Up DRBD</a><br>\nPart 5 \u2013 Setting Up OCFS2<br>\nPart 6 \u2013 Round-Robin DNS, Let\u2019s Encrypt, &amp; Conclusion</p><h1 class=\"p1\"><span class=\"s1\">Setting Up OCFS2</span></h1><p class=\"p1\"><span class=\"s1\">OCFS2 (Oracle Cluster Filesystem 2) is simple to setup. Despite its proprietary-sounding name, it\u2019s licensed under the Gnu GPL and can be installed via your normal package manager.</span></p><p class=\"p1\"><span class=\"s1\">Place the following in /etc/ocfs/cluster.conf on both nodes:</span></p><pre class=\"p1\"><span class=\"s1\">node:</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>ip_port = 7777</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>ip_address = 1.1.1.1</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>number = 0</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>name = web1.lowend.party</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>cluster = ocfs2</span>\n<span class=\"s1\">node:</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>ip_port = 7777</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>ip_address = 2.2.2.2</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>number = 1</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>name = web2.lowend.party</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>cluster = ocfs2</span>\n<span class=\"s1\">cluster:</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>node_count = 2</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>name = ocfs2</span></pre><p><span id=\"more-23006\"></span></p><p class=\"p1\"><span class=\"s1\">You can name your cluster (the \u201cname =\u201d directive) anything you want.</span></p><p class=\"p1\"><span class=\"s1\">We want the cluster to start at boot-time, which is controlled by /etc/default/o2cb.<span class=\"Apple-converted-space\">&nbsp; </span>We could probably just change O2CB_ENABLED to \u201ctrue\u201d in that file, but it has this comment:</span></p><pre class=\"p1\"><span class=\"s1\"># This is a configuration file for automatic startup of the O2CB</span>\n<span class=\"s1\"># driver.<span class=\"Apple-converted-space\">&nbsp; </span>It is generated by running 'dpkg-reconfigure ocfs2-tools'.</span>\n<span class=\"s1\"># Please use that method to modify this file.</span></pre><p class=\"p1\"><span class=\"s1\">So run dpkg-reconfigure ocfs2-tools on both nodes.<span class=\"Apple-converted-space\">&nbsp; </span>Answer YES to the first question, and then accept defaults for all the rest.</span></p><p class=\"p1\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNTY1IiB2aWV3Qm94PSIwIDAgODAwIDU2NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2NmZDRkYiIvPjwvc3ZnPg==\" loading=\"lazy\" class=\"alignnone size-full wp-image-23008\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/05/ocfs2_screen_shot.png.webp\" alt=\"\" width=\"800\" height=\"565\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/05/ocfs2_screen_shot.png.webp 800w, https://lowendbox.com/wp-content/uploads/2020/05/ocfs2_screen_shot-300x212.png.webp 300w, https://lowendbox.com/wp-content/uploads/2020/05/ocfs2_screen_shot-768x542.png.webp 768w\" data-sizes=\"(max-width: 800px) 100vw, 800px\"></p><p class=\"p1\"><span class=\"s1\">Now we can make the filesystem.<span class=\"Apple-converted-space\">&nbsp; </span>We don\u2019t want to make it on /dev/sdc1 but rather on the DRBD device:</span></p><pre class=\"p1\"><span class=\"s1\">root@web1:/etc/drbd.d# mkfs.ocfs2 -N 2 -L ocfs2drbd /dev/drbd0 </span>\n<span class=\"s1\">mkfs.ocfs2 1.8.5</span>\n<span class=\"s1\">Cluster stack: classic o2cb</span>\n<span class=\"s1\">Label: ocfs2drbd</span>\n<span class=\"s1\">Features: sparse extended-slotmap backup-super unwritten inline-data strict-journal-super xattr indexed-dirs refcount discontig-bg append-dio</span>\n<span class=\"s1\">Block size: 4096 (12 bits)</span>\n<span class=\"s1\">Cluster size: 4096 (12 bits)</span>\n<span class=\"s1\">Volume size: 10736005120 (2621095 clusters) (2621095 blocks)</span>\n<span class=\"s1\">Cluster groups: 82 (tail covers 8359 clusters, rest cover 32256 clusters)</span>\n<span class=\"s1\">Extent allocator size: 8388608 (2 groups)</span>\n<span class=\"s1\">Journal size: 67108864</span>\n<span class=\"s1\">Node slots: 2</span>\n<span class=\"s1\">Creating bitmaps: done</span>\n<span class=\"s1\">Initializing superblock: done</span>\n<span class=\"s1\">Writing system files: done</span>\n<span class=\"s1\">Writing superblock: done</span>\n<span class=\"s1\">Writing backup superblock: 2 block(s)</span>\n<span class=\"s1\">Formatting Journals: done</span>\n<span class=\"s1\">Growing extent allocator: done</span>\n<span class=\"s1\">Formatting slot map: done</span>\n<span class=\"s1\">Formatting quota files: done</span>\n<span class=\"s1\">Writing lost+found: done</span>\n<span class=\"s1\">mkfs.ocfs2 successful</span></pre><p class=\"p1\"><span class=\"s1\">Those flags mean \u201c2 nodes, and label the volume \u2018ocfs2drbd'\u201d.</span></p><p class=\"p1\"><span class=\"s1\">Now start/enable the cluster registration service on both nodes:</span></p><pre class=\"p1\"><span class=\"s1\"># systemctl enable ocfs2 &amp;&amp; systemctl enable o2cb</span>\n<span class=\"s1\">Synchronizing state of ocfs2.service with SysV service script with /lib/systemd/systemd-sysv-install.</span>\n<span class=\"s1\">Executing: /lib/systemd/systemd-sysv-install enable ocfs2</span>\n<span class=\"s1\">Synchronizing state of o2cb.service with SysV service script with /lib/systemd/systemd-sysv-install.</span>\n<span class=\"s1\">Executing: /lib/systemd/systemd-sysv-install enable o2cb</span>\n<span class=\"s1\"># systemctl start ocfs2 &amp;&amp; systemctl start o2cb</span></pre><h1 class=\"p1\"><span class=\"s1\">Mounting the Shared DRBD Volume</span></h1><p class=\"p1\"><span class=\"s1\">We\u2019re going to mount /dev/drbd0 (the shared cluster volume) on /web.<span class=\"Apple-converted-space\">&nbsp; </span>First, create the following entry in /etc/fstab on both nodes:</span></p><pre class=\"p1\"><span class=\"s1\">/dev/drbd0 <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>/web <span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>ocfs2 <span class=\"Apple-converted-space\">&nbsp; </span>noauto,noatime 0 0</span></pre><pre class=\"p1\"><span class=\"s1\">Now rename the existing /web to /web.prev and mkdir /web on both nodes:</span>\n\n<span class=\"s1\"># systemctl stop nginx</span>\n<span class=\"s1\"># mv /web /web.prev</span>\n<span class=\"s1\"># mkdir /web</span></pre><p class=\"p1\"><span class=\"s1\">Finally mount it on both nodes:</span></p><pre class=\"p1\"><span class=\"s1\"># mount /web</span></pre><p class=\"p1\"><span class=\"s1\">If you get this error when trying to mount:</span></p><pre class=\"p1\"><span class=\"s1\">mount.ocfs2: Unable to access cluster service while trying initialize cluster</span></pre><p class=\"p1\"><span class=\"s1\">Try this:</span></p><pre class=\"p1\"><span class=\"s1\">/etc/init.d/o2cb restart</span></pre><p class=\"p1\"><span class=\"s1\">Now if you go into /web on one node and touch a file or copy a file to that directory, you\u2019ll find it\u2019s nearly-instantly available on the other node.<span class=\"Apple-converted-space\">&nbsp; </span>We\u2019re enabled for multi-master so you can have nodes writing on both sides and changes will replicate bi-directionally.</span></p><p class=\"p1\"><span class=\"s1\">Now on *one* node (it\u2019s a shared volume, remember?) do this:</span></p><pre class=\"p1\"><span class=\"s1\"> mv /web.prev/www.lowend.party /web</span></pre><p class=\"p1\"><span class=\"s1\">And then cleanup on both nodes:</span></p><pre class=\"p1\"><span class=\"s1\">rm -rf /web.prev</span>\n<span class=\"s1\">systemctl start nginx</span></pre><p><strong>Next Part: <span class=\"s1\">Part 6 \u2013 Round-Robin DNS, Let\u2019s Encrypt, &amp; Conclusion</span></strong></p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-from-scratch-part-4/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Setup a Highly Available WordPress Site From Scratch, Part 4\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/05/highly-available-wordpress-part-4-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Setup a Highly Available WordPress Site From Scratch, Part 4</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/poll-have-you-enjoyed-our-recent-tutorials/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Poll: Have you enjoyed our recent Tutorials?\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/06/lowendbox-poll-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Poll: Have you enjoyed our recent Tutorials?</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-from-scratch-part-3/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Setup a Highly Available WordPress Site From Scratch, Part 3\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/05/highly-available-wordpress-part-3-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Setup a Highly Available WordPress Site From Scratch, Part 3</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-2/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Setup a Highly Available WordPress Site From Scratch, Part 2\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/04/highly-available-wordpress-part2-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Setup a Highly Available WordPress Site From Scratch, Part 2</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}