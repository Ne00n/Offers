{"id": "3922", "post": "<div class=\"post-3922 post type-post status-publish format-standard hentry category-tutorials tag-tutorials-2\" id=\"post-3922\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/remote-server-monitoring-with-nagios/\" rel=\"bookmark\">Remote server monitoring with nagios</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> May 11, 2013 @ 11:53 am, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p>There are many ways to remotely monitor your servers, but nagios is one of the most configurable and flexible ones. Once you have set up nagios, your localhost is being checked. But when there are real issues with your localhost, nagios probably isn\u2019t going to send you any messages. That\u2019s why you should set up remote monitoring: a nagios server that checks all your servers. Ideally, you set up multiple nagios servers or monitor your single nagios server as well. This article assumes a single nagios server.</p><p><span id=\"more-3922\"></span></p><p>So, remote monitoring. Nagios has a plugin named Nagios Remote Plugin Executor (NRPE for short). This plugin enables nagios to execute check scripts on remote host. What it checks, how often it checks it and when it sends out a warning can be easily configured (per server). In order for these remote checks to work, they need to be defined in two places:</p><ul><li>Nagios server: so it knows what to check and how to check it</li><li>Remote host: so it knows what the nagios server is allowed to check</li></ul><p>This article assumes you have nagios up and running for localhost. It also assumes you use Ubuntu or Debian (though it may very well work on other Linux distributions as well). The first thing to do is to make sure the NRPE plugin is installed on the nagios server:</p><blockquote><p>sudo apt-get install nagios-nrpe-plugin</p></blockquote><p>Once that is done, check if there\u2019s a bunch of files (plugins) listed:</p><blockquote><p>ls -al /usr/lib/nagios/plugins/</p></blockquote><p>Next, you usually need to determine what services you would like to check and whether there is a plugin for it. You can write your own nagios plugins in whatever language you want. I\u2019ve worked with some PHP nagios plugins, so it\u2019s really not that hard. However, that\u2019s something for another article and we\u2019re going to work with some of the stock plugins now. I\u2019m going to use the following plugins in my examples:</p><ul><li>Current Users (check_users)</li><li>Current Load (check_load)</li><li>Disk Space (check_all_disks)</li><li>Zombie Processes (check_zombie_procs)</li><li>Total Processes (check_total_procs)</li><li>Swap (check_swap)</li></ul><h2>Nagios server</h2><p>First thing you need to do, is to define the services on the nagios server. The nagios server needs to know what services to check for a remote host and how it needs to do that. I\u2019ve added my services to /etc/nagios3/conf.d/services_nagios2.cfg (which is default on Ubuntu). The file consists of blocks that look like:</p><blockquote><p>define service {<br>\nhostgroup_name local-servers<br>\nservice_description SSH<br>\ncheck_command check_ssh<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p></blockquote><p>We\u2019re going to make such a block for every remote check we need. I\u2019m going to show one example here and attach the full list of definitions to this article (for reference or copy-paste). Here is the first remote service definition:</p><blockquote><p>define service {<br>\nhostgroup_name generic-servers<br>\nservice_description Current Users NRPE<br>\ncheck_command check_nrpe_1arg!check_users<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p></blockquote><p>I\u2019m going to explain this block line by line, so you really understand what it all does. The \u2018define service\u2019 kind of speaks its purpose, so I\u2019ll skip that.</p><blockquote><p>hostgroup_name generic-servers</p></blockquote><p>This assigns this service to a hostgroup (and defines it if it didn\u2019t exist yet). You can later add a host to that hostgroup and it\u2019ll automatically execute this check for that host (and all other hosts in that hostgroup).</p><blockquote><p>service_description Current Users NRPE</p></blockquote><p>This describes the service and is used for displaying this service on both the nagios web interface and in any nagios software you could use (like nagstamon or aNag).</p><blockquote><p>check_command check_nrpe_1arg!check_users</p></blockquote><p>This defines the actual command of the check. The first part, \u2018check_nrpe_1arg\u2019, says this is a check without any additional arguments. It says 1arg, because that one argument is \u2018check_users\u2019 (the exclamation mark is used as a separator for arguments). So this piece makes sure that the \u2018check_users\u2019 command is executed on the remote host.</p><blockquote><p>use generic-service</p></blockquote><p>The use keyword enables you to include templates. This time it\u2019s the generic-service template. A template is actually a normal nagios configuration, in this case a service definition like the one we\u2019re adding now. I use the default template that is installed with nagios (on Ubuntu). To see the service definition:</p><blockquote><p>sudo less /etc/nagios3/conf.d/generic-service_nagios2.cfg</p></blockquote><p>This service defines a lot of options that you now don\u2019t have to have to define with every service definition you write. So with the use keyword, you can easily define basic definitions for groups of hosts. Now back to the last line:</p><blockquote><p>notification_interval 0</p></blockquote><p>This defines the number of time units before re-sending a notification in case of a problem with this service. A time unit is defined as interval_length (defined in /etc/nagios3/nagios.cfg), which defaults to 60 seconds. The number here is thus in minutes (x times 60 seconds). Set this to 0 to receive just one notification.</p><p>Now we\u2019ve established what the definition does, you can add service definitions for all the plugins I listed and we can move on to the remote host. You may also skip doing this and add more checks later.</p><h2>Remote host</h2><p>Now on to the remote host we want to check. We start by installing the NRPE server (which includes the default set of plugins):</p><blockquote><p>sudo apt-get install nagios-nrpe-server</p></blockquote><p>Again, make sure the plugins are actually there:</p><blockquote><p>ls -al /usr/lib/nagios/plugins/</p></blockquote><p>Now it is important to make sure the nagios server is allowed to connect to the remote host. First of all, if you use a firewall, you need to open up port 5666 (TCP &amp; UDP). Second, you need to define the allowed_hosts parameter in /etc/nagios/nrpe_local.cfg. Notice the \u2018_local\u2019, because there also is a nrpe.cfg. The nrpe.cfg contains the default configuration. You can override these configuration options in the nrpe_local.cfg file without getting merge issues when upgrading.</p><p>Make sure the nrpe_local.cfg line looks something like this:</p><blockquote><p>######################################<br>\n# Do any local nrpe configuration here<br>\n######################################<br>\nallowed_hosts=127.0.0.1,192.0.2.20</p></blockquote><p>I always leave 127.0.0.1 there. Although it is not strictly necessary, it could be useful for local testing. You can add as many IP addresses as you deem necessary there. I just added one IP, the one of the nagios server.</p><p>After setting this and restarting the nagios-nrpe-server, the nagios server can connect to the nagios server. Howerver, it cannot execute any checks yet. In order to be able to execute checks, the checks that were defined on the nagios server need to be defined here as well. Open up the file /etc/nagios/nrpe_local.cfg again and add the following lines (you can comment them out with #):</p><blockquote><p>command[check_users]=/usr/lib/nagios/plugins/check_users -w 5 -c 10<br>\ncommand[check_load]=/usr/lib/nagios/plugins/check_load -w 15,10,5 -c 30,25,20<br>\ncommand[check_all_disks]=/usr/lib/nagios/plugins/check_disk -w 20% -c 10%<br>\ncommand[check_zombie_procs]=/usr/lib/nagios/plugins/check_procs -w 5 -c 10 -s Z<br>\ncommand[check_total_procs]=/usr/lib/nagios/plugins/check_procs -w 150 -c 200<br>\ncommand[check_swap]=/usr/lib/nagios/plugins/check_swap -w 50% -c 25%</p></blockquote><p>By adding these lines, we have mapped the checks defined on the nagios server (behind check_nrpe_arg1!) to actual checks on the remote host. Let\u2019s look at the first line:</p><blockquote><p>command[check_users]=/usr/lib/nagios/plugins/check_users -w 5 -c 10</p></blockquote><p>This maps check_users to /usr/lib/nagios/plugins/check_users. You can even test the check by executing /usr/lib/nagios/plugins/check_users directly. If you do that, it gives a nice warning that you forgot two parameters:</p><blockquote><p>Usage:<br>\ncheck_users -w &lt;users&gt; -c &lt;users&gt;</p></blockquote><p>In the command definition, we\u2019ve set these to 5 and 10. The -w is to set the warning threshold. The -c is to set the critical threshold. If five users are logged in at the same time, and the nagios servers checks it, it triggers a warning. If 10 users are logged in at the same time, it triggers a critical warning.</p><p>Now run the check again to see the actual result:</p><blockquote><p>/usr/lib/nagios/plugins/check_users -w 5 -c 10</p></blockquote><p>It should now say:</p><blockquote><p>USERS OK \u2013 1 users currently logged in |users=1;5;10;0</p></blockquote><p>As you can see, every command has different threshold values. Notice the % with check_all_disks and check_swap. If you ever add a check, be sure to run in directly on the remote host to see if it returns the expected result. It\u2019s never a waste to play with these checks a bit and fine-tune them.</p><p>Finally, restart the NRPE server so the new config gets loaded:</p><blockquote><p>sudo service nagios-nrpe-server restart</p></blockquote><h2>Back to the nagios server</h2><p>The last thing we need to do is to add a host to the hostgroup we have just added the check for. Still following me? We added the remote check to a hostgroup. If we now add hosts to that hostgroup, the hosts will automatically get the checks from that hostgroup.</p><p>On your nagios server, create a file in /etc/nagios3/conf.d. How you name it is up to you, but I use a scheme where I name the file after the host I define in it. So, say I want to add a host definition for alpha.example.net, I would use:</p><blockquote><p>sudo vim /etc/nagios3/conf.d/alpha.example.net.cfg</p></blockquote><p>Feel free to add a servers/ folder in conf.d/: nagios load all config files in that directory recursively. Now to the contents of the file. They should look like this:</p><blockquote><p>define host {<br>\nhost_name alpha<br>\nalias alpha.example.net<br>\nhostgroups general-servers<br>\naddress 192.0.2.21<br>\nuse generic-host<br>\n}</p></blockquote><p>The lines host_name and alias are used to identify the host within nagios. Contrary to what you might expect, the host_name is the short version and the alias the long version of the host identification.</p><p>The hostgroups line is similar to what we\u2019ve seen before. We have now added this host to just one hostgroup, the one we defined earlier. However, a host can belong to many more hostgroups. You can add it to more by comma-separating a list of hostgroups, like:</p><blockquote><p>hostgroups general-servers,http-servers,critical-servers</p></blockquote><p>The address refers to the IP address of the remote host This may also be a fully qualified domain name, so this is valid as well:</p><blockquote><p>address alpha.example.net</p></blockquote><p>The use statement has been explained before. Feel free to check the definition of generic-host and figure out what it does, it should lead to a better understanding of the host definition.</p><p>Now we\u2019ve defined the host, reload (or restart, but reloading is faster) the nagios NRPE server:</p><blockquote><p>sudo service nagios3 reload</p></blockquote><p>\u2026and you\u2019re all set! If you now go to your nagios web interface, you should see the remote host and the services we\u2019ve defined! You can now add all your hosts to nagios and have an overview of the full status of all of your servers!</p><h2>Full list of service definitions</h2><p>For reference, the full list of service definitions:</p><blockquote><p># NRPE Services<br>\ndefine service {<br>\nhostgroup_name generic-servers<br>\nservice_description Current Users NRPE<br>\ncheck_command check_nrpe_1arg!check_users<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p><p>define service {<br>\nhostgroup_name generic-servers<br>\nservice_description Current Load NRPE<br>\ncheck_command check_nrpe_1arg!check_load<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p><p>define service {<br>\nhostgroup_name generic-servers<br>\nservice_description Disk Space NRPE<br>\ncheck_command check_nrpe_1arg!check_all_disks<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p><p>define service {<br>\nhostgroup_name generic-servers<br>\nservice_description Zombie Processes NRPE<br>\ncheck_command check_nrpe_1arg!check_zombie_procs<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p><p>define service {<br>\nhostgroup_name generic-servers<br>\nservice_description Total Processes NRPE<br>\ncheck_command check_nrpe_1arg!check_total_procs<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p><p>define service {<br>\nhostgroup_name generic-servers<br>\nservice_description Swap NRPE<br>\ncheck_command check_nrpe_1arg!check_swap<br>\nuse generic-service<br>\nnotification_interval 0<br>\n}</p></blockquote><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fremote-server-monitoring-with-nagios%2F&amp;t=Remote%20server%20monitoring%20with%20nagios\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Remote%20server%20monitoring%20with%20nagios&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fremote-server-monitoring-with-nagios%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fremote-server-monitoring-with-nagios%2F&amp;title=Remote%20server%20monitoring%20with%20nagios&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/centos-6-end-of-life-is-coming-upgrade-to-a-new-centos-7-vps-now/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/centos-6-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/best-web-hosting-control-panels-after-the-cpanel-price-hike/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Best Web Hosting Control Panels after the cPanel Price Hike\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Best Web Hosting Control Panels after the cPanel Price Hike</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-plex-media-server-on-your-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Set Up Plex Media Server on Your Cheap VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/how-to-set-up-plex-media-server-on-vps-2-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Set Up Plex Media Server on Your Cheap VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-create-a-dns-server-on-debian-stretch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Create a DNS Server On Debian Stretch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Create a DNS Server On Debian Stretch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}