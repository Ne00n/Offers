{"id": "22600", "post": "<div class=\"post-22600 post type-post status-publish format-standard hentry category-tutorials tag-ansible tag-tutorial\" id=\"post-22600\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/managing-your-lowendempire-with-ansible-part-2/\" rel=\"bookmark\">Managing Your LowEndEmpire With Ansible, Part 2</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/ansible/\" rel=\"tag\">ansible</a>, <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> December 7, 2020 @ 4:39 am, by raindog308</div><div class=\"storycontent tablelook\"><p><a href=\"https://lowendbox.com\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-300x169.png.webp\" loading=\"lazy\" class=\"screenshot litespeed-loaded\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-300x169.png.webp\" alt=\"\" width=\"300\" height=\"169\" data-was-processed=\"true\"></a>In the <a href=\"https://lowendbox.com/blog/managing-your-lo\u2026h-ansible-part-1/\">previous tutorial</a>, we walked through setting up Ansible on both the control (master) node and on target nodes.&nbsp; Now let\u2019s look at using Ansible capabilities.</p><h1>Writing Playbooks</h1><p>One cool thing about Ansible is that hosts can have various roles, and you can layer these roles. So for example you could have roles like this:</p><ul><li>a \u201ccommon\u201d role that contains tasks to be run on all hosts</li><li>a \u201cbackup-client\u201d role for hosts that are backed up</li><li>a \u201cdb\u201d role for hosts that operate as database servers</li></ul><p>etc. In this tutorial, we\u2019ll have a \u201ccommon\u201d role that we intend to run on all hosts. That we\u2019ll create another role called \u2018db\u2019 for database servers.</p><p><span id=\"more-22600\"></span></p><p>In /ansible, create the following playbook file called db.yml:</p><pre>---\n- hosts: db\n\n  roles:\n    - common</pre><p>Note that we are using YAML, which is very fussy about syntax, paticular spaces, so if you get an error, make sure it\u2019s as show above.</p><h1>Modules</h1><p>Ansible comes with a wide variety of modules, which are packages that can be used to issue commands on target hosts. These cover a ton of common tasks. Some examples:</p><ul><li>the \u2018apt\u2019 module can be used to install and remove packages using apt on Debian. There are also \u2018yum\u2019, \u2018pacman\u2019 and other package manager modules.</li><li>modules such as \u2018user\u2019, \u2018group\u2019, etc. can add/remove users and groups</li><li>locale_gen, timezone, and other modules can be used for system configuration</li><li>the \u2018postgresql*\u2019 set of modules and the \u2018mysql*\u2019 modules can be used to add/remove databases, add/remove users, etc.</li></ul><p>Etcetera. So if you want to make sure that a certain package is available on your server, you don\u2019t need to code dpkg, apt-get, etc. commands. You can just use the relevant Ansible module.</p><p>If something you need is not covered by a stock module, there are also modules for modifying files, making sure a line is present in a file, etc. which allow for configurations not covered by the Ansible distributed modules. And of course you can always copy a script from your control node and execute it.</p><p><a href=\"https://docs.ansible.com/ansible/latest/modules/modules_by_category.html\">See the docs</a> for a full list of all modules and capabilities.</p><h1>Creating a Playbook</h1><p>Create the following directory structure:</p><pre>mkdir -p /ansible/roles/common/tasks</pre><p>Now we\u2019ll create the actual tasks we\u2019re going to execute for the \u2018common\u2019 role. In /ansible/roles/common/tasks, create the file main.yml as follows. You do not need to include the comments \u2013 they are explanatory text for purposes of this tutorial.</p><p>The \u2018name\u2019 portion of each task is whatever you choose to call that task. The following line contains the module name followed by a colon, and then specific arguments and options for that module.</p><pre>---\n\n  # this task will run dpkg-reconfigure locales and ensure that\n  # en_US.UTF-8 is present. Modify for your locale.\n\n  - name: locale generation\n    locale_gen: name=en_US.UTF-8 state=present\n\n  # this task will run apt-get update\n\n  - name: apt-get update\n    apt: update_cache=yes\n\n  # this task will run apt-get upgrade\n\n  - name: apt-get upgrade\n    apt: upgrade=dist\n\n  # this task will install some packages we want on all hosts\n\n  - name: basic packages\n    apt: name=bsd-mailx,bzip2,cron,dnsutils,gpg,git,man,sqlite,unzip,vim,wget,whois,zip state=latest\n\n  # this task will set the localtime to US/Pacific. Modify to taste.\n\n  - name: set timezone\n    timezone:\n      name: US/Pacific\n\n  # this task will make sure that cron is enable in systemd\n\n  - name: cron enable\n    service: name=cron enabled=yes state=started\n\n  # this task ensures that root's .bash_profile exists\n  - name: make sure /root/.bash_profile exists\n    file:\n    path: /root/.bash_profile\n    state: touch\n\n  # this task ensures that 'set -o vi' is in root's .bash_profile\n\n  - name: set -o vi for root\n    lineinfile:\n    path: /root/.bash_profile\n    state: present\n    regexp: '^set -o vi'\n    line: set -o vi</pre><p>Then run the ansible-playbook file against db.yml:</p><pre>root@master:/ansible# ansible-playbook db.yml\n\nPLAY [db] **********************************************************************\n\nTASK [Gathering Facts] *********************************************************\nok: [target.example.com]\n\nTASK [common : locale generation] **********************************************\nok: [target.example.com]\n\nTASK [common : apt-get update] *************************************************\nchanged: [target.example.com]\n\nTASK [common : apt-get upgrade] ************************************************\nok: [target.example.com]\n\nTASK [common : basic packages] *************************************************\nok: [target.example.com]\n\nTASK [common : set timezone to US/Pacific] *************************************\nok: [target.example.com]\n\nTASK [common : cron enable] ****************************************************\nok: [target.example.com]\n\nTASK [common : make sure /root/.bash_profile exists] ***************************\nchanged: [target.example.com]\n\nTASK [common : set -o vi for root] *********************************************\nchanged: [target.example.com]\n\nPLAY RECAP *********************************************************************\ntarget.example.com : ok=9 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0</pre><h1>Ansible\u2019s Power</h1><p>Now you may say to yourself \u201cso you\u2019ve set the locale and timezone and installed some packages \u2013 so what?\u201d But the key points here are:</p><ul><li>You didn\u2019t have to do it manually.</li><li>Because it\u2019s automated, it\u2019s done identically every single time.</li><li>You can do this as easily on one host as on a thousand hosts.</li><li>Ansible allows you to set roles that baseline your environment. So every single host you use will be setup exactly as you wish.</li><li>You can run these commands every night to make sure no host drifts from the configuration you want. Think of these as \u201cpolicies\u201d that enforce how you want each server to be configured.</li></ul><h1>Adding a Database Role</h1><p>Modify your db.yml to add a db-server role:</p><pre>---\n- hosts: db\n\n  roles:\n    - common\n    - db-server</pre><p>Then:</p><pre>mkdir -p /ansible/roles/db-server/tasks</pre><p>And create a main.yml there with these tasks:</p><pre>---\n\n  # make sure that postgres is installed\n\n  - name: postgres package\n    apt: name=postgresql-11,python-ipaddress state=latest\n\n  # make sure postgresql is configured to start on boot\n\n  - name: postgres enable\n    service: name=postgresql enabled=yes state=started\n\n  # enable md5 (password) connections locally\n\n    - name: modify pg_hba.conf to allow md5 connections\n      postgresql_pg_hba:\n        dest: /etc/postgresql/11/main/pg_hba.conf\n        contype: local\n        users: all\n        databases: all\n        method: md5\n        state: present</pre><p>Now run</p><pre>ansible-playbook db.yml</pre><p>You\u2019ll see Ansible walk through all the \u2018common\u2019 tasks, and then:</p><pre>TASK [db-server : postgres packages] *******************************************\nchanged: [target.example.com]\n\nTASK [db-server : postgres enable] *********************************************\nok: [target.example.com]\n\nTASK [db-server : modify pg_hba.conf to allow md5 connections] *****************\nchanged: [target.example.com]</pre><p>Other PostgreSQL modules allow us to create databases, setup users, grant permissions, etc.</p><h1>Copying Files and Using Templates</h1><p>Ansible allows the easy distribution of files, either for configuration or application purposes. It also comes with a powerful templating package called Jinja2 that can modify these templates so that they are customized properly for each system.</p><p>Let\u2019s add a mail-server role. We\u2019ll use postfix.</p><p>Modify db.yml again:</p><pre>---\n- hosts: db\n\n  roles:\n    - common\n    - db-server\n    - mail-server</pre><p>Then execute:</p><pre>mkdir -p /ansible/roles/mail-server/tasks</pre><p>And edit /ansible/roles/mail-server/tasks/main.yml:</p><pre>---\n\n  # ensure postfix packages are installed\n\n  - name: postfix package package\n    apt: name=postfix state=latest\n\n  # template /etc/mailname\n\n  - name: /etc/mailname\n    template: src=/ansible/src/mailname.j2 dest=/etc/mailname owner=root group=0 mode=0644\n\n  # copy /etc/postfix/main.cf\n\n  - name: postfix main.cf\n    template: src=/ansible/src/main.cf.j2 dest=/etc/postfix/main.cf owner=root group=0 mode=0644\n\n  # make sure postfix is configured to start on boot and restart it\n  # in case main.cf is changed\n\n  - name: postfix enable and restart\n    service: name=postfix enabled=yes state=restarted\n\n  # set the root: alias in /etc/aliases\n\n  - name: root alias in /etc/aliases\n    lineinfile:\n      path: /etc/aliases\n      state: present\n      regexp: '^root:'\n      line: 'root: someone@somewhere.com'\n\n  # run newaliases\n\n  - name: newaliases\n    command: /usr/bin/newaliases</pre><p>Now let\u2019s create our templates. In /ansible/src/mailname.j2, enter this text:</p><pre>{{ ansible_host }}</pre><p>This is a Jinja2 template (hence the .j2 ending). Text in between the double braces will be replaced with variables. Ansible supports <a href=\"https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html\">many different variables</a>. In this case we are using \u2018ansible_host\u2019 which will be replaced with \u2018target.example.com\u2019.</p><p>Here is /ansible/src/main.cf.j2, our postfix configuration:</p><pre>smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)\nbiff = no\nappend_dot_mydomain = no\nreadme_directory = no\ncompatibility_level = 2\nsmtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem\nsmtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key\nsmtpd_use_tls=yes\nsmtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache\nsmtp_tls_session_cache_database = btree:${data_directory}/smtp_scache\nsmtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination\nmyhostname = {{ ansible_node_name }}\nalias_maps = hash:/etc/aliases\nalias_database = hash:/etc/aliases\nmyorigin = /etc/mailname\nmydestination = $myhostname, localhost.example.com , localhost\nrelayhost =\nmynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128\nmailbox_size_limit = 0\nrecipient_delimiter = +\ninet_interfaces = all\ninet_protocols = all</pre><p>Of course many Postfix variables could be set \u2013 this is a tutorial on Ansible not Postfix.</p><p>Now run:</p><pre>ansible-playbook db.yml</pre><p>And after the \u2018common\u2019 and \u2018db-server\u2019 sections, you\u2019ll see the \u2018mail-server\u2019 tasks run:</p><pre>TASK [mail-server : postfix package package] ***********************************\nchanged: [target.example.com]\n\nTASK [mail-server : /etc/mailname] *********************************************\nchanged: [target.example.com]\n\nTASK [mail-server : postfix main.cf] *******************************************\nchanged: [target.example.com]\n\nTASK [mail-server : postfix enable and restart] ********************************\nchanged: [target.example.com]\n\nTASK [mail-server : root alias in /etc/aliases] ********************************\nchanged: [target.example.com]\n\nTASK [mail-server : newaliases] ************************************************\nchanged: [target.example.com]</pre><p>And if we look on the system, we see that the proper template substitutions have been made:</p><pre>root@master:/ansible# cat /etc/mailname\nmaster.example.com</pre><h1>Wrap Up</h1><p>Although we\u2019ve only scratched the surface of Ansible\u2019s capabilities, hopefully you can see the tremendous power and flexibility of the product.&nbsp; With Ansible playbooks, you can both setup new systems quickly and&nbsp;enforce policies on a continuous basis.</p><p>&nbsp;</p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/resetting-that-linux-root-password-you-forgot/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"lowendtutorial\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Resetting that Linux Root Password You Forgot</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/managing-your-lowendempire-with-ansible-part-1/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Managing Your LowEndEmpire With Ansible, Part 1\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Managing Your LowEndEmpire With Ansible, Part 1</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/setup-a-dns-nameserver-using-nsd/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Setup a DNS Nameserver Using NSD\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Setup a DNS Nameserver Using NSD</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/keeping-a-logwatchful-eye-on-your-vps-with-logwatch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Keeping A (log)Watchful Eye on Your VPS With logwatch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/logwatch-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Keeping A (log)Watchful Eye on Your VPS With logwatch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}