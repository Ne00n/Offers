{"id": "22988", "post": "<div class=\"post-22988 post type-post status-publish format-standard hentry category-tutorials tag-high-availability tag-highly-available tag-how-to tag-setup-wordpress tag-tutorial tag-wordpress tag-wordpress-setup\" id=\"post-22988\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-1/\" rel=\"bookmark\">How to Setup a Highly Available WordPress Site From Scratch, Part 1</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/high-availability/\" rel=\"tag\">high availability</a>, <a href=\"https://lowendbox.com/tag/highly-available/\" rel=\"tag\">highly available</a>, <a href=\"https://lowendbox.com/tag/how-to/\" rel=\"tag\">how to</a>, <a href=\"https://lowendbox.com/tag/setup-wordpress/\" rel=\"tag\">setup wordpress</a>, <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a>, <a href=\"https://lowendbox.com/tag/wordpress/\" rel=\"tag\">wordpress</a>, <a href=\"https://lowendbox.com/tag/wordpress-setup/\" rel=\"tag\">wordpress setup</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> December 11, 2020 @ 6:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p><a target=\"_blank\" rel=\"noopener noreferrer\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2020/05/highly-available-wordpress-part-1.jpg.webp\" loading=\"lazy\" class=\"screenshot litespeed-loaded\" title=\"How to Setup a Highly Available WordPress Site From Scratch, Part 1\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/05/highly-available-wordpress-part-1.jpg.webp\" alt=\"How to Setup a Highly Available WordPress Site From Scratch, Part 1\" width=\"410\" height=\"226\" data-was-processed=\"true\"></a></p><p class=\"p1\"><span class=\"s1\">In this tutorial series, we are setting up a highly available WordPress web site from scratch.&nbsp;</span></p><p class=\"p1\"><span class=\"s1\">Part 1 \u2013 Introduction, Considerations, and Architecture<br>\n</span><span class=\"s1\">Part 2 \u2013 Setting Up the VPSes<br>\n</span><span class=\"s1\">Part 3 \u2013 Setting Up MariaDB Multi-Master Replication<br>\n</span><span class=\"s1\">Part 4 \u2013 File Replication and Setting Up DRBD<br>\n</span><span class=\"s1\">Part 5 \u2013 Setting Up OCFS2<br>\n</span><span class=\"s1\">Part 6 \u2013 Round-Robin DNS, Let\u2019s Encrypt, &amp; Conclusion</span></p><h1 class=\"p1\">Goals</h1><ul><li class=\"p1\">Complete protection against a VPS or web server failure, so that if a node goes down, the web site will continue to be fully functional.</li><li class=\"p1\"><span class=\"s1\">Full operations available on both nodes, not just a read-only copy or a cache but the entire site so authors can post, users can make updates, etc.&nbsp;</span></li><li class=\"p1\"><span class=\"s1\">Setup with https via Let\u2019s Encrypt with the usual certbot self-renewing certificate.</span></li></ul><p><span id=\"more-22988\"></span></p><h1 class=\"p1\"><span class=\"s1\">High Availability Considerations</span></h1><p class=\"p1\"><span class=\"s1\">To achieve our goal, we\u2019ll need to answer the following questions:</span></p><ul><li class=\"p1\"><span class=\"s1\">What if a VPS goes down, either fully or partially (for example, the VPS is up but its webserver is down)?</span></li><li class=\"p1\"><span class=\"s1\">If we have multiple VPSes serving the same WordPress site, how do we keep them in sync?<span class=\"Apple-converted-space\">&nbsp; </span>We have to consider both the database and the content such as media uploaded, etc.</span></li><li class=\"p1\"><span class=\"s1\">How rigorous does our replication need to be?<span class=\"Apple-converted-space\">&nbsp; </span>Is it acceptable if things get out of sync by a few minutes or do we want things always in sync?</span></li><li class=\"p1\"><span class=\"s1\">If a node fails, how does the client (i.e., any random Internet user\u2019s web browser) know which node to point to?</span></li></ul><h1 class=\"p1\"><span class=\"s1\">High Availability Architecture</span></h1><p class=\"p1\"><span class=\"s1\">We\u2019re going to use the following setup:</span></p><p class=\"p1\"><span class=\"s1\"><strong>Two Debian 10 VPSes, each with nginx and php-fpm to serve WordPress.</strong><span class=\"Apple-converted-space\">&nbsp; </span>Nothing here is Debian-specific but to avoid making the tutorial twice as long, we\u2019re only covering one distro.</span></p><p class=\"p1\"><span class=\"s1\">I\u2019ll be using two VPSes in Linode\u2019s Fremont, CA dataceter.<span class=\"Apple-converted-space\">&nbsp; </span>There\u2019s nothing special about the choice of Linode \u2013 these techniques should work for any VPSes.<span class=\"Apple-converted-space\">&nbsp; </span>We\u2019re locating both VPSes in the same DC to make synchronization as quick as possible.<span class=\"Apple-converted-space\">&nbsp; </span>But this architecture will work for geographically separated VPSes (to protect against failure of a datacenter).<span class=\"Apple-converted-space\">&nbsp; </span>Because private IPs are not available from all providers, we are only going to use public IPs.<span class=\"Apple-converted-space\">&nbsp; </span>However, if you have private IPs available from your provider, you should use these for replication to potentially reduce bandwidth costs.</span></p><p class=\"p1\"><span class=\"s1\"><strong>MariaDB\u2019s native multi-master replication.</strong><span class=\"Apple-converted-space\">&nbsp; </span>MariaDB\u2019s Galera option is another good choice, though it\u2019s meant for a minimum of three nodes.<span class=\"Apple-converted-space\">&nbsp; </span>You can use garbd to use Galera on two nodes if you want to go that route.</span></p><p class=\"p1\"><span class=\"s1\"><strong>DRBD + OCFS2 to replicate a volume bi-directionally between the nodes.</strong><span class=\"Apple-converted-space\">&nbsp; </span>There are other options we\u2019ll explore including a quick-and-dirty rsync if your non-database updates are few or if you have a single-author WordPress site.<span class=\"Apple-converted-space\">&nbsp; </span>There are many replication options and we\u2019ll talk about why some popular options don\u2019t fully solve the problem.</span></p><p class=\"p1\"><span class=\"s1\"><strong>Round-robin DNS for the client (a web browser).</strong><span class=\"Apple-converted-space\">&nbsp; </span>RRDNS is a DNS feature where you say \u201cfor this DNS entry, hand out these responses and rotate among them\u201d.<span class=\"Apple-converted-space\">&nbsp; </span>So the first time someone looks up the site, they\u2019ll get node 1\u2019s address, and the next time they\u2019ll get node 2, etc.<span class=\"Apple-converted-space\">&nbsp; </span>In ages past, browsers would get one address and stick to it until DNS TTL expired, but most modern browsers are smart enough that if they get two IPs for a web site and one doesn\u2019t answer, they\u2019ll try the other. </span></p><p class=\"p1\"><span class=\"s1\"><strong>Let\u2019s Encrypt for https.</strong><span class=\"Apple-converted-space\">&nbsp; </span>We\u2019ll also solve the issue of how certbot can update when RRDNS can return either node\u2019s address.</span></p><p class=\"p1\"><span class=\"s1\">Here\u2019s a diagram of the architecture:</span></p><h1 class=\"p1\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTEiIGhlaWdodD0iNTg2IiB2aWV3Qm94PSIwIDAgNTExIDU4NiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2NmZDRkYiIvPjwvc3ZnPg==\" loading=\"lazy\" class=\"alignnone wp-image-22990\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/05/diagram1.png\" alt=\"\" width=\"511\" height=\"586\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/05/diagram1.png 668w, https://lowendbox.com/wp-content/uploads/2020/05/diagram1-262x300.png.webp 262w\" data-sizes=\"(max-width: 511px) 100vw, 511px\"></h1><h1 class=\"p1\"><span class=\"s1\">Before You Begin</span></h1><p class=\"p1\"><span class=\"s1\">We\u2019re using DRBD for synchronization between the nodes.<span class=\"Apple-converted-space\">&nbsp; </span>DRBD requires a dedicated partition, so if you\u2019re setting up from KVM you should keep this in mind when setting up your VPS and installing the OS.<span class=\"Apple-converted-space\">&nbsp; </span>Alternatively, if your provider offers block storage, you can attach a new volume, which is what I\u2019ve done here.</span></p><p><strong>Next Part: <span class=\"s1\">Part 2 \u2013 Setting Up the VPSes</span></strong></p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-keep-your-wordpress-site-secure/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Keep your WordPress Site Secure\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/06/how-to-keep-your-wordpress-site-secure-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Keep Your WordPress Site Secure</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/managing-your-lowendempire-with-ansible-part-2/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Managing Your LowEndEmpire With Ansible, Part 2\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Managing Your LowEndEmpire With Ansible, Part 2</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/resetting-that-linux-root-password-you-forgot/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"lowendtutorial\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Resetting that Linux Root Password You Forgot</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/managing-your-lowendempire-with-ansible-part-1/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Managing Your LowEndEmpire With Ansible, Part 1\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Managing Your LowEndEmpire With Ansible, Part 1</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}