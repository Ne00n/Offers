{"id": "4269", "post": "<div class=\"post-4269 post type-post status-publish format-standard hentry category-tutorials tag-tutorials-2\" id=\"post-4269\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/getting-started-with-openvpn-server/\" rel=\"bookmark\">Getting started with OpenVPN (server)</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> August 31, 2013 @ 1:22 pm, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center;\"><a href=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" loading=\"lazy\" class=\"alignnone size-full wp-image-3957 litespeed-loaded\" alt=\"lowendtutorial\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" width=\"271\" height=\"70\" data-was-processed=\"true\"></a></p><p>There are various ways to set up a Virtual Private Network (VPN). With the various protocols available to use for VPN and all the software out there, it\u2019s often a spider\u2019s web when you just want to set up a VPN. Well, rest assured: it\u2019s not that hard!</p><p>A VPN can be useful for various things, but it\u2019s often used for one of these:</p><ul><li>Secure connection to an internal office network not accessible from the outside</li><li>Secure connection to the internet on public wifi (although from the VPN server on it\u2019s back to \u201cdefault\u201d security)</li><li>Hiding your real IP/masking your location (for example: using Netflix outside the USA)</li></ul><p>I\u2019m going to show you how to set up OpenVPN using a \u2018tap\u2019 device. For this, you need a KVM or Xen VPS, or an OpenVZ VPS which supports TAP. If you use an OpenVZ VPS, be sure to enable TAP first from the control panel (it requires a reboot). Other than that, there\u2019s no real system requirements. This guide works on both CentOS and Ubuntu.</p><p><span id=\"more-4269\"></span></p><p><em>I\u2019ve chosen OpenVPN because it\u2019s a well-established open source solution with good client software support. Alternatives I considered were PPTP, which has some security issues, and IPSec/L2TP, which has a more complicated setup and software that has some \u201cquirks\u201d.</em></p><h2>Installing software</h2><p>First of all, let\u2019s install the software.</p><h3>Ubuntu</h3><blockquote><p>sudo apt-get install openvpn</p></blockquote><h3>CentOS</h3><blockquote><p>sudo yum install openvpn</p></blockquote><h3>Enable IPv4 forwarding</h3><p>IPv4 forwarding needs to be enabled, otherwise packets can\u2019t go from the internet, via the VPS to you. To enable this, open up /etc/sysctl.conf and fine a line that looks like:</p><blockquote><p>net.ipv4.ip_forward=1</p></blockquote><p>The value for this option should be \u20181\u2019. Sometimes it\u2019s commented (Ubuntu) and sometimes it\u2019s a \u20180\u2019 (CentOS). Make sure it looks like the line above, save the file and:</p><blockquote><p>sudo sysctl -p</p></blockquote><p>Which reloads these settings. Alternatively, reboot.</p><h2>Generating keys</h2><p>Now the software is installed, let\u2019s start by generating the keys used for encryption and authentication.</p><p>First, create directory that\u2019s going to hold the keys and the scripts to generate these keys:</p><blockquote><p>sudo mkdir /etc/openvpn/easy-rsa</p></blockquote><p>Next, download the key generation software:</p><blockquote><p>wget https://github.com/OpenVPN/easy-rsa/archive/v2.2.0.tar.gz -O easy-rsa.tar.gz</p></blockquote><p>Ubuntu already has these scripts included, but CentOS hasn\u2019t. For the sake of simplicity, downloading them from OpenVPN\u2019s github is the best option.</p><p>Now, let\u2019s extract the files to the proper directory:</p><blockquote><p>sudo tar xvzf easy-rsa.tar.gz -C /etc/openvpn/easy-rsa \u2013strip-components=3 easy-rsa-2.2.0/easy-rsa/2.0/</p></blockquote><p>And go to that directory:</p><blockquote><p>cd /etc/openvpn/easy-rsa/</p></blockquote><p>OpenVPN uses SSL (certificates) for connection security and authentication. We\u2019re going to generate the certificates required for this:</p><ul><li>Root key/certificate (ca.key/ca.crt)</li><li>TLS key (ta.key)</li><li>Server key/certificate (server.key/server.crt)</li><li>Client key/certificate (client.key/client.crt)</li></ul><p>The data being used for these keys (country, organisation, etc.) can be modified. It doesn\u2019t make a real difference if you change these or not, but it does help recognizing the certificate. You could, optionally, require a certain certificate subject (not covered by this tutorial) for added security.</p><p>Open up /etc/openvpn/easy-rsa/vars and look for the following lines:</p><blockquote><p>export KEY_COUNTRY=\u201dUS\u201d<br>\nexport KEY_PROVINCE=\u201dCA\u201d<br>\nexport KEY_CITY=\u201dSanFrancisco\u201d<br>\nexport KEY_ORG=\u201dFort-Funston\u201d<br>\nexport KEY_EMAIL=mail@host.domain<br>\nexport KEY_CN=changeme<br>\nexport KEY_NAME=changeme<br>\nexport KEY_OU=changeme</p></blockquote><p>You should change these all to reflect your situation. You can remove the duplicate KEY_EMAIL export, as the second one overwrites the first one anyway. You can safely ignore the PK11 variables listed below the above ones in the file.</p><p>To be sure we have proper permissions, let\u2019s change the group of the easy-rsa directory to sudo:</p><blockquote><p>sudo chown -R root:sudo .</p></blockquote><p>And set group write permissions, so members of the sudo group can write to it:</p><blockquote><p>sudo chmod g+w .</p></blockquote><p>With these permissions set, we can generate certificates.</p><p>First, execute the vars file you\u2019ve just edited to all the vars are available in the environment:</p><blockquote><p>source ./vars</p></blockquote><p>Next, clean all the keys:</p><blockquote><p>./clean-all</p></blockquote><p>Generate the Diffie-Hellman parameters for the server site TLS/SSL:</p><blockquote><p>./build-dh</p></blockquote><p>Generate the root key and certificate:</p><blockquote><p>./pkitool \u2013initca</p></blockquote><p>And finally, generate the server private key and certificate:</p><blockquote><p>./pkitool \u2013server server</p></blockquote><p>Now that all the keys are generated, let\u2019s build a TLS key and put all keys into place. Go to the \u2018keys\u2019 directory inside the \u2018easy-rsa\u2019 directory where you currently are:</p><blockquote><p>cd keys/</p></blockquote><p>And generate the TLS key:</p><blockquote><p>openvpn \u2013genkey \u2013secret ta.key</p></blockquote><p>Finally, copy all these keys to the openvpn directory:</p><blockquote><p>sudo cp server.crt server.key ca.crt dh1024.pem ta.key ../../</p></blockquote><p>And we\u2019re done with the server-side keys! Final keys to generate now, are the client-side keys. Make sure you are in /etc/openvpn/easy-rsa/vars again and edit the variables to reflect your client. Otherwise you get an error when generating the certificate because it\u2019s not unique.</p><p>Initialize the new environment variables:</p><blockquote><p>source ./vars</p></blockquote><p>And generate the client-side keys:</p><blockquote><p>./pkitool client</p></blockquote><p>That\u2019s it! Keys are ready.</p><p>Finally, set the proper ownership to the \u2018keys\u2019 directory, as it\u2019s currently owned by your user:</p><blockquote><p>sudo chown root:sudo keys</p></blockquote><p>Now, let\u2019s configure OpenVPN!</p><h2>Configuring OpenVPN</h2><p>OpenVPN has a lot of configuration options. I\u2019m going to cover a basic configuration which uses a tap interface.</p><p>The server configuration file is /etc/openvpn/server.conf. The default configuration file has a lot of comments in it, so it\u2019s a good starting point to discover more about the configuration of OpenVPN. I\u2019m going to give you the configuration that I\u2019ve tested:</p><blockquote><p>local&nbsp;192.0.2.15 # Server IP address through which you connect, replace this with yours<br>\nport 1194 # Port the server runs on (default)<br>\nproto udp # Protocol to use (default)<br>\ndev tap<br>\nca ca.crt # Root certificate<br>\ncert server.crt # Server certificate<br>\nkey server.key&nbsp; # Server key file<br>\ndh dh1024.pem # DH file<br>\nserver 10.8.0.0 255.255.255.0<br>\nifconfig-pool-persist ipp.txt # File that keeps track of IP leases<br>\npush \u201credirect-gateway def1 bypass-dhcp\u201d # Push some options to the client<br>\nduplicate-cn<br>\nkeepalive 10 120 # When should we disconnect a client?<br>\ntls-auth ta.key 0<br>\ncomp-lzo # Enable compression<br>\nuser nobody # Run as user nobody<br>\ngroup nogroup # Run as group nobody<br>\npersist-key # Avoid trying to access unavailable resources after a restart<br>\npersist-tun # Avoid trying to access unavailable resources after a restart<br>\nstatus openvpn-status.log # Status log for active connections<br>\nlog-append&nbsp; openvpn.log # Append the OpenVPN log rather then starting with a new one every time you restart<br>\nverb 3 # Log verbosity level<br>\nmute 20 # Limit the number of repeating messages<br>\nscript-security 2 # Set the security level for the usage of external programs and scripts<br>\nlink-mtu 1648</p></blockquote><p>As you can see, I\u2019ve added some inline comments. It would be good to read these. I\u2019ll highlight the lines I would like to discuss in more detail, those are the most important options for you to know about.</p><blockquote><p>dev tap</p></blockquote><p>This line indicates we use a TAP tunnel, which is an ethernet tunnel rather than a routed IP tunnel. A TAP tunnel passes through all traffic rather than just HTTP and HTTPS. It\u2019s the more \u201ccomplete\u201d tunnel when compared to TUN.</p><blockquote><p>server 10.8.0.0 255.255.255.0</p></blockquote><p>Set the internal IP range for the server and the clients. The server will get the IP 10.8.0.1 and the client IP addresses will start at 10.8.0.2. Change this to your liking or when it conflicts with other ranges on any of your clients.</p><blockquote><p>duplicate-cn</p></blockquote><p>This line allows multiple connections with the same client certificates. Leave this out to disable this option. If you edit the vars file for every client certificate you generate, this option can safely be disabled.</p><blockquote><p>tls-auth ta.key 0</p></blockquote><p>Name of the TLS key file and the \u201cside\u201d of the TLS connection. Since the server is 0, the client should be 1. This should be configured in you OpenVPN client software.</p><blockquote><p>link-mtu 1648</p></blockquote><p>This is the MTU for the VPN connection. The MTU (Maximal Tranmission Unit) is the maximum size in bytes of the largest piece of data that the link can transport. I\u2019ve used this value because it worked for me. This will also need to be configured in your client. If you VPN doesn\u2019t work, check the logs for MTU errors.</p><p>Once the configuration file is in place, restart OpenVPN:</p><blockquote><p>sudo /etc/init.d/openvpn restart</p></blockquote><p>And you should be good! Final step is adding three firewall rules to allow traffic to pass through your server:</p><blockquote><p>sudo /sbin/iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE<br>\nsudo /sbin/iptables -A FORWARD -i eth0 -o tap0 -m state \u2013state RELATED,ESTABLISHED -j ACCEPT<br>\nsudo /sbin/iptables -A FORWARD -i tap0 -o eth0 -j ACCEPT</p></blockquote><p>You should replace \u2018eth0\u2019 with the device name of your ethernet device. On most OpenVZ VPS this is venet0.</p><p>What these lines do, is the following (in order):</p><ol><li>Allow transparent NAT traffic over eth0</li><li>Allow packets to be forwarded from eth0 to tap0 with certain connection states</li><li>Allow packets to be forwarded from tap0 to eth0 regardless of the connection state</li></ol><p>Now, with the server up and running and your firewall configured, you need to configure your client. I will cover some clients in next week\u2019s tutorial (it was too much to combine it all in here), but here\u2019s something to get you started on your own. To connect with a client, you need to:</p><ol><li>Have the client.crt, client.key, ca.crt and ta.key on your client</li><li>Enable LZO compression</li><li>Enable TAP</li><li>Set the link MTU to 1648</li><li>Set the TLS \u201cside\u201d to 1</li></ol><p>If you\u2019ve done that on you client, you should be able to connect!</p><h2>Final notes</h2><p>As you may have noticed, setting up OpenVPN isn\u2019t hard but it isn\u2019t very easy either. There\u2019s a lot of steps to take, a lot of options available and a lot that can go wrong. I\u2019ve tried to keep this guide concise and limited for the sake of clarity. If there is a clear demand for more explanation on certain subjects, please let me know. I\u2019ll add more explanation/write a more detailed guide on a certain subject in that case.</p><p><span style=\"text-decoration: underline;\">Up next week:</span> Getting started with OpenVPN (client)! <em>Next week\u2019s tutorial may be a bit later due to my supposed bachelor party. So if it\u2019s not here on Saturday, it will be on Tuesday (latest).</em></p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fgetting-started-with-openvpn-server%2F&amp;t=Getting%20started%20with%20OpenVPN%20%28server%29\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Getting%20started%20with%20OpenVPN%20%28server%29&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fgetting-started-with-openvpn-server%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fgetting-started-with-openvpn-server%2F&amp;title=Getting%20started%20with%20OpenVPN%20%28server%29&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/centos-6-end-of-life-is-coming-upgrade-to-a-new-centos-7-vps-now/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/centos-6-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/best-web-hosting-control-panels-after-the-cpanel-price-hike/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Best Web Hosting Control Panels after the cPanel Price Hike\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Best Web Hosting Control Panels after the cPanel Price Hike</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-plex-media-server-on-your-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Set Up Plex Media Server on Your Cheap VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/how-to-set-up-plex-media-server-on-vps-2-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Set Up Plex Media Server on Your Cheap VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-create-a-dns-server-on-debian-stretch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Create a DNS Server On Debian Stretch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Create a DNS Server On Debian Stretch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}