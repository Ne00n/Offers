{"id": "3953", "post": "<div class=\"post-3953 post type-post status-publish format-standard hentry category-tutorials tag-tutorials-2\" id=\"post-3953\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/encrypted-backups-with-duplicity/\" rel=\"bookmark\">Encrypted backups with duplicity</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> May 25, 2013 @ 9:39 am, by Maarten Kossen</div><div class=\"storycontent tablelook\"><table cellspacing=\"0\" cellpadding=\"0\" align=\"center\"><tbody><tr><td><a href=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" loading=\"lazy\" class=\"size-full wp-image-3957 aligncenter litespeed-loaded\" alt=\"lowendtutorial\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" width=\"271\" height=\"70\" data-was-processed=\"true\"></a></td></tr></tbody></table><p>Backups are about the most important thing about managing a server. If anything happens to your server, like data loss, a customer making a mistake (and accidentally removing data) or a full-blown server crash, you\u2019ll be happy to have backups. There\u2019s plenty of people that don\u2019t make them though. For some it may feel to complicated, for some it may feel like to much work and others may just not care.</p><p><span id=\"more-3953\"></span></p><p>I\u2019m going to show you how to easily make (and restore) encrypted incremental backups with Duplicity. Duplicity is a tool that uses tar, librsync and GnuPG to backup up data. All your data is encrypted, so nobody else can look at it (except when they have your GnuPG private key and password). While Duplicity is _officially_ still in beta, it\u2019s been considered stable enough by many (including me) for the past couple of years. In addition to that, it powers the default backup tool in Ubuntu (Deja Dup, which is built on Duplicity). Duplicity support the following protocols for connecting to a remote filesystem: ssh/scp, local file access, rsync, ftp, HSI, WebDAV, Tahoe-LAFS, and Amazon S3.</p><p>In this guide, I\u2019m going to assume we\u2019re backup up to a backup server using SFTP. All examples should work on both Ubuntu (or other Debian-bases distributions) and CentOS (or RHEL/Fedora).</p><p># Installing duplicity</p><p>First things first. Let\u2019s install duplicity. It\u2019s simple enough. On Ubuntu:</p><blockquote><p>sudo apt-get install duplicity</p></blockquote><p>On CentOS (you need EPEL for this):</p><blockquote><p>yum install duplicity python-paramiko</p></blockquote><p>Done.</p><h2>Creating a GnuPG key</h2><p>Duplicity both encrypts and signs your backups with your GnuPG key. Your backups are encrypted for privacy and security and signed for detecting changes (and thus being able to do incremental backups). Creating a GnuPG key is pretty simple. You do need GnuPG installed, though. On Ubuntu the package is named \u2018gnupg\u2019 (sudo apt-get install gnupg) and on CentOS \u2018gnupg2\u2019 (yum install gnupg2). In my experience GnuPG is almost always present, even on minimal installations.</p><p>Let\u2019s get started and create our key. Run this as the user that\u2019s making your backups (usually root):</p><blockquote><p>gpg \u2013gen-key</p></blockquote><p>This will ask you several questions. It starts with the key type and size:</p><blockquote><p>What kind of key you want: \u2018RSA and RSA\u2019<br>\nWhat keysize you want: 4096</p></blockquote><p>The key default key type is fine and most secure (RSA with an RSA subkey). For key length, I always go for 4096 bits these days, as it\u2019s the most secure option.</p><blockquote><p>How long the key must be valid: 0 (infinity)<br>\nIf you really want a non-expiring key: Y</p></blockquote><p>Usually, I would not recommend a non-expiring key. However, if you want your backups to last, you\u2019re better off with this option. An expired GnuPG key cannot be used for encryption, just for decryption. So from the moment of expiration, all new backups would be encrypted and signed with a different key. This is really undesirable, because it will break the incremental chain and thus, history. The alternative would be re-encrypting and re-signing your backups every x years (for example) because your key has expired. If you have terabytes of backups, this is not something you want to do.</p><p>Let\u2019s go on with identification for the key. I usually give they key the name \u201cDuplicity Backup\u201d. That way you can always identify the proper key, but feel free to give it another name. The e-mail address is completely up to you as well, as is the comment. These name, e-mail address and comment won\u2019t be used for anything other than identifying your key in a list of keys. Confirm the information at the end.</p><blockquote><p>Real name: \u201cDuplicity Backup\u201d<br>\nEmail address: operations@example.net<br>\nComment: (none)<br>\nConfirmation: O for Okay</p></blockquote><p>Finally, it will ask you for a passphrase (twice). Pick a very secure on here, as (combined with your GnuPG private key) it is the gateway to your data:</p><blockquote><p>Passphrase: &lt;your very secure passphrase&gt;<br>\nRepeat passphrase: &lt;your very secure passphrase&gt;</p></blockquote><p>After that, GnuPG needs to generate random bytes and it needs entropy for that. On my desktop this was not an issue, but on an idling server it proofed challenging. Just run a lot of DD tests or do some heavy stuff in a different terminal and you should be fine. When done, GnuPG gives you information about the key you\u2019ve just created:</p><blockquote><p>gpg: /root/.gnupg/trustdb.gpg: trustdb created<br>\ngpg: key 1731EA9E marked as ultimately trusted<br>\npublic and secret key created and signed.</p><p>gpg: checking the trustdb<br>\ngpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model<br>\ngpg: depth: 0 valid: 1 signed: 0 trust: 0-, 0q, 0n, 0m, 0f, 1u<br>\npub 4096R/1731EA9E 2013-05-21<br>\nKey fingerprint = 867B 4675 2693 CA7C 34D9 E394 FDF1 0274 1731 EA9E<br>\nuid Duplicity Backup &lt;operations@example.net&gt;<br>\nsub 4096R/79FA3B1E 2013-05-21</p></blockquote><p>The key ID that it lists before \u2018marked as ultimately trusted\u2019 on the second like is very important. That\u2019s the public key ID and we will use it to tell Duplicity which key to use for encryption and signing. In this case its: 1731EA9E.</p><p># Creating backups</p><p>Now that we\u2019ve got our key ready, we can start making backups! What we\u2019re going to do is back up a folder of files to a remote filesystem, using SFTP, and then list the files to see what has happened. As an example, I\u2019m going to backup my mission-critical wallpaper collection.</p><p>From the directory which contains the folder that you are going to back up, run:</p><blockquote><p>duplicity \u2013encrypt-key=1731EA9E \u2013sign-key=1731EA9E mission-critical-wallpapers sftp://backupserver.example.net/mission-critical-wallpapers</p></blockquote><p>What we\u2019ve done here, is tell duplicity to use our recently-created key for encrypting (\u2013encrypt-key) and signing (\u2013sign-key) the backups. In addition to that, we\u2019ve told it which folder on the local filesystem to use (mission-critical-wallpapers) and where to put in on which remote filesystem (sftp://backupserver.example.net/mission-critical-wallpapers). The path on the remote filesystem is relative to your home directory on the remote filesystem. When executed, it starts running Duplicity and will ask you for your GnuPG key password twice (for both encryption and signing):</p><blockquote><p>Local and Remote metadata are synchronized, no sync needed.<br>\nLast full backup date: none<br>\nGnuPG passphrase:<br>\nGnuPG passphrase for signing key:<br>\nNo signatures found, switching to full backup.<br>\n\u2014\u2014\u2014\u2014\u2013[ Backup Statistics ]\u2014\u2014\u2014\u2014\u2013<br>\nStartTime 1369202758.42 (Wed May 22 08:05:58 2013)<br>\nEndTime 1369202758.82 (Wed May 22 08:05:58 2013)<br>\nElapsedTime 0.40 (0.40 seconds)<br>\nSourceFiles 10<br>\nSourceFileSize 6895171 (6.58 MB)<br>\nNewFiles 10<br>\nNewFileSize 6895171 (6.58 MB)<br>\nDeletedFiles 0<br>\nChangedFiles 0<br>\nChangedFileSize 0 (0 bytes)<br>\nChangedDeltaSize 0 (0 bytes)<br>\nDeltaEntries 10<br>\nRawDeltaSize 6891075 (6.57 MB)<br>\nTotalDestinationSizeChange 6809236 (6.49 MB)<br>\nErrors 0<br>\n\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014-</p></blockquote><p>Lucky for me, my collection of mission-critical wallpapers is not that large. However, if you have a lot to back up, now is the time to grab some coffee (and do something else while you\u2019re at it). The initial backup can take quite a while, but the incremental backups afterwards will be a lot faster. Duplicity doesn\u2019t display any progress, so after typing your password it just runs. To see some progress, go to the remote filesystem and \u2018watch du -sh\u2019 the target folder folder. This will show you how large the target folder is.</p><p>Incremental backups are pretty smart. Duplicity only backs up what has changed and keeps track of it. So you will always be able to restore a full and complete copy of your data, exactly the way it was the last time you\u2019ve backed it up (or another moment in time). So if you add one wallpaper to that folder, it will back up just that one wallpaper. When restoring the backup completely, it will include that one wallpaper as well. You can also choose to restore an older version of your backup, before that wallpaper was made. Let\u2019s add a wallpaper to the folder and run duplicity again:</p><blockquote><p>duplicity \u2013encrypt-key=1731EA9E \u2013sign-key=1731EA9E mission-critical-wallpapers sftp://user@backupserver.example.net/mission-critical-wallpapers</p></blockquote><p>The output is now different:</p><blockquote><p>Local and Remote metadata are synchronized, no sync needed.<br>\nLast full backup date: Wed May 22 08:05:50 2013<br>\nGnuPG passphrase:<br>\nGnuPG passphrase for signing key:<br>\n\u2014\u2014\u2014\u2014\u2013[ Backup Statistics ]\u2014\u2014\u2014\u2014\u2013<br>\nStartTime 1369202811.55 (Wed May 22 08:06:51 2013)<br>\nEndTime 1369202811.99 (Wed May 22 08:06:51 2013)<br>\nElapsedTime 0.44 (0.44 seconds)<br>\nSourceFiles 18<br>\nSourceFileSize 14414631 (13.7 MB)<br>\nNewFiles 9<br>\nNewFileSize 7523556 (7.18 MB)<br>\nDeletedFiles 0<br>\nChangedFiles 0<br>\nChangedFileSize 0 (0 bytes)<br>\nChangedDeltaSize 0 (0 bytes)<br>\nDeltaEntries 9<br>\nRawDeltaSize 7519460 (7.17 MB)<br>\nTotalDestinationSizeChange 7456505 (7.11 MB)<br>\nErrors 0<br>\n\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014-</p></blockquote><p>Compared to the statistics on the initial run, you now see an increased SourceFileSize. The NewFiles and NewFileSize gives an overview on what has changed. These statistics can be actually quite useful to see if you backup has succeeded.</p><p>Congratulations! You\u2019ve just made your first backup with Duplicity! Now let\u2019s restore it\u2026</p><h2>Restoring backups</h2><p>Now that we\u2019ve backed up our files they are safe, we are going to restore the backup to see if the backup has actually worked. Before we\u2019re going to restore them, let\u2019s have a look what is in the backup:</p><blockquote><p>duplicity list-current-files sftp://user@backupserver.example.net/mission-critical-wallpapers</p></blockquote><p>This produces a list of the files in the backup (the most recent version). It does this based solely on the signature files, so it doesn\u2019t have to download or access the complete backup. You\u2019ll get a list that looks like:</p><blockquote><p>Local and Remote metadata are synchronized, no sync needed.<br>\nLast full backup date: Wed May 22 08:05:50 2013<br>\nWed May 22 08:06:40 2013 .<br>\nWed May 22 08:04:13 2013 02140_romanbath_2560x1600.jpg<br>\nWed May 22 08:04:14 2013 02141_auroraborealis_2560x1600.jpg<br>\nWed May 22 08:04:13 2013 02142_lakechapalajaliscomexico_2560x1600.jpg<br>\nWed May 22 08:04:13 2013 02143_sonicboom_2560x1600.jpg<br>\nWed May 22 08:04:13 2013 02144_islate_2560x1600.jpg<br>\nWed May 22 08:04:13 2013 02145_powerfulsunrise_2560x1600.jpg<br>\nWed May 22 08:04:13 2013 02146_newyork_2560x1600.jpg<br>\nWed May 22 08:04:12 2013 02147_thefence_2560x1600.jpg<br>\nWed May 22 08:04:14 2013 02148_sunsetintuscanysaturdaymay23rd2009_2560x1600.jpg<br>\nWed May 22 08:06:40 2013 02330_morainelakepanorama_2560x1600.jpg<br>\nWed May 22 08:06:40 2013 02333_firstlight_2560x1600.jpg<br>\nWed May 22 08:06:40 2013 02334_portomoniz89s_2560x1600.jpg<br>\nWed May 22 08:06:40 2013 02335_alpsteinbeforerain_2560x1600.jpg<br>\nWed May 22 08:06:40 2013 02336_leavesatlynncanyonpark_2560x1600.jpg<br>\nWed May 22 08:06:40 2013 02337_seasonofillusions_1920x1200.jpg<br>\nWed May 22 08:06:40 2013 02338_yellowstonesunset_2560x1600.jpg<br>\nWed May 22 08:06:40 2013 02339_thetimeofsilence_2560x1600.jpg</p></blockquote><p>Now, that looks good! Let\u2019s restore these backups:</p><blockquote><p>duplicity restore sftp://user@backupserver.example.net/mission-critical-wallpapers restored-mission-critical-wallpapers</p></blockquote><p>Duplicity will now restore your backups to the local path you\u2019ve given. Once completed, it will give you a summary of the run:</p><blockquote><p>Local and Remote metadata are synchronized, no sync needed.<br>\nLast full backup date: Wed May 22 08:05:50 2013<br>\nGnuPG passphrase:</p></blockquote><p>And you\u2019re done!</p><h2>Final note</h2><p>I\u2019ve now shown you how to do a basic backup and restore with Duplicity. However, it has a lot more options than I\u2019ve just shown. In addition to that, you may want to automate your backups. I\u2019ll go into detail about that in a next article, as it\u2019s a subject on its own. For now, happy back-upping!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fencrypted-backups-with-duplicity%2F&amp;t=Encrypted%20backups%20with%20duplicity\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Encrypted%20backups%20with%20duplicity&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fencrypted-backups-with-duplicity%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fencrypted-backups-with-duplicity%2F&amp;title=Encrypted%20backups%20with%20duplicity&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/centos-6-end-of-life-is-coming-upgrade-to-a-new-centos-7-vps-now/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/centos-6-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/best-web-hosting-control-panels-after-the-cpanel-price-hike/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Best Web Hosting Control Panels after the cPanel Price Hike\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Best Web Hosting Control Panels after the cPanel Price Hike</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-plex-media-server-on-your-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Set Up Plex Media Server on Your Cheap VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/how-to-set-up-plex-media-server-on-vps-2-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Set Up Plex Media Server on Your Cheap VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-create-a-dns-server-on-debian-stretch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Create a DNS Server On Debian Stretch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Create a DNS Server On Debian Stretch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}