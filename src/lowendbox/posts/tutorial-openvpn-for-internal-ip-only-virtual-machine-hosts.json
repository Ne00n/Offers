{"id": "7128", "post": "<div class=\"post-7128 post type-post status-publish format-standard hentry category-tutorials tag-tutorial tag-tutorials-2\" id=\"post-7128\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/tutorial-openvpn-for-internal-ip-only-virtual-machine-hosts/\" rel=\"bookmark\">Tutorial \u2013 OpenVPN for internal-ip only virtual machine hosts</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \"> <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a>, <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \"> June 12, 2015 @ 1:00 pm, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center;\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNzEiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCAyNzEgNzAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNjZmQ0ZGIiLz48L3N2Zz4=\" loading=\"lazy\" class=\"alignnone size-full wp-image-3957\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" alt=\"lowendtutorial\" width=\"271\" height=\"70\"></p><p>Welcome to another tutorial! This time I will be showing you a neat trick to get OpenVPN working within a larger subnet used for an Ethernet bridge. Say what now? Let me explain.</p><p>I had the following idea in mind: get a dedicated server with a single IPv4. Make it a Xen host, create virtual servers with just an internal IP, and from there either proxy stuff to the outside world via dom0 or keep in private within a VPN in those cases I would just use it for testing. That last part turned out to be challenging initially, but had an interesting outcome.</p><p>I\u2019ll share my experiences with you here. I\u2019ve tested this on an Ubuntu host (in my case I\u2019ve used Ubuntu 15.04 with Xen 4.5), but it should work on other Debian-based systems as well. For VPN I\u2019ve used a (modified) version of Nyr\u2019s awesome <a href=\"https://github.com/Nyr/openvpn-install\">OpenVPN installer script</a>.</p><p><span id=\"more-7128\"></span></p><p>I\u2019m going to assume a host with virtualization working, so I\u2019m starting at the ethernet bridge configuration here.</p><p>In /etc/network/interfaces, add the following code:</p><blockquote><p>auto xen-intbr<br>\niface xen-intbr inet static<br>\npre-up brctl addbr xen-intbr<br>\npost-down brctl delbr xen-intbr<br>\naddress 10.0.0.1<br>\nnetmask 255.255.0.0<br>\nnetwork 10.0.0.0<br>\nbroadcast 10.0.255.255</p></blockquote><p>This code creates an ethernet interface called \u2018xen-intbr\u2019. The name is up to you, though I would use a descriptive name. The address range I\u2019ve used here in 10.0.0.0/16, which is quite a large range, but this makes it easiest to work with. The following two lines:</p><blockquote><p>pre-up brctl addbr xen-intbr<br>\npost-down brctl delbr xen-intbr</p></blockquote><p>Actually make the bridge a bridge, by using brctl to make the interface a bridge, and removing it later.</p><p>This is the actual bridge you can use for your virtual machines. You can configure any IP address from the 10.0.0.0/16 range on them, except for 10.0.0.1 (which is the gateway address) and 10.0.255.255 (which is the broadcast address).</p><p>To get the bridge running without a restart, run:</p><blockquote><p>sudo ifup xen-intbr</p></blockquote><p>Now, that\u2019s that. Next step is to get OpenVPN installed. We\u2019re going to be using Nyr\u2019s installer for this, but a modified version.</p><p>First, download the script:</p><blockquote><p>wget git.io/vpn \u2013no-check-certificate -O openvpn-install.sh</p></blockquote><p>Next, open the file and replace all occurrences of \u201810.8.0.0\u2019 with \u201810.0.255.0\u2019 and save the file. Now, run the file:</p><blockquote><p>sudo bash openvpn-install.sh</p></blockquote><p>This should ask you some questions. Answer them honestly, or karma will make sure this tutorial won\u2019t work.</p><p>Once that\u2019s been installed, open the /etc/openvpn/server.conf file and look for the following line:</p><blockquote><p>dev tun</p></blockquote><p>Change that to:</p><blockquote><p>dev tap</p></blockquote><p>This will make the VPN act like a true ethernet tunnel. Be sure to also reflect this change in the .openvpn file the installer spits out at the end of its run. Restart OpenVPN to activate this change:</p><blockquote><p>sudo service openvpn restart</p></blockquote><p>Following this, run this command:</p><blockquote><p>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</p></blockquote><p>Replace \u2018eth0\u2019 with the name of your primary network interface (or the one containing your actual external IPv4). This should ensure traffic over that interface will be able to reach other networks as well.</p><p>Now, if you\u2019re lucky, this should work. You may connect to the OpenVPN server and try to reach an existing (and powered on) virtual machine with an internal IP address from the OpenVPN client machine.</p><p>If you\u2019re unlucky (and I haven\u2019t been able to pin-point this difference in environments yet), you have to perform two more steps to get this working:</p><blockquote><p>sudo brctl addif xen-intbr tap0</p></blockquote><p>Replace \u2018tap0\u2019 with the name of your tap-device (use \u2018ifconfig | grep tap\u2019 to find yours). Next, make sure it\u2019s a promiscuous interface (meaning all traffic will go through the CPU):</p><blockquote><p>sudo ifconfig tap0 0.0.0.0 promisc up</p></blockquote><p>Again, replace \u2018tap0\u2019 with the name of your tap-device.</p><p>If you were unlucky, you should now be done as well!</p><p></p><p>Other than most tutorials, this one is just a trick I wanted to share with you as I wasn\u2019t able to find this documented on the internet myself. But consider the offering of dedicated servers in the EU are mostly limited to one IPv4 by default, the situation may come to you sooner than you might expect.</p><p>I hope you\u2019ve enjoyed this tutorial! Next one is due in two weeks!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Ftutorial-openvpn-for-internal-ip-only-virtual-machine-hosts%2F&amp;t=Tutorial%20-%20OpenVPN%20for%20internal-ip%20only%20virtual%20machine%20hosts\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Tutorial%20-%20OpenVPN%20for%20internal-ip%20only%20virtual%20machine%20hosts&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Ftutorial-openvpn-for-internal-ip-only-virtual-machine-hosts%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Ftutorial-openvpn-for-internal-ip-only-virtual-machine-hosts%2F&amp;title=Tutorial%20-%20OpenVPN%20for%20internal-ip%20only%20virtual%20machine%20hosts&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/managing-your-lowendempire-with-ansible-part-1/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Managing Your LowEndEmpire With Ansible, Part 1\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Managing Your LowEndEmpire With Ansible, Part 1</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/setup-a-dns-nameserver-using-nsd/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Setup a DNS Nameserver Using NSD\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Setup a DNS Nameserver Using NSD</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/keeping-a-logwatchful-eye-on-your-vps-with-logwatch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Keeping A (log)Watchful Eye on Your VPS With logwatch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/logwatch-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Keeping A (log)Watchful Eye on Your VPS With logwatch</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/nginx-vs-openlitespeed-vs-apache/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Nginx vs. OpenLiteSpeed vs. Apache\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/nginx-vs-openlitespeed-vs-apache-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Nginx vs. OpenLiteSpeed vs. Apache</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}