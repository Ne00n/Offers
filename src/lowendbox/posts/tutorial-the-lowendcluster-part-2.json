{"id": "6879", "post": "<div class=\"post-6879 post type-post status-publish format-standard hentry category-tutorials tag-tutorial\" id=\"post-6879\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/tutorial-the-lowendcluster-part-2/\" rel=\"bookmark\">Tutorial \u2013 The LowEndCluster \u2013 Part 2</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \"> <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a> <img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \"> May 3, 2015 @ 1:27 pm, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center;\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNzEiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCAyNzEgNzAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNjZmQ0ZGIiLz48L3N2Zz4=\" loading=\"lazy\" class=\"alignnone size-full wp-image-3957\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" alt=\"lowendtutorial\" width=\"271\" height=\"70\"></p><p>Two weeks have passed and it\u2019s time for the second part of the LowEndCluster tutorial series! This time around I\u2019m going to focus on setting up the web nodes, which we will later tie together with a shared filesystem in order to make them really redundant.</p><p>Last time I mentioned I\u2019d be using Apache for the web nodes. Even though I am a big Apache fanboy and I honestly believe there is a lot of use for it (plus I like the configuration better), for this tutorial I\u2019m swapping it for NGINX. NGINX is a little easier on memory, handles quite some more connections out of the box, and is more than enough for a cluster running WordPress.</p><p>So, the idea is to have these web nodes running NGINX as a front-end for PHP-FPM. These NGINX instances will eventually only be accepting connections from the load balancers, but right now we\u2019re going to keep them open to the world.</p><p>I\u2019m deliberately not exposing PHP-FPM to the load balancers as it <em>may </em>be a security risk. I\u2019m not going to go into those details right now, but you can read more about it <a href=\"https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-dont-trust-the-tutorials-check-your-configuration/\">here</a>. Bottom line is, we don\u2019t want people uploading files secretly containing PHP code. So, without investigation this any further, I\u2019m going to be safe rather than sorry.</p><p>Anyway, enough talking. On to the real work!</p><p><span id=\"more-6879\"></span></p><p><em>For clarity\u2019s sake: these steps should all be run on <span style=\"text-decoration: underline;\">both</span></em><em> web nodes!</em></p><p>So, let\u2019s go ahead and log on to the two servers you have reserved for web nodes. We\u2019re going to install a number of applications on them:</p><ul><li>NGINX</li><li>PHP5</li><li>PHP5 MySQL (works with MariaDB as well)</li><li>PHP5 FPM</li><li>PHP5 GD</li><li>And some other packages that come with it</li></ul><p>I\u2019m going to assume a recent Ubuntu or Debian-based system here. This tutorial may very well work for RHEL-based distributions as well, though the installation commands are different.</p><p>Let\u2019s install the packages by running this command:</p><blockquote><p>sudo apt-get install nginx php5 php5-fpm php5-gd php5-mysql</p></blockquote><p>This was the easy part. After having done this, you should be able to go to the IPv6 of your server and see a default NGINX page. If you don\u2019t, or if you had Apache still installed, there\u2019s some detective work up ahead, though I won\u2019t go into the details on that.</p><h2>NGINX</h2><p>Now, let\u2019s configure NGINX for your website. The configuration needs to be identical on both the web nodes, so it\u2019s advisable to try it on one server and then copy it to the other when it works.</p><p>Go to /etc/nginx/sites-available and create a file named YOURHOSTNAME.conf with the following contents:</p><blockquote><p># Upstream to abstract backend connection(s) for php<br>\nupstream php {<br>\nserver unix:/var/run/php5-fpm.sock;<br>\n}</p><p>server {<br>\nlisten [::]:80;</p><p>## Your website name goes here.<br>\nserver_name server.example.com;<br>\n## Your only path reference.<br>\nroot /home/username/public_html;<br>\n## This should be in your http block and if it is, it\u2019s not needed here.<br>\nindex index.php;</p><p>location = /favicon.ico {<br>\nlog_not_found off;<br>\naccess_log off;<br>\n}</p><p>location = /robots.txt {<br>\nallow all;<br>\nlog_not_found off;<br>\naccess_log off;<br>\n}</p><p># Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).<br>\n# Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)<br>\nlocation ~ /\\. {<br>\ndeny all;<br>\n}</p><p># Deny access to any files with a .php extension in the uploads directory<br>\n# Works in sub-directory installs and also in multisite network<br>\n# Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)<br>\nlocation ~* /(?:uploads|files)/.*\\.php$ {<br>\ndeny all;<br>\n}</p><p>location / {<br>\n# This is cool because no php is touched for static content.<br>\n# include the \u201c?$args\u201d part so non-default permalinks doesn\u2019t break when using query string<br>\ntry_files $uri $uri/ /index.php?$args;<br>\n}</p><p># Directives to send expires headers and turn off 404 error logging.<br>\nlocation ~* ^.+\\.(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {<br>\naccess_log off; log_not_found off; expires max;<br>\n}</p><p># Pass all .php files onto a php-fpm/php-fcgi server.<br>\nlocation ~ [^/]\\.php(/|$) {<br>\nfastcgi_split_path_info ^(.+?\\.php)(/.*)$;<br>\nif (!-f $document_root$fastcgi_script_name) {<br>\nreturn 404;<br>\n}<br>\n# This is a robust solution for path info security issue and works with \u201ccgi.fix_pathinfo = 1\u201d in /etc/php.ini (default)</p><p>include fastcgi_params;<br>\nfastcgi_index index.php;<br>\n# fastcgi_intercept_errors on;<br>\nfastcgi_pass php;<br>\n}<br>\n}</p></blockquote><p>That\u2019s a long file and I\u2019m not going to go into every single line. There are some that I\u2019m going to discuss, though.</p><blockquote><p>listen [::]:80;</p></blockquote><p>This lines tells NGINX to listen to connection on port 80 on IPv6. The line for IPv4 is similar, just without the \u2018[::]:\u2019. I\u2019ve let that line out as we\u2019re not going to listen for IPv4 connections. You could, of course, do so on one of your NAT ports. That\u2019s outside the scope of this tutorial, though.</p><blockquote><p>server_name server.example.com;</p></blockquote><p>Please replace the server name with your actual server name, or the domain name that is linked to your server\u2019s IP address. This will ensure NGINX will use the right config file when trying to access your site. I may move away from this later on, but right now let\u2019s stick to this for easiness sake.</p><blockquote><p>root /home/username/public_html;</p></blockquote><p>You may change this to a location that\u2019s suitable to you. Eventually, we will be changing this to the path of our cluster filesystem. Make sure this directory exists, for now, and is owned by \u2018www-data\u2019. (You can change the owned by running \u2018chmod -R www-data. /home/username/public_html\u2019.)</p><p>That\u2019s all I wanted to discuss for this config file. Other parts are documented, so feel free to read up on that to get some more information on those specific parts.</p><p>Let\u2019s now enable this site:</p><blockquote><p>ln -s /etc/nginx/sites-available/hostname.conf /etc/nginx/sites-enabled/hostname.conf</p></blockquote><p>We\u2019ve just added a symlink to the sites-enabled directory, so NGINX will pick up on that after restarting it and start serving the site:</p><blockquote><p>sudo service nginx restart</p></blockquote><p>And NGINX should be all fine and happy.</p><h2>Installing WordPress</h2><p>This step is currently optional, but does get you closer to a working product, <em>and</em> it may save you time later on (I will refer back here later anyway). You can install WordPress on one node, and then copy it to the other node. WordPress handles domain names rather stupidly. Long story short: while installing WordPress you select a domain name for that installation and that\u2019s what WordPress will stick to (and redirect to) unless told otherwise. This means that if you install WordPress on web node A and use that node\u2019s hostname as a domain name, it will redirect back to that domain name when you access it from web node B. In the end, this will not be a problem, as WordPress will use the domain name we will point to the load balancer.</p><p>My advice would be this: temporarily map your desired domain name to one of your web nodes, install WordPress on that one, and then copy the installation to the other node. This will give you a working WordPress installation and an easy starting point for the other steps.</p><p>So, installing WordPress. It\u2019s actually dead simple. From the server\u2019s root directory I\u2019ve mentioned before, run the following command:</p><blockquote><p>&nbsp;wget https://wordpress.org/latest.tar.gz</p></blockquote><p>Now, extract WordPress:</p><blockquote><p>tar xvzf latest.tar.gz \u2013strip-components=1</p></blockquote><p>I\u2019ve used \u2018\u2013strip-components=1\u2019 to prevent tar from putting it all inside the \u2018wordpress\u2019 directory rather than in your document root. Now, fix the ownership of the files:</p><blockquote><p>chown -R www-data. *</p></blockquote><p>And open up your browser to start the WordPress installation!</p><p>The first step of the installation will be just fine, until you need a database username and password. Head up to your DB master server, log in as root (\u2018mysql -u root -p\u2019) and run the following commands:</p><blockquote><p>CREATE DATABASE wordpress;<br>\nGRANT ALL PRIVILEGES ON wordpress.* TO \u201cwordpress\u201d@\u201d%\u201d IDENTIFIED BY \u201cpassword\u201d;<br>\nFLUSH PRIVILEGES;</p></blockquote><p>This creates a database named \u2018wordpress\u2019 and a user named \u2018wordpress\u2019. The user may log in from any location. You could limit that by the IP addresses of your web nodes, of course. A better approach would be to do that with iptables rather than MySQL\u2019s system.</p><p>With these details, head back to the WordPress installation.</p><p>Now, here\u2019s the thing\u2026 WordPress is not only a bit of a pain with domain names, it also doesn\u2019t seem to handle IPv6 database addresses very nicely. So, when giving the WordPress installer the address of your database master, be sure to use the hostname as that does work.</p><p>Now, if all went well, you should have a fully working copy of WordPress backed up by two database servers. Even though there is no automatic failover yet, it does give you a proper backup and an easy switch in case of something going wrong.</p><hr><p>That\u2019s it for this time! I\u2019ve yet to see what we\u2019re going to do next time: the load balancers or the file system. This depends on how well my filesystem research goes.</p><p>I hope you\u2019ve enjoyed this part and I look forward to getting your feedback!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Ftutorial-the-lowendcluster-part-2%2F&amp;t=Tutorial%20-%20The%20LowEndCluster%20-%20Part%202\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Tutorial%20-%20The%20LowEndCluster%20-%20Part%202&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Ftutorial-the-lowendcluster-part-2%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Ftutorial-the-lowendcluster-part-2%2F&amp;title=Tutorial%20-%20The%20LowEndCluster%20-%20Part%202&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/managing-your-lowendempire-with-ansible-part-1/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Managing Your LowEndEmpire With Ansible, Part 1\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Managing Your LowEndEmpire With Ansible, Part 1</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/setup-a-dns-nameserver-using-nsd/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Setup a DNS Nameserver Using NSD\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Setup a DNS Nameserver Using NSD</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/keeping-a-logwatchful-eye-on-your-vps-with-logwatch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Keeping A (log)Watchful Eye on Your VPS With logwatch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/logwatch-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Keeping A (log)Watchful Eye on Your VPS With logwatch</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/nginx-vs-openlitespeed-vs-apache/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Nginx vs. OpenLiteSpeed vs. Apache\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/nginx-vs-openlitespeed-vs-apache-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Nginx vs. OpenLiteSpeed vs. Apache</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}