{"id": "4052", "post": "<div class=\"post-4052 post type-post status-publish format-standard hentry category-tutorials tag-tutorials-2\" id=\"post-4052\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/automated-encrypted-backups-with-duplicity/\" rel=\"bookmark\">Automated encrypted backups with Duplicity</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> July 6, 2013 @ 10:45 am, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center\"><a href=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" loading=\"lazy\" class=\"alignnone size-full wp-image-3957 litespeed-loaded\" alt=\"lowendtutorial\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" width=\"271\" height=\"70\" data-was-processed=\"true\"></a></p><p>A couple of weeks ago, I wrote a tutorial on <a href=\"https://lowendbox.com/blog/encrypted-backups-with-duplicity/\">how to use duplicity</a> to make encrypted, incremental backups over various available protocols. The process was a manual one, though, and would always require you to type the actual command and wait for the run to finish. It also had you manually keep track of what you did back up and what you didn\u2019t back up. It was basically a nice and easy way to back up several folders, more or less archiving them in case you ever need them again.</p><p>This week I\u2019m going to share a script with you that I\u2019ve used for a quite some time. It is based upon a script I found over at <a href=\"https://forum.linode.com/viewtopic.php?p=14875#14875\">the Linode forums</a> which was written to backup to Amazon S3. All I\u2019ve done is strip some of the unnecessary stuff intended for S3 and changed some of the includes/excludes. The credits for the script thus goes to the original author. I\u2019m going to explain the script to you, though, and let you know how you can tweak it to suit your needs.</p><p><span id=\"more-4052\"></span></p><p>There are several things you need for the script to work:</p><ol><li>A GnuPG key (see my previous tutorial on how to generate one)</li><li>The password of your GnuPG key (you should know this)</li><li>The public key ID of your GnuPG key (see my previous tutorial)</li><li>A backup server accessible over SSH/SFTP</li><li>Duplicity installed (see my previous tutorial)</li></ol><p>I would really recommend using a <em>dedicated</em> GnuPG key for this script, meaning you don\u2019t use the GnuPG key you use for this script for anything else. So when you\u2019ve gathered all that, let\u2019s get started with the script!</p><h1>The Script</h1><p>This is the full script. It may look long or complicated right now, but I\u2019m going to go through it line by line. The script will work on various Linux distributions. I\u2019ve tested in on Ubuntu and CentOS.</p><blockquote><p>#!/bin/bash</p><p>trace () {<br>\nstamp=`date +%Y-%m-%d_%H:%M:%S`<br>\necho \u201c$stamp: $*\u201d &gt;&gt; /var/log/backup.log<br>\n}</p><p># Export your GnuPG passphrase to an ENV variable so you don\u2019t have to type it every time<br>\nexport PASSPHRASE=&lt;GnuPG passphrase&gt;</p><p># Identifier for your GnuPG key<br>\nGPG_KEY=&lt;GnuPG key identifier&gt;</p><p># Backups older than this will be removed<br>\nOLDER_THAN=\u201d6M\u201d</p><p># The source of your backup, often a local directory<br>\nSOURCE=/</p><p># The destination (relative to the home directory of the user you\u2019re logging in as)<br>\nDEST=\u201dsftp://&lt;path&gt;\u201d</p><p># Check if a full backup is necessary<br>\nFULL=<br>\nif [ $(date +%d) -eq 1 ]; then<br>\nFULL=full<br>\nfi;</p><p>trace \u201cBackup for local filesystem started\u201d</p><p>trace \u201c\u2026 removing old backups\u201d</p><p># Comment this line (and the one above to keep the log clean) to disable backup removal<br>\nduplicity remove-older-than ${OLDER_THAN} ${DEST} &gt;&gt; /var/log/backup.log 2&gt;&amp;1</p><p>trace \u201c\u2026 backing up filesystem\u201d</p><p># Full backup run<br>\nduplicity \\<br>\n${FULL} \\<br>\n\u2013encrypt-key=${GPG_KEY} \\<br>\n\u2013sign-key=${GPG_KEY} \\<br>\n\u2013include=/etc \\<br>\n\u2013include=/home \\<br>\n\u2013include=/root \\<br>\n\u2013exclude=/var/tmp \\<br>\n\u2013include=/var \\<br>\n\u2013exclude=/** \\<br>\n${SOURCE} ${DEST} &gt;&gt; /var/log/backup.log 2&gt;&amp;1</p><p># And we\u2019re done<br>\ntrace \u201cBackup for local filesystem complete\u201d<br>\ntrace \u201c\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u201d</p><p># Reset the ENV variable<br>\nexport PASSPHRASE=</p></blockquote><p>It\u2019s a bash script, meaning there\u2019s little requirements but a recent shell. If you\u2019re not running a distribution\u2019s release that\u2019s older than five years, you should definitely be fine. The first line indicates that it\u2019s a bash script:</p><blockquote><p>#!/bin/bash</p></blockquote><p>The next line creates a function called \u2018trace\u2019. This function enables easy logging to a log file. It prepends every log line with a timestamp. The log file is in /var/log and it\u2019s called \u2018backup.log\u2019. This function is used several times in the script, as you will notice.</p><blockquote><p>trace () {<br>\nstamp=`date +%Y-%m-%d_%H:%M:%S`<br>\necho \u201c$stamp: $*\u201d &gt;&gt; /var/log/backup.log<br>\n}</p></blockquote><p>The next line exports your GnuPG passphrase as an environment variable, meaning it\u2019s available to every application that runs under the same user as the script. We do this to make sure duplicity doesn\u2019t ask for a password when it runs, enabling you to run this with cron (I\u2019ll show you that in a bit).</p><blockquote><p># Export your GnuPG passphrase to an ENV variable so you don\u2019t have to type it every time<br>\nexport PASSPHRASE=&lt;GnuPG passphrase&gt;</p></blockquote><p>Not to worry, we\u2019ll reset environment variable when the script is done, so it\u2019ll be out of the environment.</p><p>Next, we\u2019ll assign your GnuPG key ID to a variable (this is the key duplicity will use for signing and encryption):</p><blockquote><p># Identifier for your GnuPG key<br>\nGPG_KEY=&lt;GnuPG key identifier&gt;</p></blockquote><p>We set the threshold for backup removal (I\u2019ll get back to this a couple of lines down) to 6 months. Feel free to change it to suit your needs:</p><blockquote><p># Backups older than this will be removed<br>\nOLDER_THAN=\u201d6M\u201d</p></blockquote><p>Set the source of the backup, in this case the root directory of your server:</p><blockquote><p># The source of your backup, often a local directory<br>\nSOURCE=/</p></blockquote><p>And the destination, which is a path relative to the home directory of the user you\u2019re logging in as on the remote server:</p><blockquote><p># The destination (relative to the home directory of the user you\u2019re logging in as)<br>\nDEST=\u201dsftp://backups.example.net/server1backups\u201d</p></blockquote><p>And with the final variable we\u2019ll determine whether we need a full backup or not:</p><blockquote><p># Check if a full backup is necessary<br>\nFULL=<br>\nif [ $(date +%d) -eq 1 ]; then<br>\nFULL=full<br>\nfi;</p></blockquote><p>What the above does, is set the FULL variable to \u2018full\u2019 when it\u2019s the first day of the month. This variable is used when creating the actual backup. If it\u2019s set to \u2018full\u2019, duplicity makes a complete backup. Otherwise, it does an incremental backup. Leaving it like this means you get a full backup every first day of the month and incremental backups to that one on all the other days. You could also skip the three lines that set FULL to \u2018full\u2019 to never make a full backup but the first time and then just have incremental backups from that point on.</p><p>After having set all variables, the script starts by adding information to the log file:</p><blockquote><p>trace \u201cBackup for local filesystem started\u201d</p><p>trace \u201c\u2026 removing old backups\u201d</p></blockquote><p>This calls the trace function with the quoted text as an argument. That text is thne appended to the log.</p><p>Next, it\u2019s removal time:</p><blockquote><p># Comment this line (and the one above to keep the log clean) to disable backup removal<br>\nduplicity remove-older-than ${OLDER_THAN} ${DEST} &gt;&gt; /var/log/backup.log 2&gt;&amp;1</p></blockquote><p>Remember above, when we set the OLDER_THAN variable? This is where it is used. This command uses standard duplicity functionality to remove backups older than a number of X, where X can be months or weeks or even years. It does so at the destination you pass to it. If you do not want old backups to be removed, comment this line like this:</p><blockquote><p># Comment this line (and the one above to keep the log clean) to disable backup removal<br>\n# duplicity remove-older-than ${OLDER_THAN} ${DEST} &gt;&gt; /var/log/backup.log 2&gt;&amp;1</p></blockquote><p>And it will skip the removal of backups.</p><p>Now it\u2019s time for the actual backup process:</p><blockquote><p>trace \u201c\u2026 backing up filesystem\u201d</p><p># Full backup run<br>\nduplicity \\<br>\n${FULL} \\<br>\n\u2013encrypt-key=${GPG_KEY} \\<br>\n\u2013sign-key=${GPG_KEY} \\<br>\n\u2013include=/etc \\<br>\n\u2013include=/home \\<br>\n\u2013include=/root \\<br>\n\u2013exclude=/var/tmp \\<br>\n\u2013include=/var \\<br>\n\u2013exclude=/** \\<br>\n${SOURCE} ${DEST} &gt;&gt; /var/log/backup.log 2&gt;&amp;1</p></blockquote><p>It starts with a trace to indicate the actual backup has started. Next, it\u2019s on to the duplicity command. This is basically a very standard duplicity command but with a few additional parameters to include and exclude certain paths. The following line adds the value of the FULL variable to the command, which can be empty or \u2018full\u2019. In the case of \u2018full\u2019, duplicity does a full backup. Otherwise, it does an incremental one.</p><blockquote><p>${FULL} \\</p></blockquote><p>The encrypt-key and sign-key parameters use the GPG_KEY you\u2019ve set above. These are used to encrypt and sign the data.</p><p>The following couple of lines include and exclude several directories. The backslash (\\) at the end is use to indicate the command continues on a new line.</p><blockquote><p>\u2013include=/etc \\<br>\n\u2013include=/home \\<br>\n\u2013include=/root \\<br>\n\u2013exclude=/var/tmp \\<br>\n\u2013include=/var \\<br>\n\u2013exclude=/** \\</p></blockquote><p>What we do here, is include the etc, home and root directories. We then exclude /var/temp but include var. With \u2013exclude=/** we exclude everything else.</p><p>A couple of things: if you want to exclude a subdirectory of a directory you are including, you have to do it before including the directory the subdirectory is in. Otherwise it will back it up anyway. The same logic is applied the other way around: if you want to include a subdirectory of a directory you are excluding, you have to do it before excluding the directory the subdirectory is in. You also have to include everything you do want to back up before you are excluding everything else (\u2013exclude=/**). A different approach could be that you exclude a couple of directories like /tmp and /var/tmp (or even /var/cache) and then just include everything else (\u2013include=/**) . That would look like this:</p><blockquote><p>\u2013include=/tmp/secretfiles \\<br>\n\u2013exclude=/tmp \\<br>\n\u2013exclude=/var/cache \\<br>\n\u2013exclude=/var/tmp \\<br>\n\u2013include=/** \\</p></blockquote><p>The above includes everything except /tmp (it does include /tmp/secretfiles), /var/cache and /var/tmp.</p><p>Feel free to tweak the includes and excludes to suit your needs and be sure to check the result of the backup before you go to sleep ;-) The log file in /var/log/backup can help you with that.</p><p>The backup command ends with:</p><blockquote><p>${SOURCE} ${DEST} &gt;&gt; /var/log/backup.log 2&gt;&amp;1</p></blockquote><p>Which uses the SOURCE and DEST variables defined before as the source and destination for the duplicity command. It then outputs everything that comes from the command to the log file.</p><p>Finally, we end the backup script by writing something to the log and resetting the ENV variable with your GnuPG passphrase:</p><blockquote><p># And we\u2019re done<br>\ntrace \u201cBackup for local filesystem complete\u201d<br>\ntrace \u201c\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u201d</p><p># Reset the ENV variable<br>\nexport PASSPHRASE=</p></blockquote><p>After having done this, you GnuPG passphrase is no longer \u201cout there\u201d.</p><p>So, that was the script! Not all that hard if you think about it. But let\u2019s get it to run automatically!</p><h1>Getting it up and running</h1><p>Now we\u2019ve got the script all finished, let\u2019s add it to cron. Cron is a time-based job scheduler. You can let it run whatever command you want at whatever time (or time interval) you want. We\u2019re going to make this backup run every night at 01.00 (1 AM).</p><p>First, make sure the file is on the server. I always prefer to put these in /opt, but in this case /root is fine as well. Since the script contains the password for the GnuPG key, it\u2019s better to not have it visible to other users. /root is protected from outsiders by default, so I\u2019m going to use that in my example. Upload the script to /root and name it \u2018duplicity-backup\u2019 (without an extension).</p><p>Then, on either CentOS or Ubuntu, run (only use sudo if you\u2019re not logged in a root):</p><blockquote><p>(sudo) crontab -e</p></blockquote><p>This will open up a text editor with the crontab for root. Crontab contains the lines of the jobs cron has to execute. There are other ways to add cron jobs, but for now this is easiest. Add the following line at the end of the file:</p><blockquote><p>0 1 * * *&nbsp; /root/duplicity-backup</p></blockquote><p>The first five characters are to indicate when the job should be run. The first number is the minute (0), the second number is the hour (1), the third the day of the month (* for any), the fourth the month (* for any) and the fifth the year (* for any). It then ends with the command to run. This job will thus run any year, in any month, on any day at 01.00 (1 AM). Now save the file and you\u2019re all set!</p><p>From now on, your backups should work. It would be good to check it the first couple of days, see if it all runs well before relying on them.</p><h1>Final notes</h1><p>There are other ways to handle backups. For instance, you could make a python script that does the above and more (like dump databases, package certain files). Using duplicity, though, is something that I can really recommend for whatever language you decide to write your backup script in. I can also recommend to backup the GnuPG key to a secure location (a USB stick in a vault or something), as that key is <em>the</em> key to your backups.</p><p>Happy back-upping!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fautomated-encrypted-backups-with-duplicity%2F&amp;t=Automated%20encrypted%20backups%20with%20Duplicity\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Automated%20encrypted%20backups%20with%20Duplicity&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fautomated-encrypted-backups-with-duplicity%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fautomated-encrypted-backups-with-duplicity%2F&amp;title=Automated%20encrypted%20backups%20with%20Duplicity&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/centos-6-end-of-life-is-coming-upgrade-to-a-new-centos-7-vps-now/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/centos-6-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/best-web-hosting-control-panels-after-the-cpanel-price-hike/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Best Web Hosting Control Panels after the cPanel Price Hike\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Best Web Hosting Control Panels after the cPanel Price Hike</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-plex-media-server-on-your-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Set Up Plex Media Server on Your Cheap VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/how-to-set-up-plex-media-server-on-vps-2-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Set Up Plex Media Server on Your Cheap VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-create-a-dns-server-on-debian-stretch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Create a DNS Server On Debian Stretch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Create a DNS Server On Debian Stretch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}