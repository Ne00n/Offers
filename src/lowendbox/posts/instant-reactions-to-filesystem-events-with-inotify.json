{"id": "24102", "post": "<div class=\"post-24102 post type-post status-publish format-standard hentry category-tutorials tag-automation tag-filesystem tag-inotify tag-linux tag-python tag-sysadmin\" id=\"post-24102\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/instant-reactions-to-filesystem-events-with-inotify/\" rel=\"bookmark\">Instant Reactions to Filesystem Events with inotify</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/automation/\" rel=\"tag\">automation</a>, <a href=\"https://lowendbox.com/tag/filesystem/\" rel=\"tag\">filesystem</a>, <a href=\"https://lowendbox.com/tag/inotify/\" rel=\"tag\">inotify</a>, <a href=\"https://lowendbox.com/tag/linux/\" rel=\"tag\">linux</a>, <a href=\"https://lowendbox.com/tag/python/\" rel=\"tag\">python</a>, <a href=\"https://lowendbox.com/tag/sysadmin/\" rel=\"tag\">sysadmin</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> May 20, 2021 @ 11:58 pm, by raindog308</div><div class=\"storycontent tablelook\"><p>The ability to run programs automatically is one of the great liberating powers of computers. In Unix, it\u2019s common for users to schedule jobs using cron or at (or with systemd, timers). But what if you want to run a job not based on a schedule but rather in response to an event?</p><p>Imagine you had a directory and whenever you put a file in that directory, you wanted it to be compressed and put in a backup directory. Or perhaps you have a \u201cshare\u201d directory where individuals can upload pictures and (after testing it if it\u2019s a picture), you automatically move them to your web directory and add them to your hosting. Or perhaps you have a complicated backup system and after kicking off, it places a flag file in a certain spot.</p><p>In the old days, people would write cron jobs that ran every minute to see if files existed, etc. These are crude, resource intensive, and often bug prone \u2013 for example, you have to guard against multiple copies of these frequently-running scripts executing at the same time.</p><p>With Linux, we can use <a href=\"https://en.wikipedia.org/wiki/Inotify\">inotify</a> (inode notifications), which react to filesystem changes at a very fine-grained level. Typically, you\u2019d create a daemon that sets up filesystem watches, runs in the background, and reacts to events by calling some code or firing off a script.</p><p>There are several ways of using inotify:</p><ul><li>If you\u2019re a kernel programmer, you can use the C API</li><li>There are two command-line programs (inotifywatch and inotifywait, part of the inotify-tools package in Debian). I find them not very useful. inotifywatch gathers statistics and inotifywait simply waits until filesystem events occur. inotifywait does have a daemon option but it\u2019s limited to logging events to a file.</li><li>Python has an inotify module, which is ideal for writing daemons.</li></ul><h1>Installing Python\u2019s inotify</h1><p>To install the module, we\u2019ll use pip. Install pip if you don\u2019t have it, and then install the inotify module:</p><pre>apt -y install python-pip\npip install inotify</pre><h1>Using Python\u2019s inotify</h1><p>Let\u2019s start with an example script so you get the feel of inotify. This script watches the directory /tmp/test and responds to file change events occurring there. First, setup the test:</p><pre>mkdir /tmp/test</pre><p><span id=\"more-24102\"></span></p><p>Now put the following in a file calleed test_inotify.py:</p><pre>#!/usr/bin/python\n\nimport inotify.adapters\n\ni = inotify.adapters.InotifyTree('/tmp/test')\n\nfor event in i.event_gen(yield_nones=False):\n  (_, type_names, path, filename) = event\n  print(\"PATH=[{}] FILENAME=[{}] EVENT_TYPES={}\".format( path, filename, type_names))</pre><p>Note: Because this is Python, be sure that the indented lines are indented with a single TAB character.</p><p>Now execute it:</p><pre>chmod 755 test_inotify.py\n./test_inotify.py</pre><p>Initially, nothing happens. Now open a second session to your VPS and execute some filesystem commands in that directory. You\u2019ll see events fire off as we create, populate, chmod, and delete files:</p><pre>touch /tmp/test/LowEndFile\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_CREATE']\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_OPEN']\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_ATTRIB']\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_CLOSE_WRITE']\n\necho 'put something in' &gt;&gt; /tmp/test/LowEndFile\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_OPEN']\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_MODIFY']\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_CLOSE_WRITE']\n\nchmod 600 /tmp/test/LowEndFile \nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_ATTRIB']\n\nrm /tmp/test/LowEndFile\nPATH=[/tmp/test] FILENAME=[LowEndFile] EVENT_TYPES=['IN_DELETE']</pre><p>You can hit control-C to stop test_inotify.py</p><p>As you can see, each change fires off one or more events. Some such as touching a file (creating it) fire off multiple events.</p><h1>Creating an inotify-based Daemon</h1><p>Let\u2019s do something more useful. We\u2019ll create a daemon that we can start at system time with systemd and have it react to events by calling a shell script. This is just a skeleton you can take and extend.</p><p>First, install Python\u2019s daemonize module:</p><pre>pip install daemonize</pre><p>In /usr/local/bin, create the following file as watchfs.py:</p><pre>#!/usr/bin/python\n\n# CONFIG\ndirectory_to_watch = '/tmp/test'\nscript_to_call = '/usr/local/bin/react.sh'\nevent_type_to_watch = 'IN_CREATE'\n# END CONFIG\n\nfrom daemonize import Daemonize\nimport inotify.adapters\nimport subprocess\n\npid = \"/run/watchfs.pid\"\n\ndef main():\n\ni = inotify.adapters.InotifyTree(directory_to_watch)\n\nfor event in i.event_gen(yield_nones=False):\n  (_, type_names, path, filename) = event\n  for event_type in type_names:\n    if event_type == event_type_to_watch: \n      subprocess.call([script_to_call,filename])\n\ndaemon = Daemonize(app=\"watchfs\",pid=pid, action=main)\ndaemon.start()</pre><p>Again, remember that each indented line must be indented with the right number of TABs.</p><p>If this looks like Greek to you, don\u2019t sweat it. The only lines you need to modify to customize it are in the lines between CONFIG and END_CONFIG:</p><ul><li>which directory you want to watch (directory_to_watch)</li><li>which script you want to call in response (/usr/local/bin/react.sh)</li><li>which filesystem event you want to watch for (here, IN_CREATE)</li></ul><pre>Now create this file in /usr/local/bin/react.sh:\n\n#!/bin/bash\n\nFILENAME=\"${1}\"\necho \"new file: $FILENAME\" &gt;&gt; /tmp/reaction.log</pre><p>All this script does is write the name of the file to /tmp/reaction.log. You can easily extend it to do whatever you want with the file name it receives.</p><p>Make both files executable:</p><pre>chmod 755 /usr/local/bin/watchfs.py\nchmod 755 /usr/local/bin/react.sh</pre><p>Let\u2019s set it up in systemd. Place the following file in /etc/systemd/system/watchfs.service:</p><pre>[Unit]\nDescription=watchfs\nAfter=network.target\n\n[Service]\nPIDFile=/run/watchfs.pid\nExecStart=/usr/local/bin/watchfs.py\n\n[Install]\nWantedBy=multi-user.target</pre><p>Now:</p><pre>systemctl daemon-reload\nsystemctl enable watchfs\nsystemctl start watchfs</pre><p>Let\u2019s test it:</p><pre># touch /tmp/test/tutorial\n# cat /tmp/reaction.log\nnew file: tutorial</pre><p>This is a basic example but it should be obvious how you can customize it and extend it to more watches. Since it\u2019s just calling a shell script, you can tailor react.sh to do whatever you want when new files are created. If you know (or want to learn) a little Python, you can easily watch multiple directories with a table of events and actions. Enjoy!</p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/lowendboxtv-building-a-highly-available-wordpress-site-part-4-configuring-drbd/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"LowEndBoxTV: Building a Highly Available WordPress Site, Part 4: Configuring DRBD\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/05/WP-HA-4-leb-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">LowEndBoxTV: Building a Highly Available WordPress Site, Part 4: Configuring DRBD</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/guide-to-understanding-file-permissions-in-linux/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Understanding File Permissions in Linux Guide\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/05/Understanding-File-Permissions-in-Linux-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Guide to Understanding File Permissions in Linux</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-find-files-in-linux/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Find Files in Linux\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/05/Finding-files-in-linux-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Find Files in Linux</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/lowendboxtv-building-a-highly-available-wordpress-site-part-2-configuring-the-nodes/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"LowEndBoxTV: Building a Highly Available WordPress Site, Part 2: Configuring the Nodes\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/05/WP-HA-2-leb-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">LowEndBoxTV: Building a Highly Available WordPress Site, Part 2: Configuring the Nodes</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}