{"id": "24333", "post": "<div class=\"post-24333 post type-post status-publish format-standard hentry category-tutorials tag-brute-force tag-fail2ban tag-linux tag-postfix tag-security\" id=\"post-24333\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/how-tostiff-arm-brutes-and-protect-your-server-with-fail2ban/\" rel=\"bookmark\">How to Stiff-Arm Brutes and Protect Your Server with Fail2Ban</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" width=\"16\" height=\"16\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/brute-force/\" rel=\"tag\">brute force</a>, <a href=\"https://lowendbox.com/tag/fail2ban/\" rel=\"tag\">fail2ban</a>, <a href=\"https://lowendbox.com/tag/linux/\" rel=\"tag\">linux</a>, <a href=\"https://lowendbox.com/tag/postfix/\" rel=\"tag\">postfix</a>, <a href=\"https://lowendbox.com/tag/security/\" rel=\"tag\">Security</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" width=\"16\" height=\"16\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> July 20, 2021 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban.png\" loading=\"lazy\" class=\"alignright size-full wp-image-27779 litespeed-loaded\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban.png\" alt=\"fail2ban\" width=\"300\" height=\"300\" align=\"right\" hspace=\"20\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban.png 300w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-150x150.png 150w\" data-sizes=\"(max-width: 300px) 100vw, 300px\" sizes=\"(max-width: 300px) 100vw, 300px\" srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban.png 300w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-150x150.png 150w\" data-was-processed=\"true\">Bruce force attacks are attempts to guess common passwords by repeatedly trying to login to your server.&nbsp; SSH is the most common target but FTP, IMAP, POP3, and other password-based systems can be targeted. While you, as perhaps a more sophisticated user, may choose strong passwords, your users may not.&nbsp; Shared hosting servers with thousands of accounts are particularly vulnerable.&nbsp; Many \u201cscript kiddies\u201d will robotically probe, scan, and attack servers one after another, trying dozens of common passwords to move on.&nbsp; All they need is a single user who\u2019s chosen \u201cmonkey1\u201d or \u201cabc123\u201d and they\u2019re in.</p><p>You can defeat these attacks by using fail2ban.&nbsp; This software watches your log files and if it sees a pattern of login failures, it inserts a firewall rule that blocks all connections from that IP.&nbsp; Even if the block is temporary, this slows the attacker down from doing hundreds of attempt per minute to perhaps only 3 every 10 minutes.&nbsp; This is all done automatically, so even when you\u2019re sleeping, fail2ban is guarding your server.</p><p>In this tutorial, we\u2019ll show you how to setup and configure fail2ban.</p><h1>Prerequisite: Postfix (optional)</h1><p>I\u2019m going to install Postfix, a mail server, so that fail2ban can send me an email whenever an IP is blocked.&nbsp; If you already have a functioning mail server (specifically, an MTA \u2013 Mail&nbsp; Transfer Agent) on your system, you can skip this step.</p><p>On Debian, installing Postfix is as simple as:</p><pre>apt-get install postfix</pre><p><span id=\"more-24333\"></span></p><p>You\u2019ll be asked how to configure it and you should probably answer Internet site.&nbsp; There are&nbsp;<em>tons</em> of configuration possibilities with Postfix but this will get you going.&nbsp; In this example, I\u2019m using a server named secure.lowend.party:</p><p><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1.png.webp\" loading=\"lazy\" class=\"alignnone size-full wp-image-24334 litespeed-loaded\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1.png.webp\" alt=\"\" width=\"800\" height=\"476\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1.png.webp 800w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1-300x179.png.webp 300w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1-768x457.png.webp 768w\" data-sizes=\"(max-width: 800px) 100vw, 800px\" sizes=\"(max-width: 800px) 100vw, 800px\" srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1.png.webp 800w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1-300x179.png.webp 300w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-1-768x457.png.webp 768w\" data-was-processed=\"true\"> <img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNDc3IiB2aWV3Qm94PSIwIDAgODAwIDQ3NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2NmZDRkYiIvPjwvc3ZnPg==\" loading=\"lazy\" class=\"alignnone size-full wp-image-24335\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-2.png.webp\" alt=\"\" width=\"800\" height=\"477\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-2.png.webp 800w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-2-300x179.png.webp 300w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-2-768x458.png.webp 768w\" data-sizes=\"(max-width: 800px) 100vw, 800px\"> <img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNDgwIiB2aWV3Qm94PSIwIDAgODAwIDQ4MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2NmZDRkYiIvPjwvc3ZnPg==\" loading=\"lazy\" class=\"alignnone size-full wp-image-24336\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-3.png.webp\" alt=\"\" width=\"800\" height=\"480\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-3.png.webp 800w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-3-300x180.png.webp 300w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-3-768x461.png.webp 768w\" data-sizes=\"(max-width: 800px) 100vw, 800px\"></p><h1>Installing fail2ban</h1><p>Once again, Debian makes it easy:</p><pre>apt-get install fail2ban</pre><h1>Configuring fail2ban</h1><p>fail2ban\u2019s configuration lives in /etc/fail2ban.&nbsp; Let\u2019s set up fail2ban to handle simple sshd protection.</p><p>In /etc/fail2ban/jaild., create a file called local.conf and populate it as follows:</p><pre>[DEFAULT]\ndestemail = \"someone@example.com\"\nsender = \"root@secure.lowend.party\"\nignoreip = 127.0.0.1/8 1.2.3.4/32\naction=%(action_mwl)s\n\n[sshd]\nenabled = true\nfilter = sshd\n# port = 2222\nlogpath = /var/log/auth.log\nfindtime = 600\nmaxretry = 3\nbantime = 600</pre><p>Let\u2019s walk through those.</p><p>First, you have a DEFAULT section that applies to all fail2ban sections.</p><ul><li><strong>destemail:</strong> Who receives fail2ban alerts</li><li><strong>sender:</strong> Who alerts come from.</li><li><strong>ignoreip:</strong> I\u2019ve listed two IPs here.&nbsp; The first is the entire /8 block of localhost.&nbsp; The second is my home IP.&nbsp; These IPs will never be blocked by fail2ban.&nbsp; Note that many people\u2019s home IPs change due to DHCP, so keep that in mind.</li><li><strong>action:</strong> in this case I\u2019ve selectd the \u201cmwl\u201d action, which means \u201cmail with log\u201d.&nbsp; You can define your own actions \u2013 take a look at /etc/fail2ban/jail.conf to see other options, or <a href=\"http://fail2ban.org/wiki/index.php/Manual\" target=\"_blank\" rel=\"noopener noreferrer\">Read The Fine Manual</a>.</li></ul><p>Next I\u2019ve defined a section for sshd:</p><ul><li><strong>enabled:</strong> to toggle it on</li><li><strong>filter:</strong> corresponds to a configuration in filter.d.&nbsp; The config files (over 80 different services are shipped with fail2ban to easily enable) include things like regular expressions to match in logs and other info fail2ban needs to work.</li><li>I\u2019ve commented out <strong>port</strong> but if you run with a custom port, define it here</li><li><strong>logpath:</strong> the\u2026you guessed it, it\u2019s the path to the log</li><li><strong>findtime</strong> and <strong>maxretry:</strong> fail2ban takes action if the number of failed logins exceeds maxretry times in findtime seconds.</li><li><strong>bantime:</strong> how long the ban persists before it\u2019s auto-removed</li></ul><p>Once you\u2019ve created the config file, you can check it with the command-line fail2ban client:</p><pre>fail2ban-client -t\nroot@secure:/etc/fail2ban/jail.d# fail2ban-client -t\nOK: configuration test is successful</pre><h1>fail2ban in Action</h1><p>I went to another VPS and tried repeatedly to login to this server via ssh, entering the wrong password each time.&nbsp; On my four attempt, this appeared in secure.lowend.party\u2019s log file (/var/log/auth.log).&nbsp; The IP has been anonymized:</p><pre>2020-07-26 13:21:57,623 fail2ban.actions [10814]: NOTICE [sshd] Ban 1.2.3.4</pre><p>For the next 10 minutes, I was unable to connect to anything on secure.lowend.party.&nbsp; I couldn\u2019t connect to the SSH port to retry.</p><p>On secure.lowend.party, I saw this in the iptables:</p><pre>Chain f2b-sshd (1 references)\ntarget prot opt source destination\nREJECT all -- server.example.com anywhere reject-with icmp-port-unreachable\nRETURN all -- anywhere anywhere</pre><p>And I received this email:</p><p><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNzY1IiB2aWV3Qm94PSIwIDAgODAwIDc2NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2NmZDRkYiIvPjwvc3ZnPg==\" loading=\"lazy\" class=\"alignnone size-full wp-image-24337\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-4.png.webp\" alt=\"\" width=\"800\" height=\"765\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-4.png.webp 800w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-4-300x287.png.webp 300w, https://lowendbox.com/wp-content/uploads/2020/07/fail2ban-4-768x734.png.webp 768w\" data-sizes=\"(max-width: 800px) 100vw, 800px\"></p><p>The ban expired after ten minutes, but if I wanted to unban a client before that, I could use this command:</p><pre>fail2ban-client unban 1.2.3.4</pre><p>&nbsp;</p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/insurers-tire-of-paying-ransom-to-cyber-crooks/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"empty wallet\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/07/empty_wallet-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Insurers Tire of Paying Ransom to Cyber Crooks</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/tarsnap-cloud-backups-for-the-truly-paranoid/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"TarSnap\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/07/tarsnap-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Tarsnap: Cloud Backups for the Truly Paranoid</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/beware-black-hat-cookie-stuffing-affiliate-marketing/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Cookie Monster\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/07/cookie_monster-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Beware Black Hat Cookie Stuffing Affiliate Marketing</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/celebrate-black-friday-in-july-with-losangelesvpss-50-off-sale/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"LosAngelesVPS Logo\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/11/losangelesvps-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Celebrate Black Friday in July with LosAngelesVPS's 50% Off Sale!</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}