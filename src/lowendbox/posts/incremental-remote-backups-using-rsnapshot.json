{"id": "24139", "post": "<div class=\"post-24139 post type-post status-publish format-standard hentry category-tutorials tag-backup tag-backups tag-linux tag-rsnapshot tag-rsync tag-ssh\" id=\"post-24139\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/incremental-remote-backups-using-rsnapshot/\" rel=\"bookmark\">Incremental Remote Backups Using rsnapshot</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/backup/\" rel=\"tag\">backup</a>, <a href=\"https://lowendbox.com/tag/backups/\" rel=\"tag\">backups</a>, <a href=\"https://lowendbox.com/tag/linux/\" rel=\"tag\">linux</a>, <a href=\"https://lowendbox.com/tag/rsnapshot/\" rel=\"tag\">rsnapshot</a>, <a href=\"https://lowendbox.com/tag/rsync/\" rel=\"tag\">rsync</a>, <a href=\"https://lowendbox.com/tag/ssh/\" rel=\"tag\">ssh</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> April 17, 2021 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p>There\u2019s an old adage about backups:</p><blockquote><p>There are two kinds of people: people who\u2019ve never lost data, and people who\u2019ll never lose data again.</p></blockquote><p>If you\u2019ve ever experienced data loss, you will instantly become passionate about backups.&nbsp; To prevent bad experiences with your data, you want backups that are comprehensive, manageable, versioned, automated, and secure.&nbsp; Let\u2019s break that down:</p><ul><li><strong>comprehensive:</strong> They should include everything by default.&nbsp; It\u2019s certainly legitimate to exclude OS directories, temp files, etc. but you don\u2019t want a system where you have to manually add directories as you add applications and data.&nbsp; Inevitably, you\u2019ll forget something and not know it until it\u2019s too late.</li><li><strong>manageable:</strong> If you have a 1TB server and take a full backup every day and retain them for a month, that\u2019s 30TB in a month.&nbsp; You need a system that allows for regular pruning.</li><li><strong>versioned:</strong> If you have a system that simply copies everything from system A to system B once a night, that\u2019s better than nothing, but on Monday you trash a file and don\u2019t notice it until Thursday, you can\u2019t recover.</li><li><strong>automated:</strong> Because humans are lazy.</li><li><strong>secure:</strong> It\u2019s annoying to be hacked.&nbsp; It\u2019s heartbreaking to find the hacker also destroyed your backups.</li></ul><p>In this tutorial, we\u2019ll show you how to setup backups using rsnapshot.&nbsp; Quoting rsnapshot.org:</p><blockquote><p>rsnapshot is a filesystem snapshot utility based on rsync. rsnapshot makes it easy to make periodic snapshots of local machines, and remote machines over ssh. The code makes extensive use of hard links whenever possible, to greatly reduce the disk space required.</p></blockquote><p>This means if you have 500MB of files, you want to retain 30 days\u2019 backups, and your change rate is 10% over that period, you don\u2019t need 30 * 500 = 15,000MB but rather only 550MB.&nbsp; Beautifully, you still have point-in-time recovery (depending on your backup schedule) throughout that period.</p><p>In this tutorial, we\u2019ll setup the following:</p><ul><li>server1.lowend.party has a directory called /data with lots of valuable files.</li><li>We want to back it up to backup.lowend.party using a scheme of hourly/daily/weekly/monthly backups.&nbsp; These are stored in /backups/server1.lowend.party</li><li>backup.lowend.party has other hosts it backs up as well.</li><li>We\u2019re using passwordless ssh keys for authentication so we can run everything out of cron.</li></ul><p>Before we start, there\u2019s one more key concept.</p><h1>Push vs. Pull Backups</h1><p>I\u2019ve long advocated&nbsp;<em>pull</em> backups.&nbsp; In other words, the backup server comes along and backs up the client.&nbsp; In this scenario, backup.lowend.party initiates the backups and contacts server1.lowend.party to get the data.&nbsp; This is in contrast to <em>push</em> backups, where server1.lowend.party contacts backup.lowend.party and pushes the backups to it.</p><p>What\u2019s the difference?&nbsp; Imagine server1 is hacked.&nbsp; If we\u2019re using push backups, it would be trivial for the hacker to use the passwordless ssh keys to nuke the backups as well.&nbsp; In a pull-based model, backup.lowend.party can authenticate to server1, but not vice-versa, so the hacker is out of luck.</p><h1>Installing rsnapshot</h1><p>On Debian, it\u2019s as easy as</p><pre>apt install rsnapshot</pre><p><span id=\"more-24139\"></span></p><h1>Configuring rsnapshot</h1><p>rsnapshot\u2019s config lives in /etc/rsnapshot.conf.&nbsp; I recommend making a backup of it before you start changing things:</p><pre>mv /etc/rsnapshot.conf /etc/rsnapsnap.conf.default</pre><p>There are different philosophies about how to setup rsnapshot configs.&nbsp; I prefer to have a separate config file for each client (system being backed up).&nbsp; If you only have one system to backup, this is not necessary.&nbsp; You can backup multiple systems in one config file, but you lose some flexibility.&nbsp; Experiment and decide which you like.&nbsp; In my case, I do this:</p><pre>cp /etc/rsnapshot.conf.default /etc/rsnapshot.conf.server1</pre><p>Now modify as follows.&nbsp;&nbsp;<strong>Important Note:&nbsp;</strong>rsnapshot.conf requires TABs between elements.&nbsp; So \u201ccmd /usr/bin/ssh\u201d is \u201ccmd&lt;TAB&gt;/usr/bin/ssh\u201d.</p><p>Enable remote backups:</p><pre>cmd_ssh /usr/bin/ssh</pre><p>Add these backup intervals:</p><pre>interval hourly 6\ninterval daily 7\ninterval weekly 4\ninterval monthly 3</pre><p>I\u2019m using a passwordless ssh key stored in /root/.ssh/backup.&nbsp; I also use a different ssh port.&nbsp; So make this change:</p><pre>ssh_args -p 8989 -i ~/.ssh/backup</pre><pre>These two commands are for reporting (see below):\n\nrsync_long_args --stats --delete --numeric-ids --relative --delete-excluded\nverbose 4</pre><p>Now I tell rsnapshot where to save backups:</p><pre>snapshot_root /backups/server1.lowend.party/</pre><p>Finally, I add the backup definition:</p><pre>backup root@server1.lowend.party:/data/ .</pre><p>This will keep files in /backups/server1.lowend.party/hourly.0, etc.</p><p>I want to exclude /data/cache on my backups:</p><pre>exclude_file /etc/rsnapshot.server1.exclude</pre><p>And in that file I put:</p><pre>- /data/cache/*</pre><p>OK, we\u2019re ready to go.&nbsp; Now because I\u2019m not using the default /etc/rsnapshot.conf name, I need to use the -c parameter for all rsnapshot commands.&nbsp; Let\u2019s start by testing the config:</p><pre>root@backup:/etc# rsnapshot -c /etc/rsnapshot.conf.server1 configtest\nSyntax OK</pre><p>Now we can run a simulation:</p><pre>root@backup:/etc# rsnapshot -c /etc/rsnapshot.conf.server1 -t hourly\necho 9633 &gt; /var/run/rsnapshot.pid\nmkdir -m 0755 -p /backups/hourly.0/\n/usr/bin/rsync -a --stats --delete --numeric-ids --relative --delete-excluded \\\n--exclude-from=/etc/rsnapshot.server1.exclude --rsh=/usr/bin/ssh -p 8989 \\\n-i ~/.ssh/backup root@server1.lowend.party:/data/ \\\n/backups/hourly.0/server1.lowend.party/\ntouch /backups/hourly.0/</pre><p>One more thing to do.&nbsp; I like to use rsnapshot\u2019s reporting tool, so let\u2019s enable it:</p><pre class=\"p1\"><span class=\"s1\">cp /usr/share/doc/rsnapshot/examples/utils/rsnapreport.pl /usr/local/bin\n</span><span class=\"s1\">chmod 755 /usr/local/bin/rsnapreport.pl </span></pre><p>We\u2019re good to go!</p><h1>Running rsnapshot</h1><p>On server1, I have 547MB in /data, and 30MB in /data/cache which will be excluded:</p><pre>root@server1:~# du -sm /data\n547 /data\nroot@server1:~# du -sm /data/cache\n30 /data/cache</pre><p>Let\u2019s run our first rsnapshot backup:</p><pre>root@backup:/backups/server1.lowend.party# rsnapshot -c /etc/rsnapshot.conf.server1 hourly\nSetting locale to POSIX \"C\"\necho 10012 &gt; /var/run/rsnapshot.pid\nmkdir -m 0755 -p /backups/server1.lowend.party/hourly.0/\n/usr/bin/rsync -av --stats --delete --numeric-ids --relative \\\n--delete-excluded --exclude-from=/etc/rsnapshot.server1.exclude \\\n--rsh=/usr/bin/ssh -p 8989 -i ~/.ssh/backup \\\nroot@server1.lowend.party:/data/ \\\n/backups/server1.lowend.party/hourly.0/.\nreceiving incremental file list\ndata/\n&lt;snipped&gt;\ndata/cache/\n\nNumber of files: 10,982 (reg: 10,980, dir: 2)\nNumber of created files: 10,982 (reg: 10,980, dir: 2)\nNumber of deleted files: 0\nNumber of regular files transferred: 10,980\nTotal file size: 518,702,282 bytes\nTotal transferred file size: 518,702,282 bytes\nLiteral data: 518,702,282 bytes\nMatched data: 0 bytes\nFile list size: 611,123\nFile list generation time: 0.001 seconds\nFile list transfer time: 0.000 seconds\nTotal bytes sent: 208,691\nTotal bytes received: 519,874,481\n\nsent 208,691 bytes received 519,874,481 bytes 80,012,795.69 bytes/sec\ntotal size is 518,702,282 speedup is 1.00\ntouch /backups/server1.lowend.party/hourly.0/\nrm -f /var/run/rsnapshot.pid\n/usr/bin/logger -p user.info -t rsnapshot[10012] /usr/bin/rsnapshot -c \\\n/etc/rsnapshot.conf.server1 hourly: completed successfully</pre><p>Now I can also run that using the rsnapshotreport.pl script we setup.&nbsp; If I do, the output will look like this (the TOTAL MB is a little different because I ran these at different times):</p><pre># rsnapshot -c /etc/rsnapshot.conf.server1 hourly | /usr/local/bin/rsnapshotreport.pl\nSOURCE TOTAL FILES FILES TRANS TOTAL MB MB TRANS LIST GEN TIME FILE XFER TIME\n--------------------------------------------------------------------------------------------------------------------\nserver1.lowend.party:/data/ 11982 1 564.81 46.10 0.001 seconds 0.000 seconds</pre><p>Now if I continue running hourly backups, I see new directories being created in /backups/server1.lowend.party:</p><pre>drwxr-xr-x 3 root root 4096 Jul 12 16:03 hourly.0\ndrwxr-xr-x 3 root root 4096 Jul 12 16:01 hourly.1\ndrwxr-xr-x 3 root root 4096 Jul 12 15:58 hourly.2</pre><p>Interestingly, hourly.0 is 500-odd MB, will the rest are only 1MB.&nbsp; Why?&nbsp; Because hourly.1, hourly.2, etc. are simply hard links back to hourly.0.&nbsp; This is a huge space savings.</p><p>If I nuke some files on server1\u2019s /data and run another couple backups, you\u2019ll see this:</p><pre>root@backup:/backups/server1.lowend.party# du -sm *\n526 hourly.0\n39 hourly.1\n1 hourly.2\n1 hourly.3</pre><p>rsnapshot is retaining data in hourly.1 because it\u2019s needed to reconstruct the backups for that hour.</p><h1>Automating rsnapshot</h1><p>Setting up automated backups is as easy as putting jobs in cron.&nbsp; For example:</p><pre>MAILTO=you@somewhere.com\n0 * * * * root /usr/bin/rsnapshot -c /etc/rsnapshot.conf.server1 hourly 2&gt;&amp;1 | /usr/local/bin/rsnapreport.pl\n0 3 * * * root /usr/bin/rsnapshot -c /etc/rsnapshot.conf.server1 daily 2&gt;&amp;1 | /usr/local/bin/rsnapreport.pl&nbsp;\n0 3 * * 1 root /usr/bin/rsnapshot -c /etc/rsnapshot.conf.server1 weekly 2&gt;&amp;1 | /usr/local/bin/rsnapreport.pl\n30 2 1 * * root /usr/bin/rsnapshot -c /etc/rsnapshot.conf.server1 monthly 2&gt;&amp;1 | /usr/local/bin/rsnapreport.pl</pre><p>Now</p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/comment-free-for-all-which-obscure-linux-distro-do-you-regularly-use/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Comment Free For All: Which Obscure Linux Distro Do You Regularly Use?\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/03/comment-free-for-all-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Comment Free For All: Which Obscure Linux Distro Do You Regularly Use?</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/poll-results-what-are-your-centos-plans/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Poll Results: What are Your CentOS Plans?\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/03/centos_poll-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Poll Results: What are Your CentOS Plans?</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/libreplanet-fsf-conference-is-free-and-one-week-from-today/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"LibrePlanet (the FSF Conference) One Week From Today - and it's Free (as in Beer)!\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/03/libre_planet_logo-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">LibrePlanet (the FSF Conference) One Week From Today - and it's Free (as in Beer)!</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-fire-up-wordpress-in-three-commands/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Fire Up WordPress in Three Commands\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/07/wordpress-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Fire Up WordPress in Three Commands</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}