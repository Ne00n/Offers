{"id": "24238", "post": "<div class=\"post-24238 post type-post status-publish format-standard hentry category-tutorials tag-database tag-galera tag-linux tag-mariadb tag-mysql tag-replication\" id=\"post-24238\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/painless-mariadb-replication-with-galera-clusters/\" rel=\"bookmark\">Painless MariaDB Replication with Galera Clusters</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" width=\"16\" height=\"16\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/database/\" rel=\"tag\">database</a>, <a href=\"https://lowendbox.com/tag/galera/\" rel=\"tag\">galera</a>, <a href=\"https://lowendbox.com/tag/linux/\" rel=\"tag\">linux</a>, <a href=\"https://lowendbox.com/tag/mariadb/\" rel=\"tag\">mariadb</a>, <a href=\"https://lowendbox.com/tag/mysql/\" rel=\"tag\">mysql</a>, <a href=\"https://lowendbox.com/tag/replication/\" rel=\"tag\">replication</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" width=\"16\" height=\"16\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> September 22, 2021 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2021/09/galera_logo.png\" loading=\"lazy\" class=\"alignright size-full wp-image-28331 litespeed-loaded\" data-src=\"https://lowendbox.com/wp-content/uploads/2021/09/galera_logo.png\" alt=\"Galera\" width=\"300\" height=\"300\" align=\"right\" hspace=\"20\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2021/09/galera_logo.png 300w, https://lowendbox.com/wp-content/uploads/2021/09/galera_logo-150x150.png 150w\" data-sizes=\"(max-width: 300px) 100vw, 300px\" sizes=\"(max-width: 300px) 100vw, 300px\" srcset=\"https://lowendbox.com/wp-content/uploads/2021/09/galera_logo.png 300w, https://lowendbox.com/wp-content/uploads/2021/09/galera_logo-150x150.png 150w\" data-was-processed=\"true\">Galera is MariaDB\u2019s multi-master replication technology which makes it a snap to setup highly-available multi-node MariaDB clusters.&nbsp; In this tutorial we\u2019ll walk through setting up a cluster and also look at some replication events.</p><h1>Cluster Design</h1><p>For Galera, you want to use odd-number clustered sizes: 3 nodes, 5 nodes, etc.&nbsp; It\u2019s possible to run a 1-node Galera cluster but then you\u2019re not replicating, so that\u2019d be pointless.&nbsp; The nodes can be anywhere in the world, but keep in mind that Galera is <em>synchronous</em> replication.&nbsp; This means the more nodes and the further they are from each other, the more latency.</p><p>Note that we\u2019re only referring to&nbsp;<em>write</em> latency.&nbsp; If you have three nodes that are placed far from each other but there are only a few time-insensitive writes throughout the day and the bulk of interactions are read (e.g., a blog or news site) then this system can still work well.</p><p>In this design, I\u2019m using the following cluster and anonymized IPs:</p><ul><li>db1.lowend.party on 1.1.1.1</li><li>db2.lowend.party on 2.2.2.2</li><li>db3.lowend.party on 3.3.3.3</li></ul><h1>Installing MariaDB</h1><p>I put each node\u2019s DNS entries on each host\u2019s /etc/hosts.&nbsp; This is not strictly necessary because we\u2019ll use IPs for cluster communications but it doesn\u2019t hurt.</p><p>In /etc/hosts on each node:</p><pre class=\"p1\"><span class=\"s1\">1.1.1.1 db1.lowend.party\n</span>2.2.2.2 db2.lowend.party\n<span class=\"s1\">3.3.3.3 db3.lowend.party</span></pre><p>Now install MariaDB and also rsync on each node:</p><pre class=\"p1\"><span class=\"s1\">apt-get -y install mariadb-server rsync</span></pre><p>Run the MariaDB installation security script on each node:</p><pre class=\"p1\"><span class=\"s1\">mysql_secure_installation</span></pre><p>Now shut down MariaDB on all nodes:</p><pre class=\"p1\"><span class=\"s1\">systemctl stop mariadb\n\n</span></pre><p><span id=\"more-24238\"></span></p><h1>Configuring for Galera</h1><p>On each node, we\u2019d going to create a galera.cnf file that has MariaDB parameters.&nbsp; There\u2019s a set of parameters that are common to all nodes and a section that is unique to each node.&nbsp; On db1, create the following in<span class=\"s1\">&nbsp;/etc/mysql/conf.d/galera.cnf</span></p><pre class=\"p1\"><span class=\"s1\"># common to all\n</span><span class=\"s1\">[mysqld]\n</span><span class=\"s1\">binlog_format=ROW\n</span><span class=\"s1\">default-storage-engine=innodb\n</span><span class=\"s1\">innodb_autoinc_lock_mode=2\n</span><span class=\"s1\">bind-address=0.0.0.0\n</span><span class=\"s1\">wsrep_on=ON\n</span><span class=\"s1\">wsrep_provider=/usr/lib/galera/libgalera_smm.so\n</span><span class=\"s1\">wsrep_cluster_name=\"galera_cluster\"\n</span><span class=\"s1\">wsrep_cluster_address=\"gcomm://1.1.1.1,2.2.2.2,3.3.3.3\"\n</span><span class=\"s1\">wsrep_sst_method=rsync</span>\n\n<span class=\"s1\"># unique to this node\n</span><span class=\"s1\">wsrep_node_address=\"1.1.1.1\"\n</span><span class=\"s1\">wsrep_node_name=\"db1\"</span></pre><p>Do the same on db2, changing the last two lines to:</p><pre class=\"p1\"><span class=\"s1\"># unique to this node\n</span><span class=\"s1\">wsrep_node_address=\"2.2.2.2\"\n</span><span class=\"s1\">wsrep_node_name=\"db2\"</span></pre><p>And repeat on db3, changing the last two lines to:</p><pre><span class=\"s1\"># unique to this node\n</span><span class=\"s1\">wsrep_node_address=\"3.3.3.3\"\n</span><span class=\"s1\">wsrep_node_name=\"db3\"</span></pre><h1>Starting Up the Galera Cluster</h1><p class=\"p1\"><span class=\"s1\">On db1, run the new cluster command:</span></p><pre class=\"p1\"><span class=\"s1\"> galera_new_cluster</span></pre><p>This is a convenience wrapper around the \u2013wsrep-new-cluster flag to MariaDB.&nbsp; After it executes, you\u2019ll see MariaDB has started up in cluster initialization mode:</p><pre class=\"p1\"><span class=\"s1\">root@db1:~# ps -ef | grep -i mysq</span>\n<span class=\"s1\">mysql<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>15439 <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>1<span class=\"Apple-converted-space\">&nbsp; </span>2 20:29 ?<span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; &nbsp; </span>00:00:00 /usr/sbin/mysqld --wsrep-new-cluster</span></pre><p>Check to see how many nodes are in your cluster.&nbsp; Connect to mysql and query the wsreap_cluster_size variable:</p><pre># mysql\n<span class=\"s1\">MariaDB [(none)]&gt; show status like 'wsrep_cluster_size';</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">| Variable_name<span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>| Value |</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">| wsrep_cluster_size | 1 <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">1 row in set (0.001 sec)</span></pre><p>Now on db2:</p><pre class=\"p1\"><span class=\"s1\">systemctl start mariadb.service </span></pre><p class=\"p1\"><span class=\"s1\">And then back on db1:</span></p><pre class=\"p1\"><span class=\"s1\">MariaDB [(none)]&gt; show status like 'wsrep_cluster_size';</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">| Variable_name<span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>| Value |</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">| wsrep_cluster_size | 2 <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">1 row in set (0.001 sec)</span></pre><p class=\"p1\"><span class=\"s1\">Then on db3:</span></p><pre class=\"p1\"><span class=\"s1\">systemctl start mariadb.service </span></pre><p class=\"p1\"><span class=\"s1\">And once again on db1:</span></p><pre class=\"p1\"><span class=\"s1\">MariaDB [(none)]&gt; show status like 'wsrep_cluster_size';</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">| Variable_name<span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>| Value |</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">| wsrep_cluster_size | 3 <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+--------------------+-------+</span>\n<span class=\"s1\">1 row in set (0.001 sec)</span></pre><h1>Testing Galera</h1><p>Let\u2019s create a database and put some data in it.&nbsp; In MariaDB, execute these commands:</p><pre class=\"p1\"><span class=\"s1\">create database gtest;</span>\n<span class=\"s1\">use gtest;</span>\n<span class=\"s1\">create table buffy ( name varchar(30), team_role varchar(100) );</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Buffy', 'slayer');</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Giles', 'research');</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Zander', 'comic relief');</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Cordelia', 'eye candy');</span></pre><p>Now go over to db3 and see if the data has replicated:</p><pre class=\"p1\"><span class=\"s1\">root@db3:/etc/mysql# mysql gtest</span>\n<span class=\"s1\">Reading table information for completion of table and column names</span>\n<span class=\"s1\">You can turn off this feature to get a quicker startup with -A</span>\n<span class=\"s1\">Welcome to the MariaDB monitor.<span class=\"Apple-converted-space\">&nbsp; </span>Commands end with ; or \\g.</span>\n<span class=\"s1\">Your MariaDB connection id is 38</span>\n<span class=\"s1\">Server version: 10.3.22-MariaDB-0+deb10u1 Debian 10</span>\n<span class=\"s1\">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span>\n<span class=\"s1\">Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n</span>\n<span class=\"s1\">MariaDB [gtest]&gt; select * from buffy;</span>\n<span class=\"s1\">+----------+--------------+</span>\n<span class=\"s1\">| name <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| team_role<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+----------+--------------+</span>\n<span class=\"s1\">| Buffy<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| slayer <span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Giles<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| research <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Zander <span class=\"Apple-converted-space\">&nbsp; </span>| comic relief |</span>\n<span class=\"s1\">| Cordelia | eye candy<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+----------+--------------+</span>\n<span class=\"s1\">4 rows in set (0.001 sec)</span></pre><p>Let\u2019s shut down db2\u2019s MariaDB.&nbsp; On db2:</p><pre class=\"p1\"><span class=\"s1\">systemctl stop mariadb</span></pre><p class=\"p1\"><span class=\"s1\">And now on db1, execute these commands on db1:</span></p><pre class=\"p1\"><span class=\"s1\">use gtest;</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Faith', 'slayer');</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Wesley', 'whiner');</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Oz', 'werewolf');</span></pre><p>Now start MariaDB again on db2:</p><pre class=\"p1\"><span class=\"s1\">systemctl start mariadb</span></pre><p>Check out /var/log/mysql/error.log and you\u2019ll see messages like this:</p><pre class=\"p1\"><span class=\"s1\">2020-07-21 21:03:02 0 [Note] WSREP: Shifting JOINER -&gt; JOINED (TO: 15)</span>\n<span class=\"s1\">2020-07-21 21:03:02 0 [Note] WSREP: Member 0.0 (db2) synced with group.</span>\n<span class=\"s1\">2020-07-21 21:03:02 0 [Note] WSREP: Shifting JOINED -&gt; SYNCED (TO: 15)</span>\n<span class=\"s1\">2020-07-21 21:03:02 1 [Note] WSREP: Synchronized with group, ready for connections</span></pre><p>This shows db2 has successfully synchronized (and you can query the table to see this).&nbsp; You can also compare the \u2018wsrep_last_committed\u2019 status variable and they should be the same across the cluster.&nbsp; Again o<span class=\"s1\">n db2:</span></p><pre class=\"p1\"><span class=\"s1\">MariaDB [(none)]&gt; show status like 'wsrep_last_committed';</span>\n<span class=\"s1\">+----------------------+-------+</span>\n<span class=\"s1\">| Variable_name<span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; &nbsp; </span>| Value |</span>\n<span class=\"s1\">+----------------------+-------+</span>\n<span class=\"s1\">| wsrep_last_committed | 15<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+----------------------+-------+</span>\n<span class=\"s1\">1 row in set (0.001 sec)</span></pre><p class=\"p1\"><span class=\"s1\">Of course, we don\u2019t have to write only on db1.&nbsp; Let\u2019s insert some data on db3:</span></p><pre class=\"p1\"><span class=\"s1\">use gtest;</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Willow', 'research');</span>\n<span class=\"s1\">insert into buffy (name, team_role) values ( 'Anya', 'bad news');</span></pre><p class=\"p1\"><span class=\"s1\">And then on db1:</span></p><pre class=\"p1\"><span class=\"s1\">MariaDB [(none)]&gt; use gtest</span>\n<span class=\"s1\">Reading table information for completion of table and column names</span>\n<span class=\"s1\">You can turn off this feature to get a quicker startup with -A</span>\n<span class=\"s1\">Database changed</span>\n<span class=\"s1\">MariaDB [gtest]&gt; select * from buffy;</span>\n<span class=\"s1\">+----------+--------------+</span>\n<span class=\"s1\">| name <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| team_role<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+----------+--------------+</span>\n<span class=\"s1\">| Buffy<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| slayer <span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Giles<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| research <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Zander <span class=\"Apple-converted-space\">&nbsp; </span>| comic relief |</span>\n<span class=\"s1\">| Cordelia | eye candy<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Faith<span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| slayer <span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Wesley <span class=\"Apple-converted-space\">&nbsp; </span>| whiner <span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Oz <span class=\"Apple-converted-space\">&nbsp; &nbsp; &nbsp; </span>| werewolf <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Willow <span class=\"Apple-converted-space\">&nbsp; </span>| research <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">| Anya <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>| bad news <span class=\"Apple-converted-space\">&nbsp; &nbsp; </span>|</span>\n<span class=\"s1\">+----------+--------------+</span>\n<span class=\"s1\">9 rows in set (0.000 sec)</span></pre><p>&nbsp;</p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/hostigger-is-now-hostiger-and-has-ferociously-cheap-vps-offers-for-you-kansas-city-or-istanbul/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Hostigger Logo\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/02/hostigger-150x150.png.webp) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Hostigger is Now Hostiger and Has Ferociously Cheap VPS Offers for You! (Kansas City or Istanbul)</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/cloudserver-brings-us-2gblinux-kvms-for-only-1-99-month-on-annual-or-windows-kvms-for-3-month/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CloudServer Logo\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/11/cloudserver-150x150.png.webp) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CloudServer Brings Us 2GBLinux KVMs for Only $1.99/Month (on Annual) or Windows KVMs for $3/Month!</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/debian-11-bullseye-released-today/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Debian 11\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/08/debian11-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Debian 11 \"Bullseye\" Released Today!</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/ikoula-offers-hosted-synology-nas-servers/\"><div class=\"relpost-custom-block-single\" style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"iKoula Offers Hosted Synology NAS Servers\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2021/02/ikoula-150x150.png.webp) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">iKoula Offers Hosted Synology NAS Servers</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}