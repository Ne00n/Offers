{"id": "24118", "post": "<div class=\"post-24118 post type-post status-publish format-standard hentry category-tutorials tag-camera tag-cloud tag-php tag-raspberry-pi tag-security\" id=\"post-24118\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/lowendprotection-homemade-raspberry-pi-security-cloud-camera-setup/\" rel=\"bookmark\">LowEndProtection: Homemade Raspberry Pi Security Cloud Camera Setup</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \"> <a href=\"https://lowendbox.com/tag/camera/\" rel=\"tag\">camera</a>, <a href=\"https://lowendbox.com/tag/cloud/\" rel=\"tag\">cloud</a>, <a href=\"https://lowendbox.com/tag/php/\" rel=\"tag\">PHP</a>, <a href=\"https://lowendbox.com/tag/raspberry-pi/\" rel=\"tag\">raspberry pi</a>, <a href=\"https://lowendbox.com/tag/security/\" rel=\"tag\">Security</a> <img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \"> November 14, 2020 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p>If you are looking to setup some professional security cameras in your home and put the content in the cloud for remote storage/access, I would recommend looking at the wide range of solutions in the marketplace that are designed to satisfy this need. However, if like me you have a few Raspberry Pis sitting around and want to hack up something on your own, read on.</p><p>In this tutorial, I\u2019m using several Raspberry Pi 3 Model B+ devices. Some have the standard Raspberry Pi camera, and some have <a href=\"https://www.amazon.com/gp/product/B00N1YJKFS/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1\">SainSmart Wide Angle Fish-Eye</a> cameras.&nbsp; They\u2019re all connected to my home LAN via wireless.&nbsp; There\u2019s nothing special about the RPi setups, so I won\u2019t repeat what is so easily findable elsewhere.&nbsp; Note that in placing your cameras, you need to account for the fact that they need to be plugged into an outlet.</p><p><span id=\"more-24118\"></span></p><p>I call my system \u2018cerebro\u2019 after Professor Xavier\u2019s device for scanning mutant brains, so the Pis are named cerebro1, cerebro2, etc. Mine doesn\u2019t scan brains, just takes pictures, like this one:</p><p><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiB2aWV3Qm94PSIwIDAgODAwIDYwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2NmZDRkYiIvPjwvc3ZnPg==\" loading=\"lazy\" class=\"alignnone size-full wp-image-24120\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/07/rpi_security1.jpg.webp\" alt=\"\" width=\"800\" height=\"600\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/rpi_security1.jpg.webp 800w, https://lowendbox.com/wp-content/uploads/2020/07/rpi_security1-300x225.jpg.webp 300w, https://lowendbox.com/wp-content/uploads/2020/07/rpi_security1-768x576.jpg.webp 768w\" data-sizes=\"(max-width: 800px) 100vw, 800px\"></p><p>Everything is done via pretty simple commands and some homemade daemons.</p><h1>On the Raspberry Pis</h1><p>Images are stored in /cerebro. Scripts are in /app/cerebro.</p><p>There are three scripts that run:</p><ul><li>cerebrod: This is the daemon that takes a picture every 5 seconds</li><li>cerebro_uploaderd: This uploads the picture to the cloud</li><li>a housekeeping cron job that cleans up old images</li></ul><p>I take a pic once every 5 seconds. I run the capture script as a systemd daemon because cron only has a resolution of 1 minute.</p><p>Here is cerebrod_captured:</p><pre>#!/bin/bash\n\n# -v verbose\n# -o output with pattern\n# -ts make that pattern the unix epoch\n# --exposure to auto\n# --awb to auto\n# -q 20 - did not see a huge dropoff vs. 50 but saved 2MB on size\n# -t 86400000 number of ms in a day\n# -tl 5000 take a pic every 5 seconds\n\nHOSTNAME=$(/bin/hostname -s)\n/usr/bin/raspistill -v -o /cerebro/${HOSTNAME}_%d.jpg -ts --exposure auto --awb auto -q 20 -t 86400000 -tl 5000</pre><p>So you get names like cerebro2_1594507631.jpg, where \u2018cerebro2\u2019 is the name of the Raspberry Pi that took the picture and 1594507631 is the Unix epoch. Pics are 1.3MB, so over the course of an hour, this writes about 936MB per hour.</p><p>Here is the systemd unit file:</p><pre>[Unit]\nDescription=cerebrod\n\n[Service]\nExecStart=/app/cerebro/cerebrod\nRestart=always\nStartIntervalLimit=5\nTimeoutStartSec=30\nStandardOutput=/app/cerebro/cerebrod.log\nStandardError=/app/cerebro/cerebrod.log\nUser=cerebro\nGroup=cerebro\n\n[Install]\nWantedBy=multi-user.target</pre><p>To prevent the card from filling up, I have a simple cron job to clean up all images older than 1 hour:</p><pre>find /cerebro -mmin +60 -exec rm -f {} \\; &gt; /dev/null 2&gt;&amp;1</pre><p>Finally, there is a daemon to upload files to my web site. Here is cerebro_uploaderd:</p><pre>#!/bin/bash\n\nHOSTNAME=$(/bin/hostname -s)\nwhile [ 1 ] ; do \n  time /usr/bin/rsync -avz -e \"ssh -l ${HOSTNAME} -i /home/cerebro/.ssh/${HOSTNAME}\" --exclude \"*.jpg~\" /cerebro cerebro@cerebro.lowend.party:/cerebro\n  sleep 3\ndone</pre><p>Note there is no \u2013delete flag in that rsync. The \u2013exclude covers cases where the jpeg is in the process of being written when this runs. What happens in that case is the rsync sees it but by the time it sends it, it\u2019s gone, and there\u2019s an error generated. Instead, I just let the next invocation (a few seconds later) catch the completed file.</p><p>Here is cerebro_uploaderd\u2019s systemd unit file:</p><pre>[Unit]\nDescription=cerebro security camera uploader\n\n[Service]\nExecStart=/app/cerebro/cerebro_uploaderd\nRestart=always\nStartIntervalLimit=5\nTimeoutStartSec=30\nStandardOutput=/app/cerebro/cerebro_uploaderd.log\nStandardError=/app/cerebro/cerebrod_uploaderd.log\nUser=cerebro\nGroup=cerebro\n\n[Install]\nWantedBy=multi-user.target</pre><p>I restart both daemons once every 12 hours. I find they occasionally die for no reason \u2013 probably due to the limitations of the Raspberry Pi. Unlike normaly systems, I don\u2019t restart cerebrod in the middle of the night \u2013 I want it taking pictures then. Instead, I restart it at 7am and 5pm, when someone is always home and awake. Regardless, it restarts so fast I don\u2019t miss a picture. cerebro_uploaderd can restart any time.</p><pre>00 17,7 * * * /bin/systemctl restart cerebrod \n05 17,7 * * * /bin/systemctl restart cerebro_uploaderd</pre><p>On the VPS</p><p>/cerebro is the directory where the Pis upload their pictures.</p><p>I have a simple archive program that moves older pictures into /cerebro_archive:</p><pre>#!/bin/bash\nfind /cerebro -mday +1 -exec mv {} /cerebro_archive \\; &gt; /dev/null 2&gt;&amp;1</pre><p>This is done just so that the viewing script runs faster.</p><p>And then a one-liner to clean out files older than 30 days:</p><pre>find /cerebro -mday +30 -exec rm -f {} \\; &gt; /dev/null 2&gt;&amp;1</pre><p>I have nginx+php running, and the site is password-protected with basic authentication (using the auth_basic and auth_basic_user_file directives, over https). The app to view pictures is a very simple index.php:</p><pre>&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;cerebro&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Cerebro&lt;/h1&gt;\n&lt;?php\n$fileList = glob('/cerebro/*.jpg');\n$last_pics = array();\nforeach ($fileList as $filename) {\n  $chopped = str_replace(\"/cerebro/\",\"\",trim($filename, '.jpg'));\n  list ($camera,$timestamp) = explode(\"_\",$chopped);\n  if ( $last_pics[$camera] &lt; $timestamp ) {\n    $last_pics[$camera] = $timestamp;\n  }\n}\n\nforeach ( $last_pics as $camera =&gt; $timestamp ) {\n  $filename = '/cerebro/' . $camera . '_' . $timestamp . '.jpg';\n  echo \"&lt;div class=\\\"cam-pic-block\\\"&gt;\\n\";\n  echo \"&lt;a href=\\\"\" . $filename . \"\\\" /&gt;\\n\";\n  echo \"&lt;img class=\\\"cam-block\\\" src=\\\"\" . $filename . \"\\\" /&gt;\\n\";\n  echo \"&lt;/a&gt;\\n\";\n  echo \"&lt;p&gt;&lt;i&gt;\" . $camera . \" at \" . date('r',$timestamp) . \"&lt;/i&gt;&lt;/p&gt;\\n\";\n  echo \"&lt;/div&gt;\\n\";\n  echo \"&lt;br /&gt;\\n\";\n}\n?&gt;\n&lt;/body&gt;\n&lt;/html&gt;</pre><p>Here\u2019s a screenshot of the viewing page:</p><p><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjY2IiB2aWV3Qm94PSIwIDAgODAwIDY2NiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2NmZDRkYiIvPjwvc3ZnPg==\" loading=\"lazy\" class=\"alignnone size-full wp-image-24121\" data-src=\"https://lowendbox.com/wp-content/uploads/2020/07/rpi_security2.png.webp\" alt=\"\" width=\"800\" height=\"666\" data-srcset=\"https://lowendbox.com/wp-content/uploads/2020/07/rpi_security2.png.webp 800w, https://lowendbox.com/wp-content/uploads/2020/07/rpi_security2-300x250.png.webp 300w, https://lowendbox.com/wp-content/uploads/2020/07/rpi_security2-768x639.png.webp 768w\" data-sizes=\"(max-width: 800px) 100vw, 800px\"></p><h1>Some Design Notes</h1><p>Note that the on-line viewer only shows the most recent picture. My assumption is that if I needed to go and look back in time, I\u2019d download a range of files and look through them.</p><p>Also note that you need to be mindful of your upload bandwidth. Each pic is 1.3MB, so if you have 5 cameras, that\u2019s uploading 6.5MB every 5 seconds. Many residential broadband plans have much more download bandwidth than upload, so be sure your upload bandwidth can support this traffic.</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Flowendprotection-homemade-raspberry-pi-security-cloud-camera-setup%2F&amp;t=LowEndProtection%3A%20Homemade%20Raspberry%20Pi%20Security%20Cloud%20Camera%20Setup\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=LowEndProtection%3A%20Homemade%20Raspberry%20Pi%20Security%20Cloud%20Camera%20Setup&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Flowendprotection-homemade-raspberry-pi-security-cloud-camera-setup%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Flowendprotection-homemade-raspberry-pi-security-cloud-camera-setup%2F&amp;title=LowEndProtection%3A%20Homemade%20Raspberry%20Pi%20Security%20Cloud%20Camera%20Setup&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/servermanias-new-public-cloud-now-open-for-business/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"ServerMania's New Public Cloud Now Open for Business!\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/11/servermania-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">ServerMania's New Public Cloud Now Open for Business!</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/giveaway-subscribe-to-lowendbox-for-a-chance-to-win-free-raspberry-pis-netgear-nighthawk-router-and-racknerd-account-credits/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"[GIVEAWAY] Subscribe to LowEndBox for a chance to win Free Raspberry Pi's, NETGear NightHawk Router,...\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/11/giveaway1-800-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">[GIVEAWAY] Subscribe to LowEndBox for a chance to win Free Raspberry Pi's, NETGear NightHawk Router,...</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/your-own-dedi-for-5-mo-you-can-with-a-raspberry-pi-from-rpi-servers/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Your Own Dedi for $5/mo?  You Can With a Raspberry Pi From RPI Servers!\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/10/rpiservers-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Your Own Dedi for $5/mo? You Can With a Raspberry Pi From RPI Servers!</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/shields-up-protecting-your-wordpress-site-with-wordfence/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Shields Up! Protecting Your WordPress Site with Wordfence\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Shields Up! Protecting Your WordPress Site with Wordfence</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}