{"id": "3991", "post": "<div class=\"post-3991 post type-post status-publish format-standard hentry category-tutorials tag-tutorials-2\" id=\"post-3991\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/manage-multiple-servers-ansible-groups/\" rel=\"bookmark\">Managing multiple servers with Ansible groups</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \"> <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \"> June 8, 2013 @ 10:32 am, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center;\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNzEiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCAyNzEgNzAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNjZmQ0ZGIiLz48L3N2Zz4=\" loading=\"lazy\" class=\"alignnone wp-image-3957 size-full\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" alt=\"lowendtutorial\" width=\"271\" height=\"70\"></p><p>In my previous <a href=\"https://lowendbox.com/blog/getting-started-with-ansible/\">article about ansible</a>, I gave a very basic introduction to it. After reading it, you were able to create your own playbooks and apply them to a single (group of) server(s). However, ansible is much more powerful than that. It can do a lot of things with groups and individual hosts, making it easier to apply your script to a whole bunch of servers at the same time. Even if them have slightly (or completely) different configurations.</p><p>I\u2019m going to show you more about two things this time: the hosts file and the group_vars and host_vars. All these things contribute to having more and better control when applying your playbook(s) to several (or a lot of) servers.</p><p><span id=\"more-3991\"></span></p><h2>The hosts file</h2><p>The hosts file is the file where you define the hosts and groups of host you are going to target. In the previous guide, we created a hosts file that looked like this:</p><blockquote><p>[example]<br>\n192.0.2.101<br>\n192.0.2.102</p></blockquote><p>But that was just one group. You can easily define more groups the same way&nbsp; you defined the first:</p><blockquote><p>[group1]<br>\n192.0.2.101<br>\n192.0.2.102</p><p>[group2]<br>\n192.0.2.201<br>\n192.0.2.202</p></blockquote><p>This allows for you to group similar servers together, like your nameservers, your web servers and your database servers. But what if you want to address all of these at the same time? Well, there\u2019s the \u2018all\u2019 handler for that. When you want to address <em>all</em> servers in your playbook, you should make your playbook like this:</p><blockquote><p>\u2013 hosts: all<br>\nuser: mpkossen<br>\nsudo: yes</p></blockquote><p>But what if you just want to address certain groups? That\u2019s where groups with groups come in. In ansible, you can create groups of groups by using the \u2018:children\u2019 handler. When you create a group with that handler, all groups you list under it are included in the group:</p><blockquote><p>[production:children]<br>\nwebservers<br>\ndatabaseservers</p><p>[webservers]<br>\n192.0.2.101<br>\n192.0.2.102</p><p>[databaseservers]<br>\n192.0.2.201<br>\n192.0.2.202</p></blockquote><p>As you see, you can just refer to groups by their group name. This way you can compose different groups for different playbooks. In the playbook you call the group you defined with the \u2018:children\u2019 handler but without the actual handler:</p><blockquote><p>\u2013 hosts: production<br>\nuser: mpkossen<br>\nsudo: yes</p></blockquote><p>This will run on both the webservers and databaseservers groups. But instead of creating a group with children, you can also apply a playbook to multiple groups at once:</p><blockquote><p>\u2013 hosts: webservers:databaseservers<br>\nuser: mpkossen<br>\nsudo: yes</p></blockquote><p>If you want to define a lot of servers easily, there\u2019s a shortcut to help you. Say you name all your nameservers like nsX (ns1, ns2, ns3, and so on). It\u2019s a pain if you have to add them all. So here\u2019s how you solve that in the hosts file:</p><blockquote><p>[nameservers]<br>\nns[1:7].example.net</p></blockquote><p>This will include ns1.example.net, ns2.example.net, ns3.example.net and to on up to ns7.example.net.</p><p>In the playbook, simply use:</p><blockquote><p>\u2013 hosts: nameservers<br>\nuser: mpkossen<br>\nsudo: yes</p></blockquote><p>As you can see, you can really make this as bold as you want, there\u2019s no limit on the number of servers. Do note that the more servers you add, the more servers your playbook is going to get applied to and the longer it will generally take for the ansible run to complete. There are some tricks there as well, but that\u2019s for another guide.</p><p>Finally, let\u2019s look at the following situation: you have 100 servers doing the same thing and you want to edit their configuration. But you don\u2019t want to apply the changes to all at once, as you\u2019d like to see how it runs on several servers in production first. Ansible has a trick for that:</p><blockquote><p>ansible-playbook playbook.yml \u2013limit webservers[0-9]</p></blockquote><p>What we\u2019ve done here is basically tell ansible to limit the number of hosts to apply the changes to. It just grabs the first 10 hosts and applies the playbook to those. Then it stops. The \u2018\u2013limit\u2019 parameters accepts all kinds of patterns and even regular expressions. Next run, you can go on where you left off:</p><blockquote><p>ansible-playbook playbook.yml \u2013limit webservers[10-99]</p></blockquote><p>That\u2019s how easy it is!</p><p>I\u2019ve now shown you a couple of examples of how to use the hosts file optimally for multiple situations. Combine all these together and you can really build a powerful hosts file which is suitable for many situations and playbooks.</p><h2>Using host_vars and group_vars</h2><p>As soon as you have defined a host, special functionality becomes available in ansible. You can define custom variables for each group and host that you define. These variables are known as group_vars for groups and host_vars for hosts. Any variables that you define for a host or a group can be used in both playbooks and templates.</p><p>Both group_vars and host_vars are defined in their own folders, \u2018groups_vars\u2019 and \u2018host_vars\u2019, respectively. For group_vars, the file must be named exactly the same as the group. For host_vars, the file has to be named exactly the same as the host. I\u2019m going to show you an example of both.</p><p>Say you have a group \u2018nameservers\u2019 and you want to define a variable for all of them. Create an empty file first in the group_vars folder in the root of your ansible directory (where you put you playbooks):</p><blockquote><p>group_vars/nameservers</p></blockquote><p>Then add a variable to the file:</p><blockquote><p>master_server=ns1</p></blockquote><p>This makes the variable \u2018master_server\u2019 available to all playbooks that run on this group. I\u2019ll show you how to use these in your playbook in a bit.</p><p>host_vars are similar to this. Create a file first:</p><blockquote><p>host_vars/ns1.example.net</p></blockquote><p>And add a variable:</p><blockquote><p>master_server=yes</p></blockquote><p>A nice feature of these group_vars and host_vars is the usage of them in \u2018only_if\u2019. \u2018only_if\u2019 can be used in playbooks to indicate an action must only be executed if a certain condition is met. A condition is usually dependent upon a variable. That variable can be a group_var or a host_var. Let\u2019s give you an example.</p><p>Say you have one nameserver which is your master server and you want to execute a certain action in a playbook&nbsp; just on that server. The following is an action you could use, using a group_var definition:</p><blockquote><p>\u2013 name: restart bind<br>\naction: service name=bind9 state=restarted<br>\nonly_if: \u201c$ansible_hostname == $master_server\u201d</p></blockquote><p>What we did here, is use two variables. The first one is a variable that ansible collects itself, in this case the hostname (not the FQDN hostname) variable \u2018ansible_hostname\u2019. The hostname is always available as a variable. We compare it with the group_var \u2018master_server\u2019 and if they match, the action gets executed.</p><p>You can also do this with host_vars:</p><blockquote><p>\u2013 name: restart bind<br>\naction: service name=bind9 state=restarted<br>\nonly_if: \u201c$master_server == \u2018yes'\u201d</p></blockquote><p>This action only gets executed if the \u2018master_server\u2019 variable is set to \u2018yes\u2019, which is only the case for ns1.example.net.</p><p>This is just one use for variables. They are a really powerful instrument. You can also use these (and other) variables in templates, but that\u2019s something I\u2019ll cover in another tutorial!</p><h2>Final note</h2><p>I\u2019ve shown you a little bit more about ansible in this tutorial. There will definitely be more in the future! Again, ansible has really good documentation available: <a href=\"http://docs.ansible.com/\">http://docs.ansible.com/</a></p><p>For now, enjoy ansible just a bit more!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fmanage-multiple-servers-ansible-groups%2F&amp;t=Managing%20multiple%20servers%20with%20Ansible%20groups\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Managing%20multiple%20servers%20with%20Ansible%20groups&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fmanage-multiple-servers-ansible-groups%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fmanage-multiple-servers-ansible-groups%2F&amp;title=Managing%20multiple%20servers%20with%20Ansible%20groups&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/centos-6-end-of-life-is-coming-upgrade-to-a-new-centos-7-vps-now/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/centos-6-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/best-web-hosting-control-panels-after-the-cpanel-price-hike/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Best Web Hosting Control Panels after the cPanel Price Hike\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Best Web Hosting Control Panels after the cPanel Price Hike</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-plex-media-server-on-your-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Set Up Plex Media Server on Your Cheap VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/how-to-set-up-plex-media-server-on-vps-2-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Set Up Plex Media Server on Your Cheap VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-create-a-dns-server-on-debian-stretch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Create a DNS Server On Debian Stretch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Create a DNS Server On Debian Stretch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}