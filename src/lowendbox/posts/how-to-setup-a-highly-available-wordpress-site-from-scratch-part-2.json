{"id": "22994", "post": "<div class=\"post-22994 post type-post status-publish format-standard hentry category-tutorials tag-how-to tag-setup-wordpress tag-tutorial tag-wordpress tag-wordpress-setup\" id=\"post-22994\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-2/\" rel=\"bookmark\">How to Setup a Highly Available WordPress Site From Scratch, Part 2</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/how-to/\" rel=\"tag\">how to</a>, <a href=\"https://lowendbox.com/tag/setup-wordpress/\" rel=\"tag\">setup wordpress</a>, <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a>, <a href=\"https://lowendbox.com/tag/wordpress/\" rel=\"tag\">wordpress</a>, <a href=\"https://lowendbox.com/tag/wordpress-setup/\" rel=\"tag\">wordpress setup</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> December 18, 2020 @ 12:00 am, by raindog308</div><div class=\"storycontent tablelook\"><p><a target=\"_blank\" rel=\"noopener noreferrer\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2021/04/highly-available-wordpress-part2.jpg.webp\" loading=\"lazy\" class=\"screenshot litespeed-loaded\" title=\"How to Setup a Highly Available WordPress Site From Scratch, Part 2\" data-src=\"https://lowendbox.com/wp-content/uploads/2021/04/highly-available-wordpress-part2.jpg.webp\" alt=\"How to Setup a Highly Available WordPress Site From Scratch, Part 2\" width=\"410\" height=\"224\" data-was-processed=\"true\"></a>In this tutorial series, we are setting up a highly available WordPress web site from scratch.</p><p><a href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-1/\">Part 1 \u2013 Introduction, Considerations, and Architecture</a><br>\nPart 2 \u2013 Setting Up the VPSes<br>\nPart 3 \u2013 Setting Up MariaDB Multi-Master Replication<br>\nPart 4 \u2013 File Replication and Setting Up DRBD<br>\nPart 5 \u2013 Setting Up OCFS2<br>\nPart 6 \u2013 Round-Robin DNS, Let\u2019s Encrypt, &amp; Conclusion</p><h1 class=\"p1\"><span class=\"s1\">Setting Up the VPSes</span></h1><p class=\"p1\"><span class=\"s1\">Here is our setup:</span></p><ul><li class=\"p1\"><span class=\"s1\">web1.lowend.party and web2.lowend.party are the two nodes, both running Debian 10 x64.&nbsp;</span></li><li class=\"p1\"><span class=\"s1\">www.lowend.party will be the URL that is highly available.</span></li><li class=\"p1\"><span class=\"s1\">We\u2019re using WordPress 5 running on MariaDB.<span class=\"Apple-converted-space\">&nbsp; </span>Since this is a tutorial on HA and not on web design, we\u2019re just going to use the stock WP theme and not spend much time on prettifying the site.</span></li><li class=\"p1\"><span class=\"s1\">In this tutorial, I will use 1.1.1.1 to represent web1.lowend.party\u2019s IP, and 2.2.2.2 to represent web2.lowend.party\u2019s IP.</span></li></ul><p class=\"p1\"><span class=\"s1\">Here is a checklist of what was done to setup the web sites.<span class=\"Apple-converted-space\">&nbsp; </span>This was done on both nodes.<span class=\"Apple-converted-space\">&nbsp; </span>Note that there are many other things one should do for a production site \u2013 setup an active firewall, setup backups, configuring mail, etc.<span class=\"Apple-converted-space\">&nbsp; </span>But this is just a tutorial focused on HA WordPress.</span></p><p class=\"p1\"><span class=\"s1\">DNS is not listed as we\u2019ll cover that in more detail.</span></p><p class=\"p1\"><span class=\"s1\">The checklist:</span></p><ul><li class=\"p1\"><span class=\"s1\">provisioned the VPSes (with embedded ssh key for root)</span></li><li class=\"p1\"><span class=\"s1\">dpkg-reconfigure locales (or use locale-gen)</span></li><li class=\"p1\"><span class=\"s1\">dpkg-reconfigure tzdata (to set my preferred timezone, or you can use timedatectl)</span></li><li class=\"p1\"><span class=\"s1\">set hostname in /etc/hostname (a Linode-ism)</span></li><li class=\"p1\"><span class=\"s1\">apt-get update &amp;&amp; apt-get -y upgrade</span></li><li class=\"p1\"><span class=\"s1\">apt-get install nginx mariadb-server php-fpm php-mysql</span></li><li class=\"p1\"><span class=\"s1\">ran mysql_secure_installation</span></li></ul><p><span id=\"more-22994\"></span></p><h1 class=\"p1\"><span class=\"s1\">Database Setup</span></h1><p class=\"p1\"><span class=\"s1\">I created a database and user for WordPress on both nodes:</span></p><pre class=\"p1\"><span class=\"s1\"># mysql</span>\n\n<span class=\"s1\">MariaDB [(none)]&gt; create database wp;</span>\n<span class=\"s1\">Query OK, 1 row affected (0.000 sec)</span>\n\n<span class=\"s1\">MariaDB [(none)]&gt; create user 'wp'@'localhost' identified by 'complexpassword';</span>\n<span class=\"s1\">Query OK, 0 rows affected (0.001 sec)</span>\n\n<span class=\"s1\">MariaDB [(none)]&gt; grant all on wp.* to 'wp'@'localhost';</span>\n<span class=\"s1\">Query OK, 0 rows affected (0.000 sec)</span>\n\n<span class=\"s1\">MariaDB [(none)]&gt; flush privileges;</span>\n<span class=\"s1\">Query OK, 0 rows affected (0.000 sec)</span></pre><h1 class=\"p1\"><span class=\"s1\">Web Site (nginx) Configuration</span></h1><p class=\"p1\"><span class=\"s1\">I created /web/www.lowend.party as my web root created appropriate log files in /var/log/nginx and set /etc/logrotate.d to handle them:</span></p><pre class=\"p1\"><span class=\"s1\"># mkdir -p /web/www.lowend.party</span>\n<span class=\"s1\"># mkdir -p /var/log/nginx/www.lowend.party</span>\n<span class=\"s1\"># chown www-data:adm /var/log/nginx/www.lowend.party/</span>\n<span class=\"s1\"># cp /etc/logrotate.d/nginx /etc/logrotate.d/nginx_web_dirs</span>\n<span class=\"s1\"># sed -i 's#nginx/\\*.log#nginx/\\*/\\*.log#' /etc/nginx/nginx_web_dirs</span></pre><p class=\"p1\"><span class=\"s1\">That last sed command changes \u201c/var/log/nginx/*.log\u201d to \u201c/var/log/nginx/*/*.log\u201d so the per-domain logs in /var/log/nginx/www.lowend.party are rotated.</span></p><p class=\"p1\"><span class=\"s1\">Next I setup the nginx config as follows.<span class=\"Apple-converted-space\">&nbsp; </span>This is using php-fpm for php support.<span class=\"Apple-converted-space\">&nbsp; </span>Here is /etc/nginx/sites-available/www.lowend.party:</span></p><pre class=\"p1\"><span class=\"s1\">server {</span>\n<span class=\"s1\">  server_name www.lowend.party;</span>\n<span class=\"s1\">  access_log /var/log/nginx/www.lowend.party/access.log;</span>\n<span class=\"s1\">  error_log /var/log/nginx/www.lowend.party/error.log;</span>\n<span class=\"s1\">\n  location ~ \\.php$ {</span>\n<span class=\"s1\">    fastcgi_split_path_info ^(.+\\.php)(.*)$;</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>include /etc/nginx/fastcgi_params;</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>fastcgi_pass unix:/run/php/php7.3-fpm.sock;</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>fastcgi_index index.php;</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>fastcgi_param<span class=\"Apple-converted-space\">&nbsp; </span>SCRIPT_FILENAME<span class=\"Apple-converted-space\">&nbsp; </span>/web/www.lowend.party$fastcgi_script_name;</span>\n<span class=\"s1\">  }</span>\n\n<span class=\"s1\"><span class=\"Apple-converted-space\">&nbsp; </span>location / {</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>root <span class=\"Apple-converted-space\">&nbsp; </span>/web/www.lowend.party;</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>index<span class=\"Apple-converted-space\">&nbsp; </span>index.php index.html;</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>try_files $uri $uri/ /index.php;</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; </span>if (!-e $request_filename) {</span>\n<span class=\"s1\"><span class=\"Apple-converted-space\">  &nbsp; &nbsp; </span>rewrite . /index.php last;</span>\n<span class=\"s1\">    }</span>\n<span class=\"s1\">  }</span>\n<span class=\"s1\">}</span></pre><p class=\"p1\"><span class=\"s1\">Note that we\u2019re not doing https yet.<span class=\"Apple-converted-space\">&nbsp; </span>Fear not \u2013 we will get there but not until we\u2019ve got DRBD up and running.</span></p><p class=\"p1\"><span class=\"s1\">Finally I brought the site up:</span></p><pre class=\"p1\"><span class=\"s1\"># ln -s /etc/nginx/sites-available/www.lowend.party /etc/nginx/sites-enabled/www.lowend.party</span>\n<span class=\"s1\"># systemctl restart nginx</span></pre><h1 class=\"p1\"><span class=\"s1\">Setting up WordPress on web1</span></h1><p class=\"p1\"><span class=\"s1\">Setting up WordPress itself is quite simple, but how to get it up and running when we haven\u2019t created the www.lowend.party record yet?<span class=\"Apple-converted-space\">&nbsp; </span>The easiest way was to manipulate my local PC\u2019s hosts file to override DNS</span></p><p class=\"p1\"><span class=\"s1\">On Windows this would be c:\\windows\\system32\\drivers\\etc\\hosts while on Mac or Linux it\u2019s /etc/hosts.<span class=\"Apple-converted-space\">&nbsp; </span>I created this temporary entry:</span></p><pre class=\"p1\"><span class=\"s1\">1.1.1.1<span class=\"Apple-converted-space\">&nbsp; </span>www.lowend.party</span></pre><p class=\"p1\"><span class=\"s1\">Then ran the WordPress installer.<span class=\"Apple-converted-space\">&nbsp; </span>It\u2019s just answering questions but if you need a guide, one is available from wordpress.org.<span class=\"Apple-converted-space\">&nbsp; </span>https://wordpress.org/support/article/how-to-install-wordpress/</span></p><p class=\"p1\"><span class=\"s1\">In the words of Bon Jovi, whoa-oh, we\u2019re halfway there.<span class=\"Apple-converted-space\">&nbsp; </span>WP is up and running on one node.<span class=\"Apple-converted-space\">&nbsp; </span>What about the next one?</span></p><h1 class=\"p1\"><span class=\"s1\">Setting up WordPress on web2</span></h1><p class=\"p1\"><span class=\"s1\">There\u2019s no need to setup everything on web2 manually.<span class=\"Apple-converted-space\">&nbsp; </span>They\u2019re both the same distro running the same software.</span></p><p class=\"p1\"><span class=\"s1\">Copy over the web directory.&nbsp; On node1:</span></p><pre class=\"p1\"><span class=\"s1\">scp -rp /web web2.lowend.party:/</span></pre><p class=\"p1\"><span class=\"s1\">Copy over the nginx site definition:</span></p><pre class=\"p1\"><span class=\"s1\">scp /etc/nginx/sites-available/www.lowend.party web2.lowend.party:/etc/nginx/sites-available</span></pre><p class=\"p1\"><span class=\"s1\">Setup logging on web2:</span></p><pre class=\"p1\"><span class=\"s1\"># mkdir -p /var/log/nginx/www.lowend.party\n</span><span class=\"s1\"># chown www-data:adm /var/log/nginx/www.lowend.party/\n</span><span class=\"s1\"># cp /etc/logrotate.d/nginx /etc/logrotate.d/nginx_web_dirs\n</span><span class=\"s1\"># sed -i 's#nginx/\\*.log#nginx/\\*/\\*.log#' /etc/nginx/nginx_web_dirs</span></pre><p class=\"p1\"><span class=\"s1\">Make the site live on web2:<br>\n</span></p><pre class=\"p1\"><span class=\"s1\"># ln -s /etc/nginx/sites-available/www.lowend.party /etc/nginx/sites-enabled/www.lowend.party\n</span><span class=\"s1\"># systemctl restart nginx</span></pre><h1 class=\"p1\"><span class=\"s1\">Copying the MySQL Database</span></h1><p class=\"p1\"><span class=\"s1\">On web1, backup the WordPress database using mysqldump:</span></p><pre class=\"p1\"><span class=\"s1\">mysqldump wp &gt; /tmp/wp.sql</span></pre><p class=\"p1\"><span class=\"s1\">Create the WordPress database and user on web2:</span></p><pre class=\"p1\"><span class=\"s1\">MariaDB [(none)]&gt; create database wp;</span>\n<span class=\"s1\">Query OK, 1 row affected (0.000 sec)</span>\n<span class=\"s1\">\nMariaDB [(none)]&gt; create user 'wp'@'localhost' identified by 'complexpassword';</span>\n<span class=\"s1\">Query OK, 0 rows affected (0.001 sec)</span>\n<span class=\"s1\">\nMariaDB [(none)]&gt; grant all on wp.* to 'wp'@'localhost';</span>\n<span class=\"s1\">Query OK, 0 rows affected (0.000 sec)</span>\n<span class=\"s1\">\nMariaDB [(none)]&gt; flush privileges;</span>\n<span class=\"s1\">Query OK, 0 rows affected (0.000 sec)</span></pre><p class=\"p1\"><span class=\"s1\">Now restore the wp database:</span></p><pre class=\"p1\"><span class=\"s1\"># mysql wp &lt; /tmp/wp.sql</span></pre><p class=\"p1\"><span class=\"s1\">I then changed my local hosts file to point at web2, and the site looks identical to how it will appear on web1.</span></p><p class=\"p1\"><span class=\"s1\">At this point, we have WordPress up and running on two sites.<span class=\"Apple-converted-space\">&nbsp; </span>If this was a static site, we\u2019d be done.<span class=\"Apple-converted-space\">&nbsp; </span>But because we\u2019re using WordPress, we need to make both the database and web filesystem (where themes, uploads, etc. are stored) synchronized.</span></p><p><strong>Next Part: <span class=\"s1\">Part 3 \u2013 Setting Up MariaDB Multi-Master Replication</span></strong></p><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/cloudean-debuts-with-worldwide-shared-email-and-wordpress-hosting-shared-as-cheap-as-e0-998-month/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Cloudean Debuts with Worldwide Shared, Email, and WordPress Hosting! (Shared as Cheap as \u20ac0.998/mont...\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/12/cloudean-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Cloudean Debuts with Worldwide Shared, Email, and WordPress Hosting! (Shared as Cheap as \u20ac0.998/mont...</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/automated-plugin-installers-for-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Automated Plugin Installers for VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/automated-plugin-installers-for-vps-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Automated Plugin Installers for VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-setup-a-highly-available-wordpress-site-from-scratch-part-1/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Setup a Highly Available WordPress Site From Scratch, Part 1\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/05/highly-available-wordpress-part-1-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Setup a Highly Available WordPress Site From Scratch, Part 1</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-keep-your-wordpress-site-secure/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Keep your WordPress Site Secure\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/06/how-to-keep-your-wordpress-site-secure-150x150.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Keep Your WordPress Site Secure</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/raindog308/\" title=\"All posts by raindog308\" rel=\"author\">raindog308</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/4ce3b8640a70e05bd73ac25b8a37821c?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"https://www.lowendtalk.com/profile/raindog308\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\">I'm Andrew, techno polymath and long-time LowEndTalk community Moderator. My technical interests include all things Unix, perl, python, shell scripting, and relational database systems. I enjoy writing technical articles here on LowEndBox to help people get more out of their VPSes.</p></div></div><div class=\"feedback\"></div></div>"}