{"id": "4204", "post": "<div class=\"post-4204 post type-post status-publish format-standard hentry category-tutorials tag-iptables tag-tutorials-2\" id=\"post-4204\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/iptables-ipv6-and-more-rules/\" rel=\"bookmark\">IPtables: IPv6 and more rules</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"/media/icons/tag_green.png\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> <a href=\"https://lowendbox.com/tag/iptables/\" rel=\"tag\">iptables</a>, <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"https://lowendbox.com/media/icons/calendar.png\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \" class=\"litespeed-loaded\" data-was-processed=\"true\"> August 17, 2013 @ 9:48 am, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center;\"><a href=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png\"><img data-lazyloaded=\"1\" src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" loading=\"lazy\" class=\"alignnone size-full wp-image-3957 litespeed-loaded\" alt=\"lowendtutorial\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" width=\"271\" height=\"70\" data-was-processed=\"true\"></a></p><p>This is the last tutorial in a series of iptables tutorials. Last week I\u2019ve shown you how to persist iptables. The week before that I gave a short introduction. I now want to finish that series with talking about IPv6 and adding more (advanced) rules.</p><p><span id=\"more-4204\"></span></p><h2>IPv6</h2><p>iptables is not compatible with IPv6 because of the vastly different packets IPv6 has compared to IPv4. ip6tables, on the other hand, <em>is</em> compatible and handles the job just as fine as iptables. But having a seperate program for IPv6 means having seperate rules. And having different packets compared to IPv4 means having different rule options (for example ICMP vs ICMPv6).</p><p>Basically, you can close your server down with IPtables and then have it completely exposed with IPv6 because your ip6tables are not in order. To prevent this, you should add the rules you add to iptables to ip6tables as well, as far as they are compatible. Luckily, this is the case for most rules (except for source and destination addresses, naturally).</p><h3>Working with ip6tables</h3><p>To check your current ip6tables, run:</p><blockquote><p>sudo ip6tables -L</p></blockquote><p>Just as with IPtables, this should output:</p><blockquote><p>mpkossen@host:~$ sudo ip6tables -L<br>\nChain INPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p><p>Chain FORWARD (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p><p>Chain OUTPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination<br>\nmpkossen@host:~$</p></blockquote><p>Now, if we just add a rule to it like we did last times with iptables, it changes in exactly the same way. The difference between iptables and ip6tables is going to show when you add an ACCEPT or DROP rule with an IPv6 address in it.</p><p>So, let\u2019s add a rule which <em>does</em> show that difference:</p><blockquote><p>sudo ip6tables -A INPUT -s 2001:db8:1f0a:3ec::2 -j DROP</p></blockquote><p>No worries, you\u2019ve just blocked an IP address reserved for documentation purposes. If you list your ip6tables now, it should show you this:</p><blockquote><p>mpkossen@host:~$ sudo ip6tables -L<br>\nChain INPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination<br>\nDROP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2001:db8:1f0a:3ec::2/128&nbsp; anywhere</p><p>Chain FORWARD (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p><p>Chain OUTPUT (policy ACCEPT)<br>\ntarget&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination<br>\nmpkossen@host:~$</p></blockquote><p>As you see, not much difference between iptables and ip6tables. Basically just the addresses. The difference will show a bit more if you want to allow or block ICMP traffic, as there are some different protocols for IPv6. The rule of thumb, however, is to just add a \u20186\u2019 after the \u2018ip\u2019 part in iptables commands and you should be good.</p><h3>Persistence</h3><p>So, where do we persist these rules? The infrastructure is already in place if you have followed my previous guide.</p><p>For CentOS, ip6tables rules are stored in /etc/sysconfig/ip6tables or saved with the following command:</p><blockquote><p>sudo /etc/init.d/ip6tables save</p></blockquote><p>On Ubuntu, with the persistent-iptables package, the ip6tables rules are saved in /etc/iptables/rules.v6. The save command is the same for iptables and ip6tables:</p><blockquote><p>sudo /etc/init.d/iptables-persistent save</p></blockquote><p>So, that\u2019s it! Persisting ip6tables is just as easy as persisting iptables.</p><h2>More rules</h2><p>Allowing traffic to port 80 and 443 in a closed firewall (policy DROP) is quite straight-forward. The same applies to port 22 (SSH). Allowing ping, however, is something different. It doesn\u2019t go to a certain port, so allowing it through the firewall requires more advances iptables rules.</p><p>To allow IPv4 ping through your firewall, run the following commands (or add them as rules to your persistence file):</p><blockquote><p>sudo iptables -A INPUT -p icmp \u2013icmp-type 8 -m state \u2013state NEW -j ACCEPT<br>\nsudo iptables -A OUTPUT -p icmp \u2013icmp-type 0 -m state \u2013state ESTABLISHED,RELATED -j ACCEPT</p></blockquote><p>There\u2019s a couple of new things here. Let\u2019s start at the beginning, with the first command:</p><blockquote><p>sudo iptables -A INPUT -p icmp \u2013icmp-type 8 -m state \u2013state NEW -j ACCEPT</p></blockquote><p>We add a rule to the INPUT chain for the \u2018icmp\u2019 protocol (-p). We then pass a protocol-related option (\u2013icmp-type) which indicates which type of ICMP to allow. In this case it\u2019s 8, which is an \u2018echo\u2019 packet, which is used for ping. Next is the \u2018state\u2019 extension, which is loaded with -m. This extension allows to require the connection to have a certain state (\u2013state). In this case we allow NEW incoming connections.</p><p>So, summarized, we narrowed it down to allow packets that meets the following requirements:</p><ul><li>Protocol: ICMP</li><li>ICMP type: 8</li><li>Connection type: NEW</li></ul><p>Which boils down to ping being allow to come in.</p><p>Next, we add the role to allow the response to go out, otherwise your server would seem down when you ping it from the outside:</p><blockquote><p>sudo iptables -A OUTPUT -p icmp \u2013icmp-type 0 -m state \u2013state ESTABLISHED,RELATED -j ACCEPT</p></blockquote><p>This rule is basically the same as the rule above, except for three things:</p><ul><li>It is added to the OUTPUT chain</li><li>It allows ICMP type 0 (echo reply)</li><li>It only allows ESTABLISHED or RELATED connections</li></ul><p>An \u2018echo reply\u2019 packet is always sent in response to an \u2018echo\u2019 packet, so there should always be an established or related connection.</p><p>So, now you know how to allow incoming PING requests but also how to work with different protocols, options and connection states. If you use the iptables man-pages, you can allow virtually any type of packet through without allowing too much packets through. A nice challenge is allowing outgoing PING from a server with a closed firewall. Give it a shot! I\u2019ll give you one hint: it\u2019s easy.</p><p><em>As one commenter correctly noted (thanks, Olipro), the \u2018state\u2019 extension contains a subset of connection states from the \u2018conntrack\u2019 extension and has been marked as \u2018obsolete\u2019 from iptables 1.4.17 and up. While not many distributions have that version of iptables yet, it is worth to note how the \u2018conntrack\u2019 extension works compared to the \u2018state\u2019 extension. The following is an example of the above commands using the \u2018conntrack\u2019 extension:</em></p><blockquote><p><em>sudo iptables -A INPUT -p icmp \u2013icmp-type 8 -m conntrack&nbsp;\u2013ctstate NEW -j ACCEPT</em><br>\n<em> sudo iptables -A OUTPUT -p icmp \u2013icmp-type 0 -m&nbsp;conntrack \u2013ctstate ESTABLISHED,RELATED -j ACCEPT</em></p></blockquote><p><em>The \u2018conntrack\u2019 extension is available for use in most versions of iptables and it is probably wise to start using it straight away. However, a lot of the available documentation online (including some of Netfilter\u2019s official HOWTOs) still use the \u2018state\u2019 extension. Now you know both, but should keep in mind to use \u2018conntrack\u2019 rather than \u2018state\u2019 for compatibility with future iptables versions!</em></p><h2>Final notes</h2><p>There\u2019s (still) a lot more to learn about iptables, so I suggest you read the man-pages for more information, as they are a good source of information. Also, in this case, Google <em>is</em> your friend. iptables is established software so there\u2019s plenty to be found about it.</p><p>This concludes my series of iptables-related tutorials, which are part of a bigger series of security-related tutorials. I\u2019ll be picking up on that later.</p><p><span style=\"text-decoration: underline;\">Up next week</span>: how to create your own mail server with Virtualmin!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fiptables-ipv6-and-more-rules%2F&amp;t=IPtables%3A%20IPv6%20and%20more%20rules\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=IPtables%3A%20IPv6%20and%20more%20rules&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fiptables-ipv6-and-more-rules%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fiptables-ipv6-and-more-rules%2F&amp;title=IPtables%3A%20IPv6%20and%20more%20rules&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">0</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/centos-6-end-of-life-is-coming-upgrade-to-a-new-centos-7-vps-now/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/centos-6-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">CentOS 6 End of Life is Coming! Upgrade to a new CentOS 7 VPS Now</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/best-web-hosting-control-panels-after-the-cpanel-price-hike/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Best Web Hosting Control Panels after the cPanel Price Hike\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Best Web Hosting Control Panels after the cPanel Price Hike</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-plex-media-server-on-your-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Set Up Plex Media Server on Your Cheap VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/how-to-set-up-plex-media-server-on-vps-2-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Set Up Plex Media Server on Your Cheap VPS</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-create-a-dns-server-on-debian-stretch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Create a DNS Server On Debian Stretch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Create a DNS Server On Debian Stretch</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}