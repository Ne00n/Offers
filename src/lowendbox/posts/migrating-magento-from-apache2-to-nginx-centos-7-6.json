{"id": "19587", "post": "<div class=\"post-19587 post type-post status-publish format-standard hentry category-virtual-servers category-tutorials tag-apache2 tag-http tag-https tag-magento tag-nginx tag-php-fpm\" id=\"post-19587\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/migrating-magento-from-apache2-to-nginx-centos-7-6/\" rel=\"bookmark\">Migrating a Magento Installation from Apache2 to NGINX on CentOS 7.6</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \"> <a href=\"https://lowendbox.com/tag/apache2/\" rel=\"tag\">Apache2</a>, <a href=\"https://lowendbox.com/tag/http/\" rel=\"tag\">HTTP</a>, <a href=\"https://lowendbox.com/tag/https/\" rel=\"tag\">HTTPS</a>, <a href=\"https://lowendbox.com/tag/magento/\" rel=\"tag\">Magento</a>, <a href=\"https://lowendbox.com/tag/nginx/\" rel=\"tag\">nginx</a>, <a href=\"https://lowendbox.com/tag/php-fpm/\" rel=\"tag\">PHP-FPM</a> <img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \"> May 20, 2019 @ 3:52 pm, by Liam</div><div class=\"storycontent tablelook\"><h2><a id=\"Introduction_2\"></a>Introduction</h2><p><a href=\"https://magento.com/\">Magento</a> is one of the worlds leading e-commerce CMS solutions and is used by over 200K websites. What makes Magento such an appealing e-commerce CMS is that Magento offers a free, community edition of their platform. Anyone with some Linux knowledge and access to a modest virtual machine can get their online store up and running in no time. Magento runs on a Linux stack giving wide flexibility on the open source components that are used to power the store. The typical first choice for a Linux web server is usually <a href=\"https://httpd.apache.org/\">Apache</a> which makes for a stable and dependable choice. However, there are other options that can offer greater performance with lower system resource usage. One popular such alternative is <a href=\"https://nginx.org/\">NGINX</a>.</p><p><span id=\"more-19587\"></span></p><p>In this guide, we will walk through the process of migrating an existing Magento installation from Apache to NGINX on Debian Stretch.</p><h2><a id=\"Prerequisites_7\"></a>Prerequisites</h2><p>In order to follow this guide you will need the following:</p><ul><li>A Debian Stretch Server</li><li>A Magento installation.</li><li>A non-root sudo user account on the Magento server.</li></ul><p>In order to begin this guide, you need to log into your server as a non-root sudo enabled user.</p><h2><a id=\"Put_Magento_in_Maintenance_Mode_15\"></a>Put Magento in Maintenance Mode</h2><p>During this guide, we will be stopping and starting the web servers which will make your Magento store appear and disappear for any user accessing it. This is not a great experience for your clients we will avoid this issue by putting Magento into maintenance mode. When Magento is in maintenance mode any visitor will see a holding page and will not be able to interact with your store.</p><p>You put Magento into maintenance mode by running the following command:</p><pre><code>sudo php /path/to/magento2/bin/magento maintenance:enable --ip=&lt;YOUR IP&gt;\n</code></pre><p>The <code>--ip=&lt;YOUR IP&gt;</code> option will allow you to access your store from your IP whilst all other IP\u2019s will see the maintenance page. This will allow you to view and check that the store is working whilst still maintaining maintenance mode for visitors.</p><p>Now that Magento is in maintenance mode we can install NGINX.</p><h2><a id=\"Installation_NGINX_and_PHPFPM_28\"></a>Installation NGINX and PHP-FPM</h2><p>In this step, we will install NGINX and the <a href=\"https://php-fpm.org/\">PHP-FPM</a> packages. NGINX uses PHP-FPM which is a performant re-implementation of standard PHP. If you are already using PHP-FPM with Apache you can remove it from the <code>apt-get install</code> command but leaving it in place will not cause a problem.</p><p>We should stop Apache here or the installation will encounter an error when APT attempts to start NGINX while Apache is running. The following commands will stop Apache running and disable it from stating on boot:</p><pre><code>sudo systemctl stop apache2.service\nsudo systemctl disable apache2.service\n</code></pre><p>Run the following command to install NGINX and PHP-FPM:</p><pre><code>sudo apt-get install nginx php-fpm\n</code></pre><p>NGINX is now installed and ready for configuration.</p><h2><a id=\"Migrating_an_HTTP_Only_Magento_Instance_46\"></a>Migrating an HTTP Only Magento Instance</h2><p>In this step, we will configure NGINX to serve only an HTTP Magento instance. If your Magento instance uses HTTPS then skip ahead to the next section which covers migrating an HTTPS Magento instance.</p><p>NGINX works like Apache in that it has two directories <code>/etc/nginx/sites-available</code> and <code>/etc/nginx/sites-enabled</code> that contain the web server configuration to serve your store. We will first place the configuration file into <code>/etc/nginx/sites-available</code> and then create a symlink to that file in <code>/etc/nginx/sites-enabled</code> which will allow NGINX to start serving your site.</p><p>We will create and edit the site configuration file using a text editor. I will use nano throughout this guide but you can use whichever you are most comfortable with:</p><pre><code>sudo nano /etc/nginx/sites-available/magento.conf\n</code></pre><p>The contents of this file should look like the following basic example (remember you need to change <code>exmaple.com</code> and <code>/var/www/magento2</code> to match your setup):</p><pre><code>server {\n   listen 80;\n   server_name &lt;YOUR STORE URL&gt;;\n   set $MAGE_ROOT /path/to/magento2;\n   include /path/to/magento2/nginx.conf.sample;\n}\n\nupstream fastcgi_backend {\n   server  unix:/var/run/php/php7.0-fpm.sock;\n}\n</code></pre><p>The above configuration assumes that you are using PHP 7.0 (the default) on your server. If you are using a different version then you will need to edit the line <code>server unix:/var/run/php/php7.1-fpm.sock;</code> to match the version of PHP and PHP-FPM you are using. If you run:</p><pre><code>ls /var/run/php/\n</code></pre><p>You will be able to see the name of the PHP-FPM socket that you need to use.</p><p>The following line:</p><pre><code>include /path/to/magento2/nginx.conf.sample;\n</code></pre><p>Causes NGINX to load additional configuration contained in the file <code>/path/to/magento2/nginx.conf.sample</code>. This file is supplied by Magento and contains very important additional configuration such as blocking access to confidential files, setting compression, etc. If you don\u2019t have a copy of this file you can download one from these locations:</p><ul><li>Magento 2.2 \u2013 <a href=\"https://github.com/magento/magento2/blob/2.2/nginx.conf.sample\">https://github.com/magento/magento2/blob/2.2/nginx.conf.sample</a></li><li>Magento 2.3 \u2013 <a href=\"https://github.com/magento/magento2/blob/2.3/nginx.conf.sample\">https://github.com/magento/magento2/blob/2.3/nginx.conf.sample</a></li></ul><p>You will need to include this file for this NGINX configuration file to serve your store.</p><p>Now that the configuration file is in place we need to enable it by creating a symlink from <code>sites-enabled</code> with the following command:</p><pre><code>sudo ln -s /etc/nginx/sites-available/magento.conf /etc/nginx/sites-enabled/\n</code></pre><p>Then reload NGINX:</p><pre><code>sudo systemctl reload nginx.service\n</code></pre><p>NGINX should now be serving your store. You should visit your store in a browser to check that it is working normally. If your site does not render correctly after the migration it is quite likely because of stale cache and indexed data. Flushing the cache and re-indexing the site with these two commands will resolve this issue:</p><pre><code>sudo php /path/to/magento2/bin/magento cache:flush\nsudo php /path/to/magento2/bin/magento indexer:reindex\n</code></pre><p>The site should now be working normally. You should visit both the home page and the admin pages to ensure they are working as expected. The following command will disable maintenance mode and resume normal site operation:</p><pre><code>sudo php /path/to/magento2/bin/magento maintenance:disable\n</code></pre><p>Your Magento instance is now migrated to using NGINX as its webserver.</p><h2><a id=\"Migrating_An_HTTPS_Magento_Instance_120\"></a>Migrating An HTTPS Magento Instance</h2><p>In this step, we will configure NGINX to serve an HTTPS enabled Magento instance. NGINX works like Apache in that it has two directories <code>/etc/nginx/sites-available</code> and <code>/etc/nginx/sites-enabled</code> that contain the website configuration. We will first place the configuration file into <code>/etc/nginx/sites-available</code> and then create a symlink to that file in <code>/etc/nginx/sites-enabled</code> which will enable NGINX to start serving your store.</p><p>We will create and edit the site configuration file using a text editor. I will use nano throughout this guide but you can use whichever you are most comfortable with:</p><pre><code>sudo nano /etc/nginx/sites-available/magento.conf\n</code></pre><p>The following file will serve an HTTPS site. The first <code>server</code> block will automatically redirect any visitors arriving on HTTP to the HTTPS site:</p><pre><code>server {\n    listen 80;\n    server_name &lt;YOUR STORE URL&gt;;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl;\n    server_name &lt;YOUR STORE URL&gt;;\n\n    ssl on;\n    ssl_certificate /path/to/fullchain.pem;\n    ssl_certificate_key /path/to/privkey.pem;\n\n    set $MAGE_ROOT /path/to/magento2;\n    include /path/to/magento2/nginx.conf.sample;\n}\n\nupstream fastcgi_backend {\n        server  unix:/run/php/php7.0-fpm.sock;\n}\n</code></pre><p>The above configuration assumes that you are using PHP 7.0 (the default) on your server. If you are using a different version then you will need to edit the line <code>server unix:/var/run/php/php7.1-fpm.sock;</code> to match the version of PHP and PHP-FPM you are using. If you run:</p><pre><code>ls /var/run/php/\n</code></pre><p>You will be able to see the name of the PHP-FPM socket that you need to use.</p><p>The following line:</p><pre><code>include /path/to/magento2/nginx.conf.sample;\n</code></pre><p>causes NGINX to load additional configuration contained in the file <code>/path/to/magento2/nginx.conf.sample</code>. This file is supplied by Magento and contains very important additional configuration such as blocking access to confidential files, setting compression etc. If you don\u2019t have a copy of this file you can download one from these locations:</p><ul><li>Magento 2.2 \u2013 <a href=\"https://github.com/magento/magento2/blob/2.2/nginx.conf.sample\">https://github.com/magento/magento2/blob/2.2/nginx.conf.sample</a></li><li>Magento 2.3 \u2013 <a href=\"https://github.com/magento/magento2/blob/2.3/nginx.conf.sample\">https://github.com/magento/magento2/blob/2.3/nginx.conf.sample</a></li></ul><p>You will need to include this file for this NGINX configuration file to serve your store.</p><p>Now that the configuration file is in place we need to enable it by creating a symlink from <code>sites-enabled</code> with the following command:</p><pre><code>sudo ln -s /etc/nginx/sites-available/magento.conf /etc/nginx/sites-enabled/\n</code></pre><p>Then reload NGINX:</p><pre><code>sudo systemctl reload nginx.service\n</code></pre><p>NGINX should now be serving your store. You should visit your store in a browser to check that it is working normally. If your site does not render correctly after the migration it is quite likely because of stale cache and indexed data. Flushing the cache and re-indexing the site with these two commands will resolve this issue:</p><pre><code>sudo php /path/to/magento2/bin/magento cache:flush\nsudo php /path/to/magento2/bin/magento indexer:reindex\n</code></pre><p>The site should now be working normally. You should visit both the home page and the admin pages to ensure they are working as expected. The following command will disable maintenance mode and resume normal site operation:</p><pre><code>sudo php /path/to/magento2/bin/magento maintenance:disable\n</code></pre><h2><a id=\"Conclusion_201\"></a>Conclusion</h2><p>Your site should now be running normally and taking advantage of the increased performance and reduced resource requirements of NGINX. If you need additional information on configuration and tuning NGINX their documentation can be found on their website <a href=\"https://nginx.org/en/docs/\">here</a>.</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fmigrating-magento-from-apache2-to-nginx-centos-7-6%2F&amp;t=Migrating%20a%20Magento%20Installation%20from%20Apache2%20to%20NGINX%20on%20CentOS%207.6\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Migrating%20a%20Magento%20Installation%20from%20Apache2%20to%20NGINX%20on%20CentOS%207.6&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fmigrating-magento-from-apache2-to-nginx-centos-7-6%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fmigrating-magento-from-apache2-to-nginx-centos-7-6%2F&amp;title=Migrating%20a%20Magento%20Installation%20from%20Apache2%20to%20NGINX%20on%20CentOS%207.6&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">1</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/nginx-vs-openlitespeed-vs-apache/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Nginx vs. OpenLiteSpeed vs. Apache\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/nginx-vs-openlitespeed-vs-apache-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Nginx vs. OpenLiteSpeed vs. Apache</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-configure-reverse-proxy-with-nginx/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How to Configure Reverse Proxy with NGINX\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How to Configure Reverse Proxy with NGINX</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/from-zero-to-encrypted-with-nginx-and-lets-encrypt/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Free SSL with NGINX and LetsEncrypt on Debian 10\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/nginx-and-lets-encrypt-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Free SSL with NGINX and LetsEncrypt on Debian 10</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/how-to-set-up-a-node-js-application-for-production-on-a-debian-9-vps/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"How To Set Up a Node.js Application for Production on a Debian 9 VPS\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/leb-centered-small.jpg) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">How To Set Up a Node.js Application for Production on a Debian 9 VPS</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/liam/\" title=\"All posts by Liam\" rel=\"author\">Liam</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/2a78fb56721359b1d81ed05edb5a734f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/2a78fb56721359b1d81ed05edb5a734f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><a target=\"_blank\" rel=\"nofollow noopener noreferrer\" href=\"http://www.lowendbox.com\" class=\"bio-icon bio-icon-website\"></a><p class=\"bio-description\"></p></div></div><div class=\"feedback\"></div></div>"}