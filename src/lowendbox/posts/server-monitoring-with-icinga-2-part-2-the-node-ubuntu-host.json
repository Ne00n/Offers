{"id": "7601", "post": "<div class=\"post-7601 post type-post status-publish format-standard hentry category-tutorials tag-tutorial tag-tutorials-2\" id=\"post-7601\"><h2 class=\"storytitle\"><a href=\"https://lowendbox.com/blog/server-monitoring-with-icinga-2-part-2-the-node-ubuntu-host/\" rel=\"bookmark\">Server monitoring with Icinga 2 \u2013 Part 2: the node (Ubuntu host)</a></h2><div class=\"meta\"><img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"/media/icons/tag_green.png\" alt=\"Tags: \"> <a href=\"https://lowendbox.com/tag/tutorial/\" rel=\"tag\">tutorial</a>, <a href=\"https://lowendbox.com/tag/tutorials-2/\" rel=\"tag\">tutorials</a> <img data-lazyloaded=\"1\" src=\"data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=\" data-src=\"https://lowendbox.com/media/icons/calendar.png\" alt=\"Date/Time: \"> September 2, 2015 @ 1:00 pm, by Maarten Kossen</div><div class=\"storycontent tablelook\"><p style=\"text-align: center;\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNzEiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCAyNzEgNzAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNjZmQ0ZGIiLz48L3N2Zz4=\" loading=\"lazy\" class=\"alignnone size-full wp-image-3957\" data-src=\"https://lowendbox.com/wp-content/uploads/2013/05/lowendtutorial.png.webp\" alt=\"lowendtutorial\" width=\"271\" height=\"70\"></p><p>It\u2019s been a long, long wait! But it\u2019s finally here, the second part of the Icinga 2 tutorial that I\u2019ve promised a while ago.</p><p>Last time, we set up an Icinga 2 <em>server</em> to which we are now going to add a <em>host</em>. Unlike with Nagios, you can add hosts \u201cautomatically\u201d in Icinga 2 out of the box. That is, you have to do some things, but configuration is quite easy compared to getting started with NRPE. On top of that, it\u2019s a lot more secure: all communication is secured by TLS with certificates, which Icinga 2 can set up for you automatically.</p><p>So, we\u2019re going to add a <em>host</em> to our <em>server</em>. I\u2019m assuming the <em>host</em> is running Ubuntu as well; any recent version will work.</p><p>Let\u2019s get started!</p><p><span id=\"more-7601\"></span></p><h2>The <em>server</em> node</h2><p>In order to be able to add <em>hosts</em> securely, we have to go to the <em>server</em> and run the following command:</p><blockquote><p>sudo icinga2 node wizard</p></blockquote><p>This will start a wizard which will first ask you whether this is a satellite setup or not. Since this is the <em>server</em> or <em>master</em> you have to say \u2018No\u2019 here, to input an \u2018n\u2019:</p><blockquote><p>Please specify if this is a satellite setup (\u2018n\u2019 installs a master setup) [Y/n]: n</p></blockquote><p>It then starts generating keys are certificates required for secured TLS communication. In addition to that, it adds these to the configuration, plus it ensures this server is listed as the master:</p><blockquote><p>information/base: Writing private key to \u2018/var/lib/icinga2/ca/ca.key\u2019.<br>\ninformation/base: Writing X509 certificate to \u2018/var/lib/icinga2/ca/ca.crt\u2019.<br>\ninformation/cli: Initializing serial file in \u2018/var/lib/icinga2/ca/serial.txt\u2019.<br>\ninformation/cli: Generating new CSR in \u2018/etc/icinga2/pki/icinga-server.csr\u2019.<br>\ninformation/base: Writing private key to \u2018/etc/icinga2/pki/icinga-server.key\u2019.<br>\ninformation/base: Writing certificate signing request to \u2018/etc/icinga2/pki/icinga-server.csr\u2019.<br>\ninformation/base: Writing private key to \u2018/etc/icinga2/pki/icinga-server.key\u2019.<br>\ninformation/base: Writing certificate signing request to \u2018/etc/icinga2/pki/icinga-server.csr\u2019.<br>\ninformation/cli: Signing CSR with CA and writing certificate to \u2018/etc/icinga2/pki/icinga-server.crt\u2019.<br>\ninformation/cli: Copying CA certificate to \u2018/etc/icinga2/pki/ca.crt\u2019.<br>\ninformation/cli: Dumping config items to file \u2018/etc/icinga2/zones.conf\u2019.<br>\ninformation/cli: Created backup file \u2018/etc/icinga2/zones.conf.orig\u2019.</p></blockquote><p>It then asks you for the host and port for the API. We have no reason to change these, so leave these empty:</p><blockquote><p>Please specify the API bind host/port (optional):<br>\nBind Host []:<br>\nBind Port []:</p></blockquote><p>It then finalizes setting up this server as a master my editing some more configuration files:</p><blockquote><p>information/cli: Enabling the APIlistener feature.<br>\nEnabling feature api. Make sure to restart Icinga 2 for these changes to take effect.<br>\ninformation/cli: Created backup file \u2018/etc/icinga2/features-available/api.conf.orig\u2019.<br>\ninformation/cli: Updating constants.conf.<br>\ninformation/cli: Created backup file \u2018/etc/icinga2/constants.conf.orig\u2019.<br>\ninformation/cli: Updating constants file \u2018/etc/icinga2/constants.conf\u2019.<br>\ninformation/cli: Updating constants file \u2018/etc/icinga2/constants.conf\u2019.<br>\nDone.</p><p>Now restart your Icinga 2 daemon to finish the installation!</p></blockquote><p>With that done, restart Icinga 2 in order to use the new settings:</p><blockquote><p>sudo service icinga2 restart</p></blockquote><p>And the master is good for now. Let\u2019s move on to the <em>host</em> node!</p><h2>The <em>host</em> node</h2><p>On the <em>host</em> node, we\u2019re first going to have to ensure the Icinga 2 repository is present:</p><blockquote><p>add-apt-repository ppa:formorer/icinga</p></blockquote><p>Press ENTER when it asks you to.</p><p><em>Note:</em> If this command gives you an error, run \u2018sudo apt-get install software-properties-common\u2019 to get the \u2018add-apt-repository\u2019 command!</p><p>Once the repository has been added, update apt:</p><blockquote><p>sudo apt-get update</p></blockquote><p>And install Icinga 2:</p><blockquote><p>sudo apt-get install icinga2</p></blockquote><p>With that out of the way, we can initiate the same wizard as we did on the master:</p><blockquote><p>sudo icinga2 node wizard</p></blockquote><p>This time we answer \u2018Yes\u2019 when it asks us if this is a satellite setup by just hitting ENTER:</p><blockquote><p>Please specify if this is a satellite setup (\u2018n\u2019 installs a master setup) [Y/n]:</p></blockquote><p>After which is starts a different wizard:</p><blockquote><p>Starting the Node setup routine\u2026<br>\nPlease specifiy the common name (CN) [icinga-node]:<br>\nPlease specifiy the local zone name [icinga-node]:</p></blockquote><p>It asks you for the common name and the local zone name for this server. These default to the system\u2019s hostname in fully qualified domain name format. These master uses the common name to connect to the server and the local zone name to identify it in configuration files. I just let these be.</p><p>It then goes on to ask you about your master node:</p><blockquote><p>Please specify the master endpoint(s) this node should connect to:<br>\nMaster Common Name (CN from your master setup): icinga-server<br>\nDo you want to establish a connection to the master from this node? [Y/n]:</p></blockquote><p>Please enter the Common Name of your master node (in my case \u2018icinga-server\u2019). This is usually the hostname unless you\u2019ve changed it. Then press ENTER when asked if you want to establish a connection to the master from this node. This triggers the next question:</p><blockquote><p>Please fill out the master connection information:<br>\nMaster endpoint host (Your master\u2019s IP address or FQDN): icinga-server<br>\nMaster endpoint port [5665]:<br>\nAdd more master endpoints? [y/N]:</p></blockquote><p>Enter the master\u2019s IP address or Fully Qualified Domain Name (FQDN) here and accept the default port. Also press ENTER in order to not add more endpoints: we\u2019re just working with one master right now.</p><p>Then it\u2019s on to the connection for CSR auto-signing, the bit of magic that makes setting up a secure connection a bit easier for you:</p><blockquote><p>Please specify the master connection for CSR auto-signing (defaults to master endpoint host):<br>\nHost [icinga-server]:<br>\nPort [5665]:</p></blockquote><p>Accept the defaults here as well, because the master we have entered before is also our server for CSR auto-signing.</p><p>After this, Icinga 2 is going to save some configuration on the <em>host</em> node and start the setup of a secure connection. As part of this process the master is contacted:</p><blockquote><p>information/base: Writing private key to \u2018/etc/icinga2/pki/icinga-node.key\u2019.<br>\ninformation/base: Writing X509 certificate to \u2018/etc/icinga2/pki/icinga-node.crt\u2019.<br>\ninformation/cli: Generating self-signed certifiate:<br>\ninformation/cli: Fetching public certificate from master (icinga-server, 5665):</p><p>information/cli: Writing trusted certificate to file \u2018/etc/icinga2/pki/trusted-master.crt\u2019.<br>\ninformation/cli: Stored trusted master certificate in \u2018/etc/icinga2/pki/trusted-master.crt\u2019.</p></blockquote><p>The certificate that has been set up needs to be signed in order to prove that you\u2019re actually in command of both servers and approve of this secure communication:</p><blockquote><p>Please specify the request ticket generated on your Icinga 2 master.<br>\n(Hint: # icinga2 pki ticket \u2013cn \u2018icinga-node\u2019):</p></blockquote><p>This means you need to <strong>run the following command on the master</strong>:</p><blockquote><p>sudo icinga2 pki ticket \u2013cn \u2018icinga-node\u2019</p></blockquote><p>And copy the output from that command, which looks like \u2018ff84267fca3b0b29c4c88d94706c76f4247cac34\u2019 to the <em>host</em> node.</p><blockquote><p>information/cli: Processing self-signed certificate request. Ticket \u2018ff84267fca3b0b29c4c88d94706c76f4247cac34\u2019.</p><p>information/cli: Created backup file \u2018/etc/icinga2/pki/icinga-node.crt.orig\u2019.<br>\ninformation/cli: Writing signed certificate to file \u2018/etc/icinga2/pki/icinga-node.crt\u2019.<br>\ninformation/cli: Writing CA certificate to file \u2018/etc/icinga2/pki/ca.crt\u2019.</p></blockquote><p>With all certificates signed and in place, we\u2019re asked about the API again:</p><blockquote><p>Please specify the API bind host/port (optional):<br>\nBind Host []:<br>\nBind Port []:</p></blockquote><p>Just like at the master, we\u2019re not going to touch these here.</p><p>The wizard now asks you whether to accept the configuration and commands from the master:</p><blockquote><p>Accept config from master? [y/N]: y<br>\nAccept commands from master? [y/N]: y</p></blockquote><p>Select \u2018Yes\u2019 for both. Unfortunately, the Icinga 2 documentation is a bit fuzzy on this part. There are several ways to setup up a client, for example with a local configuration or as an execution bridge. I\u2019m aiming for the latter of the two here: the master is in control and sends commands, the <em>host</em> node just executes them and returns the results. This is closest to what NRPE does and should keep all the data on the master.</p><p>With this done, everything is being put in place to make this work:</p><blockquote><p>information/cli: Disabling the Notification feature.<br>\nDisabling feature notification. Make sure to restart Icinga 2 for these changes to take effect.<br>\ninformation/cli: Enabling the Apilistener feature.<br>\nEnabling feature api. Make sure to restart Icinga 2 for these changes to take effect.<br>\ninformation/cli: Created backup file \u2018/etc/icinga2/features-available/api.conf.orig\u2019.<br>\ninformation/cli: Generating local zones.conf.<br>\ninformation/cli: Dumping config items to file \u2018/etc/icinga2/zones.conf\u2019.<br>\ninformation/cli: Created backup file \u2018/etc/icinga2/zones.conf.orig\u2019.<br>\ninformation/cli: Updating constants.conf.<br>\ninformation/cli: Created backup file \u2018/etc/icinga2/constants.conf.orig\u2019.<br>\ninformation/cli: Updating constants file \u2018/etc/icinga2/constants.conf\u2019.<br>\ninformation/cli: Updating constants file \u2018/etc/icinga2/constants.conf\u2019.<br>\nDone.</p><p>Now restart your Icinga 2 daemon to finish the installation!</p></blockquote><p>After which you need to restart Icinga 2 on the <em>host</em> node:</p><blockquote><p>sudo service icinga2 restart</p></blockquote><p>And it\u2019s back to the master.</p><h2>Back to the <em>server</em> node (the master)</h2><p>With the <em>host</em> node set up properly, only a few things remain on the master to be set up. First of all, we want to list the nodes on the master to see if our new <em>host</em> node is in there:</p><blockquote><p>sudo icinga2 node list</p></blockquote><p>The output should include the node you\u2019ve just added.</p><p>Then, we update the configuration on the master so the <em>host</em> node is being included in checks, or in other words is being added to the master:</p><blockquote><p>sudo icinga2 node update-config</p></blockquote><p>The only thing that remains right now is to reload Icinga 2:</p><blockquote><p>sudo service icinga2 reload</p></blockquote><p>And we\u2019re done! After a few minutes results should start popping up in the web interface!</p><p class=\"dpsp-share-text\"></p><div id=\"dpsp-content-bottom\" class=\"dpsp-content-wrapper dpsp-shape-rounded dpsp-column-auto dpsp-has-spacing dpsp-no-labels dpsp-show-on-mobile dpsp-button-style-1 dpsp-has-icon-background dpsp-has-button-background dpsp-show-total-share-count dpsp-show-total-share-count-after\"><ul class=\"dpsp-networks-btns-wrapper dpsp-networks-btns-content dpsp-has-button-icon-animation\"><li><a rel=\"nofollow\" href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Flowendbox.com%2Fblog%2Fserver-monitoring-with-icinga-2-part-2-the-node-ubuntu-host%2F&amp;t=Server%20monitoring%20with%20Icinga%202%20-%20Part%202%3A%20the%20node%20%28Ubuntu%20host%29\" class=\"dpsp-network-btn dpsp-facebook dpsp-no-label dpsp-first\" title=\"Share on Facebook\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://twitter.com/intent/tweet?text=Server%20monitoring%20with%20Icinga%202%20-%20Part%202%3A%20the%20node%20%28Ubuntu%20host%29&amp;url=https%3A%2F%2Flowendbox.com%2Fblog%2Fserver-monitoring-with-icinga-2-part-2-the-node-ubuntu-host%2F&amp;via=LowEndNetwork\" class=\"dpsp-network-btn dpsp-twitter dpsp-no-label\" title=\"Share on Twitter\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li><li><a rel=\"nofollow\" href=\"https://www.linkedin.com/shareArticle?url=https%3A%2F%2Flowendbox.com%2Fblog%2Fserver-monitoring-with-icinga-2-part-2-the-node-ubuntu-host%2F&amp;title=Server%20monitoring%20with%20Icinga%202%20-%20Part%202%3A%20the%20node%20%28Ubuntu%20host%29&amp;mini=true\" class=\"dpsp-network-btn dpsp-linkedin dpsp-no-label dpsp-last\" title=\"Share on LinkedIn\"><span class=\"dpsp-network-icon\"></span><span class=\"dpsp-network-label-wrapper\"></span></a></li></ul><div class=\"dpsp-total-share-wrapper\"><span class=\"dpsp-icon-total-share\"></span><span class=\"dpsp-total-share-count\">1</span><span>shares</span></div></div><div class=\"relpost-thumb-wrapper\"><div class=\"relpost-thumb-container\"><h3>Related posts:</h3><div style=\"clear: both\"></div><div style=\"clear: both\"></div><div class=\"relpost-block-container\"><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/managing-your-lowendempire-with-ansible-part-1/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Managing Your LowEndEmpire With Ansible, Part 1\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Managing Your LowEndEmpire With Ansible, Part 1</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/setup-a-dns-nameserver-using-nsd/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Setup a DNS Nameserver Using NSD\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/03/leb-banner-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Setup a DNS Nameserver Using NSD</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/keeping-a-logwatchful-eye-on-your-vps-with-logwatch/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Keeping A (log)Watchful Eye on Your VPS With logwatch\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/logwatch-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Keeping A (log)Watchful Eye on Your VPS With logwatch</div></div></a><a class=\"relpost-block-single\" href=\"https://lowendbox.com/blog/nginx-vs-openlitespeed-vs-apache/\"><div style=\"width: 150px; height: 215px;\"><div class=\"relpost-block-single-image\" alt=\"Nginx vs. OpenLiteSpeed vs. Apache\" style=\"background: transparent url(https://lowendbox.com/wp-content/uploads/2020/04/nginx-vs-openlitespeed-vs-apache-150x150.png) no-repeat scroll 0% 0%; width: 150px; height: 150px;\"></div><div class=\"relpost-block-single-text\" style=\"font-family: Arial;  font-size: 12px;  color: #333333;\">Nginx vs. OpenLiteSpeed vs. Apache</div></div></a></div><div style=\"clear: both\"></div></div></div><div id=\"author-bio-box\" style=\"background: #f8f8f8; border-top: 2px solid #cccccc; border-bottom: 2px solid #cccccc; color: #333333\"><h3><a style=\"color: #555555;\" href=\"https://lowendbox.com/blog/author/mpkossen/\" title=\"All posts by Maarten Kossen\" rel=\"author\">Maarten Kossen</a></h3><div class=\"bio-gravatar\"><img data-lazyloaded=\"1\" src=\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2ZkNGRiIi8+PC9zdmc+\" alt=\"\" data-src=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=70&amp;d=retro&amp;r=pg\" data-srcset=\"https://secure.gravatar.com/avatar/67eeccea1ee5a1ce2f93adc061f69a5f?s=140&amp;d=retro&amp;r=pg 2x\" class=\"avatar avatar-70 photo\" height=\"70\" width=\"70\" loading=\"lazy\"></div><p class=\"bio-description\">Maarten Kossen was the administrator of LowEndBox from 2013 to 2015, and brought many ideas and improvements to the website during his leadership. Today he is member of our community and LowEndTalk.</p></div></div><div class=\"feedback\"></div></div>"}